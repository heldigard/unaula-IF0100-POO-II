<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clase 11 - Formularios, Validación y Sesiones | IF0100 POO II</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .meta-bar {
            background: #1e3a8a;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .meta-bar span { font-size: 0.9rem; }
        .nav {
            background: #1e3a8a;
            padding: 0.5rem 2rem;
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background 0.3s;
        }
        .nav a:hover { background: rgba(255,255,255,0.2); }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #1e40af;
            border-bottom: 3px solid #3b82f6;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .section h3 {
            color: #3b82f6;
            margin: 1.5rem 0 1rem;
        }
        .section h4 {
            color: #1e3a8a;
            margin: 1rem 0 0.5rem;
        }
        .objectives-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        .objectives-table th, .objectives-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .objectives-table th { background: #f3f4f6; }
        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        code {
            background: #e5e7eb;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: "Fira Code", "Consolas", monospace;
            font-size: 0.9em;
        }
        pre code { background: none; padding: 0; }
        /* Syntax highlighting para Python */
        .token-keyword { color: #c792ea; font-weight: 600; }
        .token-type { color: #ffcb6b; }
        .token-string { color: #c3e88d; }
        .token-comment { color: #546e7a; font-style: italic; }
        .token-number { color: #f78c6c; }
        .token-operator { color: #89ddff; }
        /* Accessibility */
        abbr[title] { text-decoration: underline dotted; cursor: help; }
        .example-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        .note {
            background: #f0f4ff;
            border-left: 4px solid #3b82f6;
            padding: 10px 12px;
            border-radius: 8px;
            color: #52606d;
        }
        .figure-container {
            text-align: center;
            margin: 2rem 0;
        }
        .figure-container img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .figure-container figcaption {
            margin-top: 0.5rem;
            font-style: italic;
            color: #6b7280;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }
        .comparison .bad {
            background: #fef2f2;
            border: 1px solid #fca5a5;
            padding: 1rem;
            border-radius: 4px;
        }
        .comparison .good {
            background: #f0fdf4;
            border: 1px solid #86efac;
            padding: 1rem;
            border-radius: 4px;
        }
        .comparison-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .badge-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-purple { background: #f3e8ff; color: #7c3aed; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .tag-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .tag-table th {
            background: #1e40af;
            color: white;
            padding: 0.75rem;
            text-align: left;
        }
        .tag-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        ul, ol { margin-left: 1.5rem; }
        li { margin: 0.5rem 0; }
        .footer {
            background: #1e3a8a;
            color: white;
            text-align: center;
            padding: 2rem;
            margin-top: 2rem;
        }
        .note-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .note-box strong { color: #92400e; }
        .warning-box {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .warning-box strong { color: #991b1b; }
        /* Print styles */
        @media print {
            header, nav, footer { background: white !important; color: black !important; }
            a[href]:after { content: " (" attr(href) ")"; font-size: 0.8em; }
            pre, code { white-space: pre-wrap; }
        }
        @media (max-width: 768px) {
            .comparison { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.8rem; }
            .meta-bar { flex-direction: column; text-align: center; }
        }

        /* BLOQUES DE CÓDIGO MEJORADOS */
        .code-block {
            background: #1e1e2e;
            border-radius: 12px;
            margin: 16px 0;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 1px solid #313244;
        }

        .code-header {
            background: linear-gradient(90deg, #313244 0%, #45475a 100%);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #45475a;
        }

        .code-dots {
            display: flex;
            gap: 6px;
        }

        .code-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .code-dot.red { background: #f38ba8; }
        .code-dot.yellow { background: #f9e2af; }
        .code-dot.green { background: #a6e3a1; }

        .code-title {
            color: #cdd6f4;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: auto;
            font-family: 'Cascadia Code', Consolas, monospace;
        }

        .code-content {
            display: flex;
            background: #1e1e2e;
        }

        .line-numbers {
            background: #181825;
            color: #6c7086;
            padding: 12px 10px;
            text-align: right;
            font-family: 'Cascadia Code', Consolas, monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            user-select: none;
            border-right: 1px solid #313244;
        }

        .code-block pre {
            background: transparent;
            margin: 0;
            padding: 12px 16px;
            flex: 1;
            overflow-x: auto;
        }

        .code-block pre code {
            color: #cdd6f4;
            font-size: 0.95rem;
            line-height: 1.5;
            display: block;
        }

        /* Syntax highlighting mejorado - Catppuccin Mocha theme */
        .code-block .token-keyword { color: #cba6f7; font-weight: 600; } /* purple */
        .code-block .token-type { color: #f9e2af; } /* yellow */
        .code-block .token-string { color: #a6e3a1; } /* green */
        .code-block .token-comment { color: #6c7086; font-style: italic; } /* gray */
        .code-block .token-number { color: #fab387; } /* peach */
        .code-block .token-operator { color: #89dceb; } /* cyan */
        .code-block .token-method { color: #89b4fa; } /* blue */
        .code-block .token-class { color: #f9e2af; font-weight: 600; }
        .code-block .token-property { color: #b4befe; } /* lavender */
        .code-block .token-namespace { color: #f38ba8; } /* pink */

        /* Código inline */
        p code, li code {
            background: #313244;
            color: #cdd6f4;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.9em;
            border: 1px solid #45475a;
        }

        /* Tablas de código */
        .code-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin: 16px 0;
        }

        .code-comparison .code-block {
            margin: 0;
        }

        .code-label {
            font-size: 0.8rem;
            color: #6c7086;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #1e3a8a;
            color: #fff;
            padding: 8px 16px;
            text-decoration: none;
            z-index: 100;
            transition: top 0.3s;
        }
        .skip-link:focus {
            top: 0;
        }
    </style>
</head>
<body>
    <a href="#main" class="skip-link">Saltar al contenido</a>
    <header class="header">
        <h1>Clase 11 - Formularios, Validación y Sesiones</h1>
        <p>IF0100 - Lenguaje de Programación Orientada a Objetos II | Unidad 3 - Desarrollo Web</p>
    </header>

    <div class="meta-bar">
        <span> Duración: 90 minutos</span>
        <span> Unidad 3 - Desarrollo Web</span>
        <span> 4 Semestre - Ingeniería Informática</span>
    </div>

    <nav class="nav">
        <a href="#teoria">Teoría</a>
        <a href="#ejemplos">Ejemplos</a>
        <a href="#practica">Práctica / Laboratorio</a>
        <a href="#ejercicios">Ejercicios</a>
        <a href="#referencias">Referencias</a>
    </nav>

    <main class="container" id="main">
        <!-- Teoría -->
        <section id="teoria">
        <!-- Objetivos -->
        <section id="objetivos" class="section">
            <h2>Objetivos de la Clase</h2>
            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Objetivo</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td><strong>Implementar</strong> validación de datos con Pydantic</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td><strong>Configurar</strong> validación en cliente y servidor</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td><strong>Utilizar</strong> MessageService, Inputs y Query Params</td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td><strong>Gestionar</strong> sesiones y cookies</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td><strong>Implementar</strong> upload de archivos</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Agenda -->
        <section id="agenda" class="section">
            <h2>Agenda (90 min)</h2>
            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>Tiempo</th>
                        <th>Tema</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>20'</td>
                        <td>Validación con Pydantic</td>
                    </tr>
                    <tr>
                        <td>10'</td>
                        <td>Validación cliente vs servidor</td>
                    </tr>
                    <tr>
                        <td>10'</td>
                        <td>MessageService y mensajes flash</td>
                    </tr>
                    <tr>
                        <td>15'</td>
                        <td>Sesiones y Cookies</td>
                    </tr>
                    <tr>
                        <td>15'</td>
                        <td>Upload de archivos</td>
                    </tr>
                    <tr>
                        <td>20'</td>
                        <td>Ejercicio integrador</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Pydantic -->
        <section id="data-annotations" class="section">
            <h2>1. Validación con Pydantic</h2>

            <div class="note-box">
                <strong>¿Por qué Pydantic?</strong>
                <ul>
                    <li><strong>Declarativo:</strong> Las reglas de validación están en el modelo, no dispersas en el código</li>
                    <li><strong>Reusable:</strong> Mismas reglas para validación cliente y servidor</li>
                    <li><strong>Mantenible:</strong> Un solo lugar para cambiar reglas de negocio</li>
                    <li><strong>Estándar:</strong> <abbr title="Pydantic - Sistema de atributos de validación declarativa en Python">Pydantic</abbr> es parte de Python desde versión 3.5</li>
                </ul>
            </div>

            <h3>Atributos de validación en Python</h3>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">estudiante_model.py</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56</div>
                    <pre><code><span class="token-keyword">from</span> pydantic <span class="token-keyword">import</span> BaseModel, Field, field_validator, EmailStr
<span class="token-keyword">from</span> typing <span class="token-keyword">import</span> Optional
<span class="token-keyword">from</span> datetime <span class="token-keyword">import</span> date, datetime

<span class="token-keyword">class</span> <span class="token-class">EstudianteViewModel</span>(BaseModel):
    <span class="token-comment"># VALIDACIÓN BÁSICA</span>
    codigo: <span class="token-keyword">str</span> = Field(..., min_length=<span class="token-number">5</span>, max_length=<span class="token-number">10</span>,
                          description=<span class="token-string">"Código Estudiantil"</span>)
    nombre: <span class="token-keyword">str</span> = Field(..., min_length=<span class="token-number">1</span>, max_length=<span class="token-number">50</span>)
    apellido: <span class="token-keyword">str</span> = Field(..., min_length=<span class="token-number">1</span>, max_length=<span class="token-number">50</span>)

    <span class="token-comment"># VALIDACIÓN DE EMAIL</span>
    email: EmailStr

    <span class="token-comment"># VALIDACIÓN NUMÉRICA</span>
    edad: <span class="token-keyword">int</span> = Field(..., ge=<span class="token-number">18</span>, le=<span class="token-number">100</span>)
    promedio: <span class="token-keyword">float</span> = Field(..., ge=<span class="token-number">0.0</span>, le=<span class="token-number">5.0</span>)

    <span class="token-comment"># VALIDACIÓN DE PATRÓN (Regex)</span>
    telefono: <span class="token-keyword">str</span> = Field(..., pattern=<span class="token-string">r"^\d{10}$"</span>)

    <span class="token-comment"># VALIDACIÓN DE FECHAS</span>
    fecha_nacimiento: <span class="token-type">date</span>

    <span class="token-comment"># COMPARACIÓN</span>
    password: <span class="token-keyword">str</span> = Field(..., min_length=<span class="token-number">8</span>)
    confirmar_password: <span class="token-keyword">str</span>

    <span class="token-attribute">@field_validator</span>(<span class="token-string">'confirmar_password'</span>)
    <span class="token-keyword">def</span> <span class="token-function">passwords_match</span>(cls, v, info):
        <span class="token-keyword">if</span> <span class="token-string">'password'</span> <span class="token-keyword">in</span> info.data <span class="token-keyword">and</span> v != info.data[<span class="token-string">'password'</span>]:
            <span class="token-keyword">raise</span> <span class="token-exception">ValueError</span>(<span class="token-string">'Las contraseñas no coinciden'</span>)
        <span class="token-keyword">return</span> v

    <span class="token-attribute">@field_validator</span>(<span class="token-string">'fecha_nacimiento'</span>)
    <span class="token-keyword">def</span> <span class="token-function">fecha_debe_ser_pasado</span>(cls, v):
        <span class="token-keyword">if</span> v >= date.today():
            <span class="token-keyword">raise</span> <span class="token-exception">ValueError</span>(<span class="token-string">'La fecha debe ser en el pasado'</span>)
        <span class="token-keyword">return</span> v

    <span class="token-attribute">@field_validator</span>(<span class="token-string">'edad'</span>)
    <span class="token-keyword">def</span> <span class="token-function">validar_mayoria_edad</span>(cls, v):
        <span class="token-keyword">if</span> v < <span class="token-number">18</span>:
            <span class="token-keyword">raise</span> <span class="token-exception">ValueError</span>(<span class="token-string">'Debe ser mayor de edad (18 años)'</span>)
        <span class="token-keyword">return</span> v

    <span class="token-keyword">class</span> <span class="token-class">Config</span>:
        <span class="token-string">str</span> = <span class="token-string">"min length = 5 characters"</span>
        <span class="token-string">str</span> = <span class="token-string">"max length = 50 characters"</span></code></pre>
                </div>
            </div>

            <h3>Pydantic Disponibles</h3>
            <table class="tag-table">
                <thead>
                    <tr>
                        <th>Categoría</th>
                        <th>Atributo</th>
                        <th>Descripción</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Requerimiento</td>
                        <td><code>[Required]</code></td>
                        <td>Campo obligatorio</td>
                    </tr>
                    <tr>
                        <td>Longitud</td>
                        <td><code>[StringLength(50)]</code></td>
                        <td>Máximo 50 caracteres</td>
                    </tr>
                    <tr>
                        <td>Longitud</td>
                        <td><code>[MinLength(5)]</code></td>
                        <td>Mínimo 5 caracteres</td>
                    </tr>
                    <tr>
                        <td>Numérica</td>
                        <td><code>[Range(0, 100)]</code></td>
                        <td>Entre 0 y 100</td>
                    </tr>
                    <tr>
                        <td>Formato</td>
                        <td><code>[EmailAddress]</code></td>
                        <td>Formato email</td>
                    </tr>
                    <tr>
                        <td>Formato</td>
                        <td><code>[Phone]</code></td>
                        <td>Formato teléfono</td>
                    </tr>
                    <tr>
                        <td>Formato</td>
                        <td><code>[Url]</code></td>
                        <td>Formato URL</td>
                    </tr>
                    <tr>
                        <td>Formato</td>
                        <td><code>[RegularExpression(@"...")]</code></td>
                        <td>Patrón regex personalizado</td>
                    </tr>
                    <tr>
                        <td>Comparación</td>
                        <td><code>[Compare("OtraPropiedad")]</code></td>
                        <td>Debe coincidir con otra propiedad</td>
                    </tr>
                </tbody>
            </table>

            <h3>Validación Personalizada</h3>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">validacion_personalizada.py</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53</div>
                    <pre><code><span class="token-comment"># Validación personalizada incluida en el modelo anterior</span>
<span class="token-comment">@field_validator('fecha_nacimiento')</span>
<span class="token-keyword">def</span> <span class="token-function">fecha_debe_ser_pasado</span>(cls, v):
    <span class="token-keyword">if</span> v >= date.today():
        <span class="token-keyword">raise</span> <span class="token-exception">ValueError</span>(<span class="token-string">'La fecha debe ser en el pasado'</span>)
    <span class="token-keyword">return</span> v

<span class="token-comment"># Validación de mayoría de edad incluida en el modelo anterior</span>
<span class="token-attribute">@field_validator</span>(<span class="token-string">'edad'</span>)
<span class="token-keyword">def</span> <span class="token-function">validar_mayoria_edad</span>(cls, v):
    <span class="token-keyword">if</span> v < <span class="token-number">18</span>:
        <span class="token-keyword">raise</span> <span class="token-exception">ValueError</span>(<span class="token-string">'Debe tener al menos 18 años'</span>)
    <span class="token-keyword">return</span> v

<span class="token-comment"># Uso del modelo</span>
<span class="token-keyword">from</span> pydantic <span class="token-keyword">import</span> ValidationError

<span class="token-keyword">try</span>:
    estudiante = EstudianteViewModel(
        codigo=<span class="token-string">"A001"</span>,
        nombre=<span class="token-string">"Juan"</span>,
        apellido=<span class="token-string">"Pérez"</span>,
        email=<span class="token-string">"juan.perez@example.com"</span>,
        edad=<span class="token-number">20</span>,
        promedio=<span class="token-number">4.5</span>,
        telefono=<span class="token-string">"3001234567"</span>,
        fecha_nacimiento=date(<span class="token-number">2000</span>, <span class="token-number">5</span>, <span class="token-number">15</span>),
        password=<span class="token-string">"SecurePass123"</span>,
        confirmar_password=<span class="token-string">"SecurePass123"</span>
    )
<span class="token-keyword">except</span> ValidationError <span class="token-keyword">as</span> e:
    <span class="token-keyword">print</span>(e)</code></pre>
                </div>
            </div>

            <h3>Pydantic y FastAPI para Validación de Formularios</h3>
            <p><strong>Pydantic BaseModel</strong> = Clase diseñada específicamente para validación de datos con type hints. En FastAPI, los modelos Pydantic validan automáticamente los datos de entrada.</p>
            <p><strong>Validación Automática</strong> = FastAPI valida los requests automáticamente contra el modelo Pydantic y retorna errores 422 si la validación falla.</p>

            <div class="warning-box">
                <strong>Errores Comunes con Pydantic</strong>
                <ul>
                    <li><strong>No usar field_validator correctamente:</strong> Olvidar validar el tipo de dato o retornar el valor</li>
                    <li><strong>No manejar ValidationError:</strong> Las excepciones de validación deben propagarse correctamente</li>
                    <li><strong>Validar solo en cliente:</strong> Un usuario puede enviar requests directos sin validación en frontend</li>
                </ul>
            </div>

            <h4>Validación en el Controller</h4>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">estudiantes_routes.py</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24</div>
                    <pre><code><span class="token-keyword">from</span> fastapi <span class="token-keyword">import</span> FastAPI, HTTPException
<span class="token-keyword">from</span> pydantic <span class="token-keyword">import</span> BaseModel

app = FastAPI()

<span class="token-attribute">@app.post</span>(<span class="token-string">"/api/estudiantes"</span>, status_code=<span class="token-number">201</span>)
<span class="token-keyword">async def</span> <span class="token-function">crear_estudiante</span>(
    model: EstudianteViewModel,
    estudiante_service: EstudianteService
):
    <span class="token-comment"># Validación automática basada en Pydantic</span>
    <span class="token-comment"># Si hay errores, FastAPI retorna automáticamente 422</span>

    <span class="token-comment"># Validación de negocio adicional</span>
    existe = <span class="token-keyword">await</span> estudiante_service.existe_codigo(model.codigo)
    <span class="token-keyword">if</span> existe:
        <span class="token-keyword">raise</span> HTTPException(
            status_code=<span class="token-number">400</span>,
            detail=<span class="token-string">"Ya existe un estudiante con este código"</span>
        )

    <span class="token-comment"># Guardar</span>
    <span class="token-keyword">await</span> estudiante_service.crear(model)
    <span class="token-keyword">return</span> {<span class="token-string">"mensaje"</span>: <span class="token-string">"Estudiante creado exitosamente"</span>}</code></pre>
                </div>
            </div>
        </section>

        <!-- Validacion Cliente/Servidor -->
        <section id="validacion" class="section">
            <h2>2. Validación Cliente vs Servidor</h2>

            <div class="note-box">
                <strong>¿Por qué Doble Validación?</strong>
                <ul>
                    <li><strong>Experiencia de usuario:</strong> La validación cliente (<abbr title="JavaScript - Lenguaje de programación para interactividad web">JS</abbr>) es instantánea, sin recargar la página</li>
                    <li><strong>Seguridad:</strong> La validación servidor es obligatoria porque JS puede ser desactivado o manipulado</li>
                    <li><strong>Defensa en profundidad:</strong> Dos capas de validación reducen errores y ataques</li>
                </ul>
            </div>

            <h3>Doble validación</h3>
            <div class="note-box">
                <strong>IMPORTANTE:</strong>
                <ul>
                    <li><strong>Validación cliente</strong> = UX mejor (rápida, feedback inmediato)</li>
                    <li><strong>Validación servidor</strong> = Seguridad (obligatoria)</li>
                    <li><strong>Nunca confíe solo en validación cliente</strong> - Puede ser omitida</li>
                </ul>
            </div>

            <h4>Flujo de Validación:</h4>
            <ol>
                <li>Usuario escribe datos en formulario</li>
                <li>JavaScript valida (jQuery Validation) en navegador</li>
                <li>Si es inválido, muestra error <strong>sin enviar al servidor</strong></li>
                <li>Si pasa validación cliente, envía POST</li>
                <li>Servidor valida automáticamente con Pydantic (retorna 422 si falla)</li>
                <li>Si inválido, retorna vista con errores</li>
                <li>Si válido, procesa y guarda</li>
            </ol>

            <h3>jQuery Validation</h3>
            <p><strong><abbr title="jQuery Validation - Plugin de JavaScript para validación de formularios en el cliente">jQuery Validation</abbr></strong> = Plugin que lee los atributos data-val-* generados por FastAPI y valida automáticamente en el navegador.</p>

            <div class="warning-box">
                <strong>Errores Comunes en Validación Cliente</strong>
                <ul>
                    <li><strong>Olvidar incluir los scripts:</strong> La validación cliente simplemente no funciona</li>
                    <li><strong>No renderizar Partial de Scripts:</strong> Olvidar <code>@{await Html.RenderPartialAsync("_ValidationScriptsPartial");}</code></li>
                    <li><strong>Conflictos de jQuery:</strong> Incluir jQuery dos veces o versiones incompatibles</li>
                </ul>
            </div>

            <h4>Configuración en la vista</h4>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">estudiante-form.component.ts</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35</div>
                    <pre><code><span class="token-keyword">import</span> { Component } <span class="token-keyword">from</span> <span class="token-string">'@angular/core'</span>;
<span class="token-keyword">import</span> { FormBuilder, FormGroup, Validators } <span class="token-keyword">from</span> <span class="token-string">'@angular/forms'</span>;
<span class="token-keyword">import</span> { Router } <span class="token-keyword">from</span> <span class="token-string">'@angular/router'</span>;
<span class="token-keyword">import</span> { EstudianteService } <span class="token-keyword">from</span> <span class="token-string">'../services/estudiante.service'</span>;

@Component({
  selector: <span class="token-string">'app-estudiante-form'</span>,
  templateUrl: <span class="token-string">'./estudiante-form.component.html'</span>
})
<span class="token-keyword">export class</span> EstudianteFormComponent {
  form: FormGroup;
  errores: string[] = [];

  <span class="token-keyword">constructor</span>(
    <span class="token-keyword">private</span> fb: FormBuilder,
    <span class="token-keyword">private</span> service: EstudianteService,
    <span class="token-keyword">private</span> router: Router
  ) {
    <span class="token-keyword">this</span>.form = <span class="token-keyword">this</span>.fb.group({
      email: [<span class="token-string">''</span>, [Validators.required, Validators.email]],
      nombre: [<span class="token-string">''</span>, Validators.required],
      apellido: [<span class="token-string">''</span>, Validators.required]
    });
  }

  onSubmit(): <span class="token-keyword">void</span> {
    <span class="token-keyword">if</span> (<span class="token-keyword">this</span>.form.invalid) {
      <span class="token-keyword">this</span>.form.markAllAsTouched();
      <span class="token-keyword">return</span>;
    }

    <span class="token-keyword">this</span>.service.crear(<span class="token-keyword">this</span>.form.value).subscribe({
      next: () => <span class="token-keyword">this</span>.router.navigate([<span class="token-string">'/estudiantes'</span>], {
        queryParams: { mensaje: <span class="token-string">'Creado exitosamente'</span> }
      }),
      error: (err) => <span class="token-keyword">this</span>.errores = err.error.detail
    });
  }
}</code></pre>
                </div>
            </div>
        </section>

        <!-- Flash Messages / State Management -->
        <section id="flash-messages" class="section">
            <h2>3. Mensajes Flash y Gestión de Estado</h2>

            <div class="note-box">
                <strong>¿Por qué mensajes flash?</strong>
                <ul>
                    <li><strong>Mensajes flash:</strong> Mostrar "Guardado exitosamente" después de un redirect</li>
                    <li><strong>Preservar input:</strong> Mantener datos del formulario cuando hay errores</li>
                    <li><strong>PRG Pattern:</strong> Evita reenvíos accidentales al recargar la página (Post-Redirect-Get)</li>
                </ul>
            </div>

            <h3>Diferencias clave</h3>
            <p><strong><abbr title="Component Input - Datos pasados de un componente padre a un componente hijo en Angular">Component Input</abbr></strong> = Propiedades @Input para pasar datos de componente padre a hijo.</p>
            <p><strong><abbr title="Query Params - Parámetros en la URL para pasar datos entre navegaciones">Query Params</abbr></strong> = Parámetros en la URL que persisten durante navegación (útil para mensajes flash).</p>
            <p><strong><abbr title="Service State - Estado gestionado por un servicio compartido entre componentes">Service State</abbr></strong> = Estado gestionado por un servicio RxJS/BehaviorSubject para comunicación entre componentes.</p>

            <h4>Formas de pasar datos en Angular + FastAPI</h4>
            <table class="tag-table">
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Alcance</th>
                        <th>Uso</th>
                        <th>Ejemplo</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Component Input</td>
                        <td>Una sola petición</td>
                        <td>Padre  Hijo</td>
                        <td><code>@Input() mensaje: string;</code></td>
                    </tr>
                    <tr>
                        <td>Query Params</td>
                        <td>Hasta siguiente navegación</td>
                        <td>Componente  Router  Componente</td>
                        <td><code>router.navigate(['/', {msg: 'Guardado'}])</code></td>
                    </tr>
                    <tr>
                        <td>Service/BehaviorSubject</td>
                        <td>Múltiples componentes/suscriptores</td>
                        <td>Estado compartido entre componentes</td>
                        <td><code>messageService.next('Hola')</code></td>
                    </tr>
                </tbody>
            </table>

            <h3>Mensajes Flash en Acción</h3>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">message.service.ts</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36</div>
                    <pre><code><span class="token-keyword">import</span> { Injectable } <span class="token-keyword">from</span> <span class="token-string">'@angular/core'</span>;
<span class="token-keyword">import</span> { BehaviorSubject } <span class="token-keyword">from</span> <span class="token-string">'rxjs'</span>;

<span class="token-keyword">interface</span> FlashMessage {
  texto: string;
  tipo: <span class="token-string">'success'</span> | <span class="token-string">'error'</span> | <span class="token-string">'info'</span>;
}

@Injectable({ providedIn: <span class="token-string">'root'</span> })
<span class="token-keyword">export class</span> MessageService {
  <span class="token-keyword">private</span> message$ = <span class="token-keyword">new</span> BehaviorSubject&lt;FlashMessage | <span class="token-keyword">null</span>&gt;(<span class="token-keyword">null</span>);

  <span class="token-function">setMessage</span>(texto: string, tipo: <span class="token-string">'success'</span> | <span class="token-string">'error'</span> = <span class="token-string">'success'</span>): <span class="token-keyword">void</span> {
    <span class="token-keyword">this</span>.message$.next({ texto, tipo });
  }

  <span class="token-function">getMessage</span>() {
    <span class="token-keyword">return</span> <span class="token-keyword">this</span>.message$.asObservable();
  }

  <span class="token-function">clear</span>(): <span class="token-keyword">void</span> {
    <span class="token-keyword">this</span>.message$.next(<span class="token-keyword">null</span>);
  }
}

<span class="token-comment">// Uso en el componente de creación</span>
<span class="token-keyword">async</span> <span class="token-function">crear</span>(model: EstudianteViewModel): <span class="token-keyword">Promise</span>&lt;<span class="token-keyword">void</span>&gt; {
  <span class="token-keyword">try</span> {
    <span class="token-keyword">await</span> <span class="token-keyword">this</span>.service.crear(model);
    <span class="token-keyword">this</span>.messageService.setMessage(<span class="token-string">'Estudiante creado exitosamente'</span>, <span class="token-string">'success'</span>);
    <span class="token-keyword">this</span>.router.navigate([<span class="token-string">'/estudiantes'</span>]);
  } <span class="token-keyword">catch</span> (err) {
    <span class="token-keyword">this</span>.messageService.setMessage(<span class="token-string">'Error al crear estudiante'</span>, <span class="token-string">'error'</span>);
  }
}

<span class="token-comment">// Uso en el componente de eliminación</span>
<span class="token-keyword">async</span> <span class="token-function">eliminar</span>(id: <span class="token-keyword">number</span>): <span class="token-keyword">Promise</span>&lt;<span class="token-keyword">void</span>&gt; {
  <span class="token-keyword">try</span> {
    <span class="token-keyword">await</span> <span class="token-keyword">this</span>.service.eliminar(id);
    <span class="token-keyword">this</span>.messageService.setMessage(<span class="token-string">'Estudiante eliminado correctamente'</span>, <span class="token-string">'success'</span>);
  } <span class="token-keyword">catch</span> {
    <span class="token-keyword">this</span>.messageService.setMessage(<span class="token-string">'No se pudo eliminar el estudiante'</span>, <span class="token-string">'error'</span>);
  }
}</code></pre>
                </div>
            </div>

            <h3>Mostrar Mensajes en el Componente</h3>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">app.component.html</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23</div>
                    <pre><code>&lt;!-- Componente raíz para mostrar mensajes flash --&gt;
&lt;div *ngIf="message$ | async as message" class="alert-container"&gt;
  &lt;div [class]="'alert alert-' + message.tipo + ' alert-dismissible fade show'"
       role="alert"&gt;
    {{ message.texto }}
    &lt;button type="button"
            class="btn-close"
            (click)="messageService.clear()"&gt;
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;router-outlet&gt;&lt;/router-outlet&gt;

&lt;!-- O usando un componente dedicado --&gt;
&lt;app-flash-message&gt;&lt;/app-flash-message&gt;</code></pre>
                </div>
            </div>
        </section>

        <!-- Sesiones y Cookies -->
        <section id="sesiones" class="section">
            <h2>4. Sesiones y Cookies</h2>

            <div class="note-box">
                <strong>¿Por qué Sesiones vs Cookies?</strong>
                <ul>
                    <li><strong>Session:</strong> Datos almacenados en servidor (seguro, pero consume memoria)</li>
                    <li><strong>Cookie:</strong> Datos almacenados en navegador del cliente (limitado, pero no consume servidor)</li>
                    <li><strong>Combinación:</strong> Session ID en cookie + datos en sesión = estándar de autenticación web</li>
                </ul>
            </div>

            <h3>Diferencias clave</h3>
            <p><strong><abbr title="Session - Almacenamiento de datos en servidor asociado a un usuario mediante un ID de sesión">Sesión</abbr></strong> = Datos almacenados en el servidor, identificados por un cookie de sesión.</p>
            <p><strong><abbr title="Cookie - Pequeño archivo de texto almacenado en el navegador del usuario">Cookie</abbr></strong> = Datos almacenados en el navegador del cliente, enviados en cada petición.</p>

            <h4>Configuración de sesiones</h4>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">Program.cs</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16</div>
                    <pre><code><span class="token-comment">// Program.cs - Configurar servicio de sesiones</span>

<span class="token-comment">// Agregar servicio de sesiones</span>
builder.Services.AddDistributedMemoryCache();  <span class="token-comment">// Almacenamiento en memoria</span>
builder.Services.AddSession(options =&amp;gt;
{
    options.IdleTimeout = TimeSpan.FromMinutes(30);  <span class="token-comment">// Tiempo de expiración</span>
    options.Cookie.HttpOnly = true;  <span class="token-comment">// Solo accesible por HTTP</span>
    options.Cookie.IsEssential = true;  <span class="token-comment">// Necesaria para GDPR</span>
});

var app = builder.Build();

<span class="token-comment">// Usar sesiones (antes de MapControllers)</span>
app.UseSession();
app.MapControllers();</code></pre>
                </div>
            </div>

            <h3>Usando Sesiones</h3>
            <p><strong><abbr title="GUID - Globally Unique Identifier (Identificador Único Global) de 128 bits">GUID</abbr></strong> = Identificador único de 128 bits (ej: <code>123e4567-e89b-12d3-a456-426614174000</code>).</p>
            <p><strong><abbr title="JSON - JavaScript Object Notation, formato ligero de intercambio de datos">JSON</abbr></strong> = Formato de texto para representar objetos, usado para serializar datos en sesión.</p>

            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">auth_routes.py</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44</div>
                    <pre><code><span class="token-keyword">from</span> fastapi <span class="token-keyword">import</span> FastAPI, HTTPException, Depends
<span class="token-keyword">from</span> fastapi.security <span class="token-keyword">import</span> OAuth2PasswordBearer
<span class="token-keyword">from</span> datetime <span class="token-keyword">import</span> timedelta, datetime

<span class="token-comment"># Configuración JWT (en producción usar variables de entorno)</span>
SECRET_KEY = <span class="token-string">"tu-clave-secreta-aqui"</span>
ALGORITHM = <span class="token-string">"HS256"</span>
ACCESS_TOKEN_EXPIRE_MINUTES = <span class="token-number">30</span>

oauth2_scheme = OAuth2PasswordBearer(tokenUrl=<span class="token-string">"token"</span>)

<span class="token-keyword">class</span> <span class="token-class">AccountController</span>:
    <span class="token-attribute">@app.post</span>(<span class="token-string">"/api/auth/login"</span>)
    <span class="token-keyword">async def</span> <span class="token-function">login</span>(
        credentials: LoginViewModel,
        auth_service: AuthService
    ):
        <span class="token-comment"># Validar credenciales contra BD</span>
        usuario = <span class="token-keyword">await</span> auth_service.autenticar(credentials.email, credentials.password)

        <span class="token-keyword">if</span> <span class="token-keyword">not</span> usuario:
            <span class="token-keyword">raise</span> HTTPException(
                status_code=<span class="token-number">401</span>,
                detail=<span class="token-string">"Credenciales inválidas"</span>
            )

        <span class="token-comment"># Crear token JWT</span>
        access_token_expires = timedelta(minutes=<span class="token-number">ACCESS_TOKEN_EXPIRE_MINUTES</span>)
        expire = datetime.utcnow() + access_token_expires

        <span class="token-keyword">to_encode</span> = {
            <span class="token-string">"sub"</span>: usuario.email,
            <span class="token-string">"exp"</span>: expire,
            <span class="token-string">"usuario_id"</span>: usuario.id
        }

        token = <span class="token-function">create_access_token</span>(data=<span class="token-keyword">to_encode</span>, secret_key=SECRET_KEY, algorithm=ALGORITHM)

        <span class="token-keyword">return</span> {
            <span class="token-string">"access_token"</span>: token,
            <span class="token-string">"token_type"</span>: <span class="token-string">"bearer"</span>,
            <span class="token-string">"expires_in"</span>: access_token_expires.seconds
        }

<span class="token-attribute">@app.get</span>(<span class="token-string">/api/auth/perfil"</span>)
<span class="token-keyword">async def</span> <span class="token-function">perfil</span>(
    current_user: <span class="token-type">dict</span> = Depends(get_current_user)
):
    <span class="token-comment"># Leer del token JWT</span>
    <span class="token-keyword">return</span> {
        <span class="token-string">"usuario_id"</span>: current_user.get(<span class="token-string">"usuario_id"</span>),
        <span class="token-string">"email"</span>: current_user.get(<span class="token-string">"sub"</span>)
    }

<span class="token-attribute">@app.post</span>(<span class="token-string">/api/auth/logout"</span>)
<span class="token-keyword">async def</span> <span class="token-function">logout</span>():
    <span class="token-comment"># En frontend, eliminar el token</span>
    <span class="token-keyword">return</span> {<span class="token-string">"mensaje"</span>: <span class="token-string">"Sesión cerrada exitosamente"</span>}</code></pre>
                </div>
            </div>

            <h3>Cookies</h3>
            <p>Manipulación directa de cookies con opciones de seguridad:</p>
            <ul>
                <li><strong><abbr title="HttpOnly - Bandera de cookie que previene acceso desde JavaScript">HttpOnly</abbr></strong> = Si es true, la cookie NO es accesible vía JavaScript (protege contra XSS)</li>
                <li><strong><abbr title="SameSite - Atributo de cookie que controla cuándo se envía en solicitudes cross-site">SameSite</abbr></strong> = Controla envío de cookies en peticiones cross-site (previene CSRF)</li>
                <li><strong>Secure</strong> = Si es true, la cookie solo se envía por HTTPS</li>
                <li><strong><abbr title="GDPR - General Data Protection Regulation, reglamento europeo de protección de datos">GDPR</abbr></strong> = Reglamento UE que requiere consentimiento para cookies no esenciales</li>
            </ul>

            <div class="warning-box">
                <strong>Errores Comunes con Cookies</strong>
                <ul>
                    <li><strong>Guardar datos sensibles sin HttpOnly:</strong> Vulnerable a robo via XSS</li>
                    <li><strong>No usar SameSite:</strong> Vulnerable a ataques CSRF</li>
                    <li><strong>Exceder tamaño límite:</strong> Cookies máx 4KB (si necesitas más, usa Session)</li>
                </ul>
            </div>

            <h4>Ejemplo de manipulación</h4>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">preferencias_routes.py</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32</div>
                    <pre><code>from fastapi import APIRouter, Response, Request
from datetime import datetime, timedelta

router = APIRouter()

<span class="token-comment"># Establecer cookie</span>
@router.post("/api/preferencias/tema")
async def set_tema(
    tema: str,
    response: Response
):
    <span class="token-comment"># Cookie con opciones de seguridad</span>
    expires = datetime.utcnow() + timedelta(days=30)
    response.set_cookie(
        key="Tema",
        value=tema,
        expires=expires,
        httponly=False,  <span class="token-comment"># Accesible por JavaScript (True para datos sensibles)</span>
        secure=True,     <span class="token-comment"># Solo HTTPS</span>
        samesite="strict"  <span class="token-comment"># Previene CSRF</span>
    )
    return {"mensaje": f"Tema establecido: {tema}"}

<span class="token-comment"># Leer cookie</span>
@router.get("/api/preferencias/tema")
async def get_tema(request: Request):
    tema = request.cookies.get("Tema", "claro")
    return {"tema": tema}

<span class="token-comment"># Eliminar cookie</span>
@router.delete("/api/preferencias/tema")
async def eliminar_tema(response: Response):
    response.delete_cookie(key="Tema")
    return {"mensaje": "Cookie eliminada"}</code></pre>
                </div>
            </div>
        </section>

        <!-- Upload de Archivos -->
        <section id="upload" class="section">
            <h2>5. Upload de Archivos</h2>

            <div class="note-box">
                <strong>¿Por qué UploadFile?</strong>
                <ul>
                    <li><strong>Abstracción:</strong> Representa un archivo recibido en una petición HTTP</li>
                    <li><strong>Stream:</strong> Permite leer el archivo sin cargarlo completo en memoria</li>
                    <li><strong>Validación:</strong> Facilita verificar tipo, tamaño y nombre del archivo</li>
                </ul>
            </div>

            <h3><abbr title="UploadFile - Clase de FastAPI/Starlette que representa un archivo enviado en una petición HTTP">UploadFile</abbr></h3>
            <p>Clase que representa un archivo recibido en una petición HTTP. Propiedades clave:</p>
            <ul>
                <li><code>filename</code> - Nombre original del archivo</li>
                <li><code>size</code> - Tamaño en bytes</li>
                <li><code>content_type</code> - Tipo MIME (ej: "image/jpeg")</li>
                <li><code>file</code> - Objeto SpooledTemporaryFile para leer el contenido</li>
            </ul>

            <div class="warning-box">
                <strong>Errores Comunes en Upload</strong>
                <ul>
                    <li><strong>No validar extensión:</strong> Permite subir archivos ejecutables (.exe, .bat)</li>
                    <li><strong>No limitar tamaño:</strong> Puede saturar el servidor</li>
                    <li><strong>Sobrescribir archivos:</strong> <code>uuid.uuid4()</code> genera nombres únicos para evitar colisiones</li>
                    <li><strong>Olvidar enctype="multipart/form-data":</strong> El formulario NO envía archivos sin este atributo</li>
                </ul>
            </div>

            <h4>Vista con formulario</h4>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">subir-foto.component.html</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22</div>
                    <pre><code><span class="token-comment">&lt;!-- Componente Angular con formulario para subir archivo --&gt;</span>
&lt;div class="card"&gt;
  &lt;div class="card-body"&gt;
    &lt;h3 class="card-title"&gt;Foto del Estudiante&lt;/h3&gt;

    &lt;form [formGroup]="uploadForm"
          (ngSubmit)="onSubmit()"
          enctype="multipart/form-data"&gt;

      &lt;div class="mb-3"&gt;
        &lt;label for="archivo" class="form-label"&gt;Seleccionar Foto&lt;/label&gt;
        &lt;input type="file"
               id="archivo"
               class="form-control"
               accept=".jpg,.jpeg,.png"
               (change)="onFileSelected($event)"&gt;
        &lt;div class="form-text"&gt;Formatos permitidos: JPG, PNG (máx. 2MB)&lt;/div&gt;
      &lt;/div&gt;

      &lt;button type="submit"
              class="btn btn-primary"
              [disabled]="uploadForm.invalid || uploading"&gt;
        &lt;span *ngIf="uploading"&gt;Subiendo...&lt;/span&gt;
        &lt;span *ngIf="!uploading"&gt;Subir&lt;/span&gt;
      &lt;/button&gt;
    &lt;/form&gt;
  &lt;/div&gt;
&lt;/div&gt;</code></pre>
                </div>
            </div>

            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">estudiantes_routes.py</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46</div>
                    <pre><code>from fastapi import UploadFile, File, HTTPException
from pathlib import Path
import uuid
import shutil

UPLOAD_DIR = Path("uploads/fotos")
UPLOAD_DIR.mkdir(parents=True, exist_ok=True)

@router.post("/api/estudiantes/{estudiante_id}/foto")
async def subir_foto(
    estudiante_id: int,
    archivo: UploadFile = File(...)
):
    <span class="token-comment"># Validar que se seleccionó un archivo</span>
    if not archivo or not archivo.filename:
        raise HTTPException(status_code=400, detail="No se seleccionó ningún archivo")

    <span class="token-comment"># Validaciones</span>
    extensiones_permitidas = {".jpg", ".jpeg", ".png"}
    extension = Path(archivo.filename).suffix.lower()

    if extension not in extensiones_permitidas:
        raise HTTPException(status_code=400, detail="Formato de archivo no válido")

    <span class="token-comment"># Leer contenido para validar tamaño</span>
    contenido = await archivo.read()
    if len(contenido) > 2 * 1024 * 1024:  <span class="token-comment"># 2MB</span>
        raise HTTPException(status_code=400, detail="El archivo es demasiado grande (máx. 2MB)")

    <span class="token-comment"># Generar nombre único</span>
    nombre_archivo = f"{estudiante_id}_{uuid.uuid4()}{extension}"
    ruta_completa = UPLOAD_DIR / nombre_archivo

    <span class="token-comment"># Guardar archivo</span>
    with open(ruta_completa, "wb") as f:
        f.write(contenido)

    <span class="token-comment"># Guardar ruta en base de datos</span>
    await estudiante_service.actualizar_foto(estudiante_id, f"/uploads/fotos/{nombre_archivo}")

    return {"mensaje": "Foto subida correctamente", "ruta": f"/uploads/fotos/{nombre_archivo}"}</code></pre>
                </div>
            </div>

            <h3>Subir Varios Archivos</h3>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">subir-documentos.component.html</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18</div>
                    <pre><code>&lt;!-- Componente Angular para subir múltiples archivos --&gt;
&lt;div class="card"&gt;
  &lt;div class="card-body"&gt;
    &lt;h3 class="card-title"&gt;Subir Documentos&lt;/h3&gt;

    &lt;form (ngSubmit)="onSubmit()" enctype="multipart/form-data"&gt;

      &lt;div class="mb-3"&gt;
        &lt;label for="archivos" class="form-label"&gt;Seleccionar Archivos&lt;/label&gt;
        &lt;input type="file"
               id="archivos"
               class="form-control"
               multiple
               (change)="onFilesSelected($event)"&gt;
        &lt;div class="form-text"&gt;Puedes seleccionar varios archivos&lt;/div&gt;
      &lt;/div&gt;

      &lt;div *ngIf="selectedFiles.length &gt; 0" class="mb-3"&gt;
        &lt;p&gt;Archivos seleccionados: {{ selectedFiles.length }}&lt;/p&gt;
        &lt;ul&gt;
          &lt;li *ngFor="let file of selectedFiles"&gt;{{ file.name }}&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/div&gt;

      &lt;button type="submit"
              class="btn btn-primary"
              [disabled]="selectedFiles.length === 0 || uploading"&gt;
        Subir Documentos
      &lt;/button&gt;
    &lt;/form&gt;
  &lt;/div&gt;
&lt;/div&gt;</code></pre>
                </div>
            </div>

            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">estudiantes_routes.py</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21</div>
                    <pre><code>from fastapi import UploadFile, File
from pathlib import Path
from typing import List

UPLOAD_DIR = Path("uploads/documentos")
UPLOAD_DIR.mkdir(parents=True, exist_ok=True)

@router.post("/api/estudiantes/documentos")
async def subir_documentos(archivos: List[UploadFile] = File(...)):
    archivos_subidos = []

    for archivo in archivos:
        if archivo.filename:
            nombre = Path(archivo.filename).name
            ruta = UPLOAD_DIR / nombre

            <span class="token-comment"># Guardar archivo</span>
            contenido = await archivo.read()
            with open(ruta, "wb") as f:
                f.write(contenido)

            archivos_subidos.append(nombre)

    return {
        "mensaje": f"{len(archivos_subidos)} archivos subidos",
        "archivos": archivos_subidos
    }</code></pre>
                </div>
            </div>
        </section>

        <!-- CSRF Protection -->
        <section id="csrf" class="section">
            <h2>6. Protección CSRF</h2>

            <div class="note-box">
                <strong>¿Por qué protección CSRF?</strong>
                <ul>
                    <li><strong>Ataque silencioso:</strong> Un sitio malicioso puede enviar peticiones en tu nombre sin que lo sepas</li>
                    <li><strong>Acciones críticas:</strong> Cambio de contraseña, transferencias, eliminación de datos</li>
                    <li><strong>Token único:</strong> El token antiforgery solo es válido para tu sesión y tu formulario</li>
                </ul>
            </div>

            <h3>Seguridad contra ataques</h3>
            <p><strong><abbr title="CSRF - Cross-Site Request Forgery, ataque que engaña al navegador para enviar peticiones no autorizadas">CSRF</abbr> (Cross-Site Request Forgery)</strong> = Ataque donde un sitio malicioso envía un formulario con las credenciales del usuario autenticado a su servidor.</p>

            <div class="warning-box">
                <strong>¿Cómo funciona el ataque CSRF?</strong>
                <ol>
                    <li>Usuario inicia sesión en sitio-banco.com</li>
                    <li>Usuario visita sitio-malicioso.com (todavía con la sesión de banco activa)</li>
                    <li>sitio-malicioso.com tiene un formulario oculto que POST a sitio-banco.com/transferir</li>
                    <li>El navegador envía automáticamente las cookies de sesión del banco</li>
                    <li>El banco procesa la transferencia porque parece legítima</li>
                </ol>
                <p><strong>SOLUCIÓN: Token antiforgery que solo el servidor conoce</strong></p>
            </div>

            <h4>Implementación Automática:</h4>
            <ul>
                <li><code>[ValidateAntiForgeryToken]</code> en Controller</li>
                <li><code>@Html.AntiForgeryToken()</code> en form (genera input oculto con token)</li>
                <li>Token generado automáticamente y válido por sesión</li>
            </ul>

            <h4>Tag Helpers (átomos de HTML en Angular templates)</h4>
            <p><strong><abbr title="Directivas Angular - Característica de Angular templates que permite usar atributos especiales para binding y eventos">Directivas Angular</abbr></strong> = Atributos especiales que permiten binding de datos y manejo de eventos. Ejemplos: <code>*ngIf</code>, <code>[ngClass]</code>, <code>(click)</code>, <code>[(ngModel)]</code>.</p>

            <h4>Implementación con Tag Helpers</h4>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">CSRF-Example.html</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15</div>
                    <pre><code>&amp;lt;!-- EN FORMULARIO (Tag Helper): --&amp;gt;
&amp;lt;form method=<span class="token-string">&quot;post&quot;</span>&amp;gt;
    @Html.AntiForgeryToken()  &amp;lt;-- Token oculto
    &amp;lt;input name=<span class="token-string">&quot;_codigo&quot;</span> /&amp;gt;
&amp;lt;/form&amp;gt;

&amp;lt;!-- EN AJAX: --&amp;gt;
&amp;lt;!-- AJAX = Asynchronous JavaScript and XML, técnica para actualizar página sin recargar --&amp;gt;
$.ajax({
    url: &#x27;/estudiantes/eliminar&#x27;,
    type: &#x27;POST&#x27;,
    headers: {
        <span class="token-string">&quot;RequestVerificationToken&quot;</span>: $(&#x27;input[name=<span class="token-string">&quot;__RequestVerificationToken&quot;</span>]&#x27;).val()
    }
});</code></pre>
                </div>
            </div>

            <div class="note-box">
                <strong>Mini-Chequeo: CSRF Protection</strong>
                <ul>
                    <li>¿Puedes explicar cómo funciona el ataque CSRF paso a paso?</li>
                    <li>¿Por qué el token antiforgery protege contra este ataque?</li>
                    <li>¿Qué pasa si olvidas poner [ValidateAntiForgeryToken] en una acción POST?</li>
                </ul>
            </div>
        </section>

        <!-- Evaluación 4 -->
        <section class="evaluacion-calificable">
            <h3>📋 Evaluación programada</h3>
            <p><strong>Detalle:</strong> Consultar plataforma del curso para información completa sobre evaluación calificable.</p>
        </section>
        </section>

        <!-- Ejemplos -->
        <section id="ejemplos" class="section">
            <h2>Ejemplos</h2>
            <p>Los ejemplos de código están integrados en las secciones teóricas anteriores. Consulte cada sección para ver ejemplos prácticos de:</p>
            <ul>
                <li>Pydantic para validación</li>
                <li>Validación en cliente y servidor</li>
                <li>Uso de MessageService y Component Inputs</li>
                <li>Manejo de sesiones y cookies</li>
                <li>Upload de archivos</li>
                <li>Protección CSRF</li>
            </ul>
        </section>

        <!-- Practica / Laboratorio -->
        <section id="practica" class="section">
            <h2>Práctica / Laboratorio</h2>
            <p><strong>Duración estimada:</strong> 40 minutos</p>
            <p><strong>Objetivo:</strong> Implementar un formulario de registro con validaciones y manejo de MessageService para mensajes.</p>

            <h3>Pasos en VS Code / Visual Studio Code</h3>
            <ol>
                <li>Abre VS Code / Visual Studio Code y crea un proyecto <strong>FastAPI + Angular</strong></li>
                <li>Crea el modelo <code>models/registro.py</code> con Pydantic (Field, field_validator)</li>
                <li>Añade validaciones: Field(...), EmailStr, field_validator para comparaciones</li>
                <li>En <code>routers/auth.py</code>, crea rutas POST con FastAPI</li>
                <li>Implementa lógica POST con validación automática de Pydantic y MessageService para mensajes</li>
                <li>En el componente Angular, usa Reactive Forms y Directivas de validación</li>
                <li>Prueba validaciones cliente y servidor, verifica mensajes con MessageService</li>
            </ol>

            <h3>Checklist de verificación</h3>
            <ul>
                <li>El modelo tiene Pydantic (Field(), EmailStr, field_validator)</li>
                <li>Las validaciones funcionan en el navegador (Angular Reactive Forms)</li>
                <li>FastAPI valida automáticamente con Pydantic (retorna 422 si falla)</li>
                <li>MessageService muestra mensajes después de router.navigate</li>
                <li>JWT tokens protegen contra CSRF/autenticación no autorizada</li>
            </ul>
        </section>
        <!-- Ejercicios -->
        <section id="ejercicios" class="section">
            <h2>Ejercicios Prácticos</h2>

            <h3>Ejercicio 1: Login Completo</h3>
            <p><strong>Duración estimada:</strong> 25 minutos</p>
            <h4>Checklist:</h4>
            <ul>
                <li>Email con validación EmailStr de Pydantic</li>
                <li>Password con Field(..., min_length=6)</li>
                <li>JWT tokens para guardar usuario (localStorage)</li>
                <li>Eliminar token en logout</li>
            </ul>
            <ul>
                <li>Validación de email</li>
                <li>Validación de clave (mínimo 6 caracteres)</li>
                <li>Manejo de sesión con JWT</li>
                <li>Logout (eliminar token)</li>
            </ul>

            <h3>Ejercicio 2: Carrito con BehaviorSubject</h3>
            <p><strong>Duración estimada:</strong> 20 minutos</p>
            <h4>Checklist:</h4>
            <ul>
                <li>BehaviorSubject para guardar lista de productos</li>
                <li>Observable para recuperar y mostrar carrito</li>
                <li>Método vaciar carrito con next([])</li>
            </ul>
            <ul>
                <li>Agregar productos al carrito</li>
                <li>Mostrar carrito con async pipe</li>
                <li>Vaciar carrito</li>
            </ul>

            <h3>Ejercicio Integrador: Sistema de Inscripción</h3>
            <p><strong>Duración estimada:</strong> 45 minutos</p>
            <p>Crear sistema de inscripción de estudiantes con:</p>
            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Requisito</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td><strong>ViewModel con validaciones:</strong> Código (requerido, 5-10 caracteres, único), Nombre (requerido, máx. 50), Email (requerido, formato válido), FechaNacimiento (requerido, mayor de 15 años), Carrera (seleccionar de dropdown), Foto (opcional, solo JPG/PNG, máx. 1MB)</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td><strong>Controller:</strong> GET (mostrar formulario), POST (validar, guardar, mostrar mensaje éxito), Validación de código único</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td><strong>Vista:</strong> Formulario Bootstrap estilizado, Validación cliente activada, Vista previa de foto (JS), Mensajes de error específicos por campo</td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td><strong>Sesión:</strong> Guardar último estudiante registrado, Mostrar en barra superior "último registro: [Nombre]"</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td><strong>Extra:</strong> Exportar lista a Excel (simulado), Filtrar por carrera (session)</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Referencias -->
        <section id="referencias" class="section">
            <h2>Referencias y Recursos</h2>

            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>Recurso</th>
                        <th>Enlace</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Model Validation</td>
                        <td><a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/models/validation" target="_blank">docs.microsoft.com/aspnet/core/mvc/models/validation</a></td>
                    </tr>
                    <tr>
                        <td>Session State</td>
                        <td><a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/app-state" target="_blank">docs.microsoft.com/aspnet/core/fundamentals/app-state</a></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Resumen -->
        <section id="resumen" class="section">
            <h2>Resumen de la Clase</h2>
            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>Concepto</th>
                        <th>Descripción</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Pydantic</strong></td>
                        <td>Atributos para validación de modelos</td>
                    </tr>
                    <tr>
                        <td><strong>Pydantic validation</strong></td>
                        <td>Validación automática de modelos en FastAPI</td>
                    </tr>
                    <tr>
                        <td><strong>Angular Reactive Forms</strong></td>
                        <td>Validación en cliente</td>
                    </tr>
                    <tr>
                        <td><strong>MessageService</strong></td>
                        <td>Comunicación entre componentes (BehaviorSubject)</td>
                    </tr>
                    <tr>
                        <td><strong>JWT Tokens</strong></td>
                        <td>Autenticación y autorización sin estado</td>
                    </tr>
                    <tr>
                        <td><strong>Cookies</strong></td>
                        <td>Almacenamiento en navegador</td>
                    </tr>
                    <tr>
                        <td><strong>UploadFile</strong></td>
                        <td>Manejo de archivos subidos (FastAPI)</td>
                    </tr>
                    <tr>
                        <td><strong>Async Validators</strong></td>
                        <td>Validación AJAX en tiempo real</td>
                    </tr>
                    <tr>
                        <td><strong>CSRF Protection</strong></td>
                        <td>SameSite cookies para seguridad</td>
                    </tr>
                    <tr>
                        <td><strong>Distributed Cache</strong></td>
                        <td>Estado escalable (Redis, Memcached)</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Proxima Clase -->
        <section class="section">
            <h2>Próxima Clase: Introducción a pyodbc</h2>
            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>Tema</th>
                        <th>Descripción</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>pyodbc</strong></td>
                        <td>pyodbc Connection, cursor.execute(), cursor.fetchall()</td>
                    </tr>
                    <tr>
                        <td><strong>CRUD básico</strong></td>
                        <td>Create, Read, Update, Delete con SQL puro</td>
                    </tr>
                    <tr>
                        <td><strong>Parámetros</strong></td>
                        <td>Consultas parametrizadas para evitar SQL Injection</td>
                    </tr>
                    <tr>
                        <td><strong>Transacciones</strong></td>
                        <td>Commit, Rollback</td>
                    </tr>
                </tbody>
            </table>
        </section>
    </main>

    <section id='entrega-git'>
  <h3>Entrega con Git</h3>
  <p>Branch: <code>feature/tema-clase-11</code></p>
  <ul>
    <li>Commits: setup / implementación / pruebas-docs</li>
  </ul>
  <p>Tag: <code>clase-11-v1</code></p>
</section><footer class="footer">
        <p><strong>Unidad 3 completada: 4/4 clases ✅</strong></p>
        <p>UNAULA - Ingeniería Informática - 2026-I</p>
        <p>IF0100 - Lenguaje de Programación Orientada a Objetos II</p>
    </footer>
</body>
</html>


