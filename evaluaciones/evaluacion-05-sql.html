<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E5: Base de Datos SQL - IF0100</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <!-- Prism.js CSS para syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <style>
        :root { --primary: #198754; }
        header { background: linear-gradient(135deg, var(--primary) 0%, #0f5132 100%); color: white; padding: 2rem 0; }
        .criterio { background: #f8f9fa; border-left: 4px solid var(--primary); padding: 1rem 1.25rem; margin: 1rem 0; border-radius: 0 8px 8px 0; }
        .criterio h5 { color: var(--primary); margin-bottom: 0.75rem; }
        .criterio ul { margin-bottom: 0; }
        .entregable-box { background: #1e1e1e; color: #d4d4d4; padding: 1.25rem; border-radius: 8px; font-family: 'Consolas', 'Monaco', monospace; overflow-x: auto; white-space: pre; line-height: 1.4; font-size: 0.9rem; }
        .entregable-box .comment { color: #6a9955; }
        .entregable-box .folder { color: #569cd6; }
        .penalizacion { background: #f8d7da; border-left: 4px solid #dc3545; padding: 1rem 1.25rem; margin: 1rem 0; border-radius: 0 8px 8px 0; }
        code:not([class*="language-"]) { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; color: #d63384; }
        pre[class*="language-"] { border-radius: 8px; margin: 0; }
        .detalle-req { background: #fff3cd; border-left: 4px solid #ffc107; padding: 0.75rem 1rem; margin: 0.5rem 0; font-size: 0.9rem; }
        .paso-num { display: inline-block; width: 28px; height: 28px; background: var(--primary); color: white; border-radius: 50%; text-align: center; line-height: 28px; font-weight: bold; margin-right: 8px; }
    </style>
</head>
<body>
    <header class="mb-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-clipboard-check me-2"></i>Evaluación 5</h1>
                    <h2>Persistencia Relacional SQL</h2>
                    <p class="mb-0"><strong>Entrega Incremental 5 - SQLAlchemy ORM y Alembic</strong></p>
                </div>
                <div class="col-md-4 text-md-end">
                    <span class="badge bg-white text-success fs-5 mb-2">15%</span><br>
                    <span class="badge bg-dark">Software</span><br>
                    <small>Fecha límite: 7 de mayo de 2026</small>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="../index.html">Inicio</a></li>
                <li class="breadcrumb-item"><a href="../index.html#evaluacion">Evaluaciones</a></li>
                <li class="breadcrumb-item active">E5 - SQL</li>
            </ol>
        </nav>

        <div class="alert alert-danger">
            <h5><i class="bi bi-exclamation-triangle me-2"></i>Requisitos Previos</h5>
            <p class="mb-0"><strong>REQUIERE E4 (Persistencia Archivos) completada.</strong> Se migrará de JSON a SQL manteniendo el mismo interfaz Repository. Los endpoints NO deben cambiar.</p>
        </div>

        <div class="card mb-4 border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-book me-2"></i>Clases Relacionadas</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Estas clases preparan los conocimientos necesarios para esta evaluación:</p>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <i class="bi bi-table text-success me-2"></i>
                                <a href="../unidad-04/clase-02-sqlalchemy-modelos.html" class="text-decoration-none">Clase 02: SQLAlchemy Modelos</a>
                                <small class="d-block text-muted">DeclarativeBase, Columnas, tipos</small>
                            </li>
                            <li class="list-group-item">
                                <i class="bi bi-diagram-3 text-success me-2"></i>
                                <a href="../unidad-04/clase-03-sqlalchemy-relaciones.html" class="text-decoration-none">Clase 03: SQLAlchemy Relaciones</a>
                                <small class="d-block text-muted">ForeignKey, relationship, backref</small>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <i class="bi bi-save text-success me-2"></i>
                                <a href="../unidad-04/clase-04-crud-sqlalchemy.html" class="text-decoration-none">Clase 04: CRUD SQLAlchemy</a>
                                <small class="d-block text-muted">Session, add, commit, query</small>
                            </li>
                            <li class="list-group-item">
                                <i class="bi bi-arrow-up-right-circle text-success me-2"></i>
                                <a href="../unidad-04/clase-05-alembic.html" class="text-decoration-none">Clase 05: Alembic Migraciones</a>
                                <small class="d-block text-muted">Versionado de base de datos</small>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <h3 class="mt-4 mb-3"><i class="bi bi-bullseye me-2"></i>Objetivo de Aprendizaje</h3>
        <p class="lead">Migrar la persistencia a <strong>base de datos relacional</strong> con SQLAlchemy ORM y migraciones Alembic. Mantener la misma interfaz Repository para que los endpoints sean idénticos.</p>

        <h3 class="mt-4 mb-3"><i class="bi bi-list-check me-2"></i>Requisitos Técnicos Detallados</h3>

        <!-- MODELOS ORM -->
        <div class="criterio">
            <h5><i class="bi bi-table text-primary me-2"></i>1. Modelos SQLAlchemy</h5>
            <p><strong>Descripción:</strong> Definir modelos ORM que mapean a tablas de base de datos.</p>

            <h6 class="mt-3">Modelos obligatorios:</h6>
            <ul>
                <li><code>UsuarioModel(Base)</code>: Tabla <code>usuarios</code></li>
                <li><code>ProyectoModel(Base)</code>: Tabla <code>proyectos</code> con FK a usuarios</li>
                <li><code>TareaModel(Base)</code>: Tabla <code>tareas</code> con FK a proyectos</li>
            </ul>

            <h6>Columnas requeridas:</h6>
            <ul>
                <li><strong>Usuario:</strong> id (PK), username (unique), email, nombre_completo, activo, fecha_registro</li>
                <li><strong>Proyecto:</strong> id (PK), nombre, descripcion, lider_id (FK), fecha_creacion</li>
                <li><strong>Tarea:</strong> id (PK), titulo, descripcion, prioridad, estado, proyecto_id (FK), fechas</li>
            </ul>

            <div class="detalle-req">
                <strong>Separación de modelos:</strong>
                <ul class="mb-0">
                    <li>Modelos ORM en <code>infrastructure/models.py</code></li>
                    <li>Clases de dominio en <code>domain/</code> permanecen igual</li>
                    <li>El repositorio hace la conversión entre ambos</li>
                </ul>
            </div>
        </div>

        <!-- RELACIONES -->
        <div class="criterio">
            <h5><i class="bi bi-diagram-3 text-success me-2"></i>2. Relaciones One-to-Many</h5>
            <p><strong>Descripción:</strong> Configurar relaciones entre tablas correctamente.</p>

            <h6 class="mt-3">Relaciones obligatorias:</h6>
            <ul>
                <li><strong>Usuario → Proyectos:</strong> Un usuario líder puede tener muchos proyectos</li>
                <li><strong>Proyecto → Tareas:</strong> Un proyecto tiene muchas tareas (composición)</li>
            </ul>

            <h6>Configuración con relationship:</h6>
            <ul>
                <li><code>relationship("ProyectoModel", back_populates="lider")</code></li>
                <li><code>relationship("TareaModel", back_populates="proyecto", cascade="all, delete-orphan")</code></li>
            </ul>

            <div class="detalle-req">
                <strong>Cascade delete:</strong> Al eliminar un proyecto, sus tareas deben eliminarse automáticamente (composición).
            </div>
        </div>

        <!-- REPOSITORY SQL -->
        <div class="criterio">
            <h5><i class="bi bi-database text-info me-2"></i>3. Repository SQLAlchemy</h5>
            <p><strong>Descripción:</strong> Nueva implementación del Repository usando SQL en lugar de JSON.</p>

            <h6 class="mt-3">Implementaciones obligatorias:</h6>
            <ul>
                <li><code>UsuarioRepositorySQL(IUsuarioRepository)</code></li>
                <li><code>ProyectoRepositorySQL(IProyectoRepository)</code></li>
                <li><code>TareaRepositorySQL(ITareaRepository)</code></li>
            </ul>

            <h6>Uso de Session:</h6>
            <ul>
                <li>Inyectar <code>Session</code> de SQLAlchemy vía Depends()</li>
                <li>Usar <code>session.add()</code>, <code>session.commit()</code>, <code>session.rollback()</code></li>
                <li>Manejo de excepciones de integridad (IntegrityError)</li>
            </ul>

            <div class="detalle-req">
                <strong>Conversión ORM ↔ Dominio:</strong>
                <ul class="mb-0">
                    <li><code>_to_domain(model)</code>: Convierte Modelo ORM a clase de dominio</li>
                    <li><code>_to_model(entity)</code>: Convierte clase de dominio a Modelo ORM</li>
                </ul>
            </div>
        </div>

        <!-- ALEMBIC -->
        <div class="criterio">
            <h5><i class="bi bi-arrow-up-right-circle text-warning me-2"></i>4. Migraciones Alembic</h5>
            <p><strong>Descripción:</strong> Versionar la base de datos con migraciones automáticas.</p>

            <h6 class="mt-3">Comandos obligatorios:</h6>
            <ul>
                <li><code>alembic init alembic</code>: Inicializar Alembic</li>
                <li><code>alembic revision --autogenerate -m "Initial tables"</code>: Crear migración</li>
                <li><code>alembic upgrade head</code>: Aplicar migraciones</li>
            </ul>

            <h6>Archivos requeridos:</h6>
            <ul>
                <li><code>alembic.ini</code>: Configuración (URL de base de datos)</li>
                <li><code>alembic/env.py</code>: Importar modelos, setear target_metadata</li>
                <li><code>alembic/versions/*.py</code>: Migraciones generadas</li>
            </ul>

            <div class="detalle-req">
                <strong>PROHIBIDO:</strong> Usar <code>Base.metadata.create_all()</code>. Obligatorio usar migraciones Alembic.
            </div>
        </div>

        <h3 class="mt-5 mb-3"><i class="bi bi-code-square me-2"></i>Ejemplo de Implementación</h3>

        <div class="card mb-3">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-file-earmark-code me-2"></i>infrastructure/models.py
            </div>
            <div class="card-body p-0">
                <pre class="m-0"><code class="language-python">from datetime import datetime
from sqlalchemy import String, Integer, Boolean, DateTime, ForeignKey, Enum as SQLEnum
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column, relationship
from src.domain.enums import PrioridadTarea, EstadoTarea


class Base(DeclarativeBase):
    """Base para todos los modelos."""
    pass


class UsuarioModel(Base):
    """Modelo ORM para usuarios."""
    __tablename__ = "usuarios"

    id: Mapped[int] = mapped_column(primary_key=True)
    username: Mapped[str] = mapped_column(String(50), unique=True, nullable=False)
    email: Mapped[str] = mapped_column(String(100), unique=True, nullable=False)
    nombre_completo: Mapped[str | None] = mapped_column(String(100))
    activo: Mapped[bool] = mapped_column(default=True)
    fecha_registro: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)

    # Relación con proyectos donde es líder
    proyectos: Mapped[list["ProyectoModel"]] = relationship(
        "ProyectoModel", back_populates="lider"
    )


class ProyectoModel(Base):
    """Modelo ORM para proyectos."""
    __tablename__ = "proyectos"

    id: Mapped[int] = mapped_column(primary_key=True)
    nombre: Mapped[str] = mapped_column(String(100), nullable=False)
    descripcion: Mapped[str | None] = mapped_column(String(500))
    fecha_creacion: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)

    # Foreign Key al líder
    lider_id: Mapped[int] = mapped_column(ForeignKey("usuarios.id"))
    lider: Mapped["UsuarioModel"] = relationship("UsuarioModel", back_populates="proyectos")

    # Relación con tareas (cascade delete)
    tareas: Mapped[list["TareaModel"]] = relationship(
        "TareaModel", back_populates="proyecto", cascade="all, delete-orphan"
    )


class TareaModel(Base):
    """Modelo ORM para tareas."""
    __tablename__ = "tareas"

    id: Mapped[int] = mapped_column(primary_key=True)
    titulo: Mapped[str] = mapped_column(String(100), nullable=False)
    descripcion: Mapped[str | None] = mapped_column(String(500))
    prioridad: Mapped[PrioridadTarea] = mapped_column(
        SQLEnum(PrioridadTarea), default=PrioridadTarea.MEDIA
    )
    estado: Mapped[EstadoTarea] = mapped_column(
        SQLEnum(EstadoTarea), default=EstadoTarea.PENDIENTE
    )
    fecha_creacion: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
    fecha_completado: Mapped[datetime | None] = mapped_column(DateTime, nullable=True)

    # Foreign Key al proyecto padre
    proyecto_id: Mapped[int] = mapped_column(ForeignKey("proyectos.id"))
    proyecto: Mapped["ProyectoModel"] = relationship("ProyectoModel", back_populates="tareas")</code></pre>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-file-earmark-code me-2"></i>infrastructure/repository_sql.py
            </div>
            <div class="card-body p-0">
                <pre class="m-0"><code class="language-python">from typing import Optional, List
from sqlalchemy.orm import Session
from src.domain.usuario import Usuario
from src.infrastructure.models import UsuarioModel
from src.infrastructure.repository import IUsuarioRepository


class UsuarioRepositorySQL(IUsuarioRepository):
    """Implementación SQL del repositorio de usuarios."""

    def __init__(self, session: Session):
        self.session = session

    def _to_domain(self, model: UsuarioModel) -> Usuario:
        """Convierte modelo ORM a dominio."""
        return Usuario(
            username=model.username,
            email=model.email,
            nombre_completo=model.nombre_completo
        )

    def _to_model(self, usuario: Usuario, usuario_id: int = None) -> UsuarioModel:
        """Convierte dominio a modelo ORM."""
        model = UsuarioModel(
            username=usuario.username,
            email=usuario.email,
            nombre_completo=usuario.nombre_completo,
            activo=usuario.activo,
            fecha_registro=usuario.fecha_registro
        )
        if usuario_id:
            model.id = usuario_id
        return model

    def guardar(self, usuario: Usuario, usuario_id: int = None) -> int:
        """Guarda un usuario. Retorna el ID."""
        try:
            model = self._to_model(usuario, usuario_id)
            self.session.add(model)
            self.session.commit()
            return model.id
        except Exception as e:
            self.session.rollback()
            raise

    def obtener(self, usuario_id: int) -> Optional[Usuario]:
        """Obtiene un usuario por ID."""
        model = self.session.query(UsuarioModel).filter_by(id=usuario_id).first()
        return self._to_domain(model) if model else None

    def listar(self) -> List[Usuario]:
        """Lista todos los usuarios."""
        models = self.session.query(UsuarioModel).all()
        return [self._to_domain(m) for m in models]

    def eliminar(self, usuario_id: int) -> bool:
        """Elimina un usuario."""
        model = self.session.query(UsuarioModel).filter_by(id=usuario_id).first()
        if model:
            self.session.delete(model)
            self.session.commit()
            return True
        return False</code></pre>
            </div>
        </div>

        <h3 class="mt-5 mb-3"><i class="bi bi-box-seam me-2"></i>Estructura de Entrega</h3>
        <div class="card border-primary mb-4">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-folder2-open me-2"></i>Organización de Archivos Obligatoria
            </div>
            <div class="card-body">
                <div class="entregable-box"><span class="folder">src/infrastructure/</span>
├── <span class="folder">__init__.py</span>
├── <span class="folder">database.py</span>        <span class="comment"># engine, SessionLocal, get_db()</span>
├── <span class="folder">models.py</span>          <span class="comment"># Modelos SQLAlchemy ORM</span>
├── <span class="folder">repository.py</span>      <span class="comment"># Interfaces (sin cambios)</span>
├── <span class="folder">repository_json.py</span> <span class="comment"># Implementación JSON (backup)</span>
└── <span class="folder">repository_sql.py</span>  <span class="comment"># Nueva implementación SQL</span>

<span class="folder">api/</span>
├── <span class="folder">main.py</span>               <span class="comment"># Sin cambios en endpoints</span>
└── <span class="folder">dependencies.py</span>      <span class="comment"># Cambiar a RepositorySQL</span>

<span class="folder">alembic/</span>                    <span class="comment"># Migraciones</span>
├── <span class="folder">env.py</span>
├── <span class="folder">versions/</span>
│   └── <span class="folder">xxxx_initial_tables.py</span>
└── <span class="folder">script.py.mako</span>

<span class="folder">alembic.ini</span>                 <span class="comment"># Configuración</span>
<span class="folder">taskflow.db</span>                 <span class="comment"># Base de datos SQLite</span>
<span class="folder">requirements.txt</span>            <span class="comment"># + sqlalchemy, alembic</span></div>
            </div>
        </div>

        <h3 class="mt-4 mb-3"><i class="bi bi-list-ol me-2"></i>Pasos para Completar la Evaluación</h3>
        <div class="card border-secondary mb-4">
            <div class="card-body">
                <div class="mb-3">
                    <span class="paso-num">1</span><strong>Configurar SQLAlchemy</strong>
                    <p class="ms-4 mt-1 text-muted">engine, SessionLocal, get_db() en database.py</p>
                </div>
                <div class="mb-3">
                    <span class="paso-num">2</span><strong>Crear modelos ORM</strong>
                    <p class="ms-4 mt-1 text-muted">UsuarioModel, ProyectoModel, TareaModel con relaciones</p>
                </div>
                <div class="mb-3">
                    <span class="paso-num">3</span><strong>Configurar Alembic</strong>
                    <p class="ms-4 mt-1 text-muted">alembic init, editar env.py, crear migración inicial</p>
                </div>
                <div class="mb-3">
                    <span class="paso-num">4</span><strong>Implementar RepositorySQL</strong>
                    <p class="ms-4 mt-1 text-muted">Mismos métodos que JSON pero con Session</p>
                </div>
                <div class="mb-3">
                    <span class="paso-num">5</span><strong>Actualizar dependencias</strong>
                    <p class="ms-4 mt-1 text-muted">Cambiar Depends(get_json_repo) a Depends(get_sql_repo)</p>
                </div>
                <div class="mb-0">
                    <span class="paso-num">6</span><strong>Probar migración</strong>
                    <p class="ms-4 mt-1 text-muted">alembic upgrade head, verificar que API funciona igual</p>
                </div>
            </div>
        </div>

        <h3 class="mt-4 mb-3"><i class="bi bi-award me-2"></i>Rúbrica de Evaluación (100%)</h3>
        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Criterio</th>
                        <th>Excelente (5.0)</th>
                        <th>Aceptable (3.5)</th>
                        <th>Insuficiente</th>
                        <th>Peso</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>ORM y Modelos</strong></td>
                        <td>Modelos bien definidos, relaciones correctas, tipos apropiados</td>
                        <td>Modelos básicos, relaciones parciales</td>
                        <td>Sin ORM o SQL crudo en strings</td>
                        <td class="fw-bold text-success">30%</td>
                    </tr>
                    <tr>
                        <td><strong>Migraciones Alembic</strong></td>
                        <td>alembic upgrade head funciona, migraciones limpias</td>
                        <td>Migración funciona pero con warnings</td>
                        <td>Sin Alembic o create_all()</td>
                        <td class="fw-bold text-success">25%</td>
                    </tr>
                    <tr>
                        <td><strong>Repository SQL</strong></td>
                        <td>Implementa interfaz, conversión ORM↔Dominio correcta</td>
                        <td>Repository funcional sin separación dominio</td>
                        <td>Lógica SQL mezclada en endpoints</td>
                        <td class="fw-bold text-success">25%</td>
                    </tr>
                    <tr>
                        <td><strong>Integración</strong></td>
                        <td>API idéntica, solo cambió Depends(), tests pasan</td>
                        <td>Cambios menores en endpoints</td>
                        <td>API rota o reescrita</td>
                        <td class="fw-bold text-success">20%</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="penalizacion">
            <h5><i class="bi bi-exclamation-triangle me-2"></i>Penalizaciones</h5>
            <ul class="mb-0">
                <li><strong>SQL crudo (strings):</strong> Nota máxima 2.0</li>
                <li><strong>Sin Alembic (usando create_all):</strong> Nota máxima 3.0</li>
                <li><strong>Filtrar en Python en lugar de SQL:</strong> -1.0 punto (ineficiente)</li>
                <li><strong>Sin cascade delete:</strong> -0.5 puntos</li>
                <li><strong>Sin relaciones configuradas:</strong> -1.0 punto</li>
            </ul>
        </div>

        <div class="alert alert-warning mt-4">
            <h5><i class="bi bi-link-45deg me-2"></i>Conexión con E6</h5>
            <p class="mb-0">Con la base de datos SQL funcionando, estarás listo para la <a href="evaluacion-06-final.html">E6: Sustentación Final</a> donde presentarás el proyecto completo.</p>
        </div>

        <div class="mt-4">
            <a href="evaluacion-04-archivos.html" class="btn btn-outline-primary">← E4: Archivos</a>
            <a href="evaluacion-06-final.html" class="btn btn-outline-secondary ms-2">E6: Final →</a>
        </div>
    </div>

    <footer class="bg-dark text-white text-center py-4 mt-5">
        <div class="container">
            <p class="mb-0">&copy; 2026 IF0100 - UNAULA | <a href="../index.html" class="text-info">Inicio</a></p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Prism.js para syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
</body>
</html>
