<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clase 12 - Introducción a ADOPython | IF0100 POO II</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .meta-bar {
            background: #1e3a8a;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .meta-bar span { font-size: 0.9rem; }
        .nav {
            background: #1e3a8a;
            padding: 0.5rem 2rem;
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background 0.3s;
        }
        .nav a:hover { background: rgba(255,255,255,0.2); }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #1e40af;
            border-bottom: 3px solid #3b82f6;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .section h3 {
            color: #3b82f6;
            margin: 1.5rem 0 1rem;
        }
        .section h4 {
            color: #1e3a8a;
            margin: 1rem 0 0.5rem;
        }
        .objectives-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        .objectives-table th, .objectives-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .objectives-table th { background: #f3f4f6; }
        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        code {
            background: #e5e7eb;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: "Fira Code", "Consolas", monospace;
            font-size: 0.9em;
        }
        pre code { background: none; padding: 0; }
        .example-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        .figure-container {
            text-align: center;
            margin: 2rem 0;
        }
        .figure-container img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .figure-container figcaption {
            margin-top: 0.5rem;
            font-style: italic;
            color: #6b7280;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }
        .comparison .bad {
            background: #fef2f2;
            border: 1px solid #fca5a5;
            padding: 1rem;
            border-radius: 4px;
        }
        .comparison .good {
            background: #f0fdf4;
            border: 1px solid #86efac;
            padding: 1rem;
            border-radius: 4px;
        }
        .comparison-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .badge-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-purple { background: #f3e8ff; color: #7c3aed; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .tag-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .tag-table th {
            background: #1e40af;
            color: white;
            padding: 0.75rem;
            text-align: left;
        }
        .tag-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        ul, ol { margin-left: 1.5rem; }
        li { margin: 0.5rem 0; }
        .footer {
            background: #1e3a8a;
            color: white;
            text-align: center;
            padding: 2rem;
            margin-top: 2rem;
        }
        .note-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .note-box strong { color: #92400e; }
        .warning-box {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .warning-box strong { color: #991b1b; }
        .checklist-box {
            background: #f0fdf4;
            border: 1px solid #86efac;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .checklist-box strong { color: #166534; }
        .note {
            background: #f0f4ff;
            border-left: 4px solid #3b82f6;
            padding: 10px 12px;
            border-radius: 8px;
            color: #52606d;
        }
        /* Syntax highlighting para Python */
        .token-keyword { color: #c792ea; font-weight: 600; }
        .token-type { color: #ffcb6b; }
        .token-string { color: #c3e88d; }
        .token-comment { color: #546e7a; font-style: italic; }
        .token-number { color: #f78c6c; }
        .token-operator { color: #89ddff; }

        /* BLOQUES DE CÓDIGO MEJORADOS */
        .code-block {
            background: #1e1e2e;
            border-radius: 12px;
            margin: 16px 0;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 1px solid #313244;
        }

        .code-header {
            background: linear-gradient(90deg, #313244 0%, #45475a 100%);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #45475a;
        }

        .code-dots {
            display: flex;
            gap: 6px;
        }

        .code-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .code-dot.red { background: #f38ba8; }
        .code-dot.yellow { background: #f9e2af; }
        .code-dot.green { background: #a6e3a1; }

        .code-title {
            color: #cdd6f4;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: auto;
            font-family: 'Cascadia Code', Consolas, monospace;
        }

        .code-content {
            display: flex;
            background: #1e1e2e;
        }

        .line-numbers {
            background: #181825;
            color: #6c7086;
            padding: 12px 10px;
            text-align: right;
            font-family: 'Cascadia Code', Consolas, monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            user-select: none;
            border-right: 1px solid #313244;
        }

        .code-block pre {
            background: transparent;
            margin: 0;
            padding: 12px 16px;
            flex: 1;
            overflow-x: auto;
        }

        .code-block pre code {
            color: #cdd6f4;
            font-size: 0.95rem;
            line-height: 1.5;
            display: block;
        }

        /* Syntax highlighting mejorado */
        .code-block .token-keyword { color: #cba6f7; font-weight: 600; }
        .code-block .token-type { color: #f9e2af; }
        .code-block .token-string { color: #a6e3a1; }
        .code-block .token-comment { color: #6c7086; font-style: italic; }
        .code-block .token-number { color: #fab387; }
        .code-block .token-operator { color: #89dceb; }
        .code-block .token-method { color: #89b4fa; }
        .code-block .token-class { color: #f9e2af; font-weight: 600; }
        .code-block .token-property { color: #b4befe; }
        .code-block .token-namespace { color: #f38ba8; }

        p code, li code {
            background: #313244;
            color: #cdd6f4;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.9em;
            border: 1px solid #45475a;
        }

        /* Accessibility */
        abbr[title] { text-decoration: underline dotted; cursor: help; }
        /* Print styles */
        @media print {
            header, nav, footer { background: white !important; color: black !important; }
            a[href]:after { content: " (" attr(href) ")"; font-size: 0.8em; }
            pre, code { white-space: pre-wrap; }
        }
        @media (max-width: 768px) {
            .comparison { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.8rem; }
            .meta-bar { flex-direction: column; text-align: center; }
        }

        /* BLOQUES DE CÓDIGO MEJORADOS */
        .code-block {
            background: #1e1e2e;
            border-radius: 12px;
            margin: 16px 0;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 1px solid #313244;
        }

        .code-header {
            background: linear-gradient(90deg, #313244 0%, #45475a 100%);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #45475a;
        }

        .code-dots {
            display: flex;
            gap: 6px;
        }

        .code-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .code-dot.red { background: #f38ba8; }
        .code-dot.yellow { background: #f9e2af; }
        .code-dot.green { background: #a6e3a1; }

        .code-title {
            color: #cdd6f4;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: auto;
            font-family: 'Cascadia Code', Consolas, monospace;
        }

        .code-content {
            display: flex;
            background: #1e1e2e;
        }

        .line-numbers {
            background: #181825;
            color: #6c7086;
            padding: 12px 10px;
            text-align: right;
            font-family: 'Cascadia Code', Consolas, monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            user-select: none;
            border-right: 1px solid #313244;
        }

        .code-block pre {
            background: transparent;
            margin: 0;
            padding: 12px 16px;
            flex: 1;
            overflow-x: auto;
        }

        .code-block pre code {
            color: #cdd6f4;
            font-size: 0.95rem;
            line-height: 1.5;
            display: block;
        }

        /* Syntax highlighting mejorado - Catppuccin Mocha theme */
        .code-block .token-keyword { color: #cba6f7; font-weight: 600; } /* purple */
        .code-block .token-type { color: #f9e2af; } /* yellow */
        .code-block .token-string { color: #a6e3a1; } /* green */
        .code-block .token-comment { color: #6c7086; font-style: italic; } /* gray */
        .code-block .token-number { color: #fab387; } /* peach */
        .code-block .token-operator { color: #89dceb; } /* cyan */
        .code-block .token-method { color: #89b4fa; } /* blue */
        .code-block .token-class { color: #f9e2af; font-weight: 600; }
        .code-block .token-property { color: #b4befe; } /* lavender */
        .code-block .token-namespace { color: #f38ba8; } /* pink */

        /* Código inline */
        p code, li code {
            background: #313244;
            color: #cdd6f4;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.9em;
            border: 1px solid #45475a;
        }

        /* Tablas de código */
        .code-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin: 16px 0;
        }

        .code-comparison .code-block {
            margin: 0;
        }

        .code-label {
            font-size: 0.8rem;
            color: #6c7086;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #1e3a8a;
            color: #fff;
            padding: 8px 16px;
            text-decoration: none;
            z-index: 100;
            transition: top 0.3s;
        }
        .skip-link:focus {
            top: 0;
        }
    </style>
</head>
<body>
    <a href="#main" class="skip-link">Saltar al contenido</a>
    <header class="header">
        <h1>Clase 12 - Introducción a ADOPython</h1>
        <p>IF0100 - Lenguaje de Programación Orientada a Objetos II | Unidad 4 - Persistencia de Datos</p>
    </header>

    <div class="meta-bar">
        <span> Duración: 90 minutos</span>
        <span> Unidad 4 - Persistencia de Datos</span>
        <span> 4 Semestre - Ingeniería Informática</span>
    </div>

    <nav class="nav">
        <a href="#teoria">Teoría</a>
        <a href="#ejemplos">Ejemplos</a>
        <a href="#practica">Práctica / Laboratorio</a>
        <a href="#ejercicios">Ejercicios</a>
        <a href="#referencias">Referencias</a>
    </nav>

    <main class="container" id="main">
        <!-- Teoría -->
        <section id="teoria">
        <!-- Objetivos -->
        <section id="objetivos" class="section">
            <h2>Objetivos de la Clase</h2>
            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Objetivo</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td><strong>Comprender</strong> la arquitectura de ADOPython</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td><strong>Configurar</strong> la cadena de conexión a SQL Server</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td><strong>Implementar</strong> operaciones CRUD con ADOPython</td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td><strong>Utilizar</strong> pyodbc, cursor.execute() y cursores</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td><strong>Aplicar</strong> buenas prácticas de manejo de conexiones</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Agenda -->
        <section id="agenda" class="section">
            <h2>Agenda (90 min)</h2>
            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>Tiempo</th>
                        <th>Tema</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>10'</td>
                        <td> Qué es ADOPython?</td>
                    </tr>
                    <tr>
                        <td>15'</td>
                        <td>Arquitectura y componentes</td>
                    </tr>
                    <tr>
                        <td>15'</td>
                        <td>Conexión a SQL Server</td>
                    </tr>
                    <tr>
                        <td>25'</td>
                        <td>Operaciones CRUD</td>
                    </tr>
                    <tr>
                        <td>15'</td>
                        <td>Manejo de transacciones</td>
                    </tr>
                    <tr>
                        <td>10'</td>
                        <td>Buenas prácticas</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Que es ADOPython -->
        <section id="que-es" class="section">
            <h2>1. Qué es ADOPython?</h2>

            <div class="note-box">
                <strong>¿Por qué aprender ADOPython?</strong>
                <ul>
                    <li><strong>Control total:</strong> Escribe SQL exacto para máximo rendimiento en queries complejas</li>
                    <li><strong>Comprensión profunda:</strong> Entender cómo funciona el acceso a datos bajo el capó</li>
                    <li><strong>Stored Procedures:</strong> ADOPython es ideal para trabajar con procedimientos almacenados</li>
                    <li><strong>Fundamento:</strong> Entity Framework y otros ORMs se construyen sobre ADOPython</li>
                </ul>
            </div>

            <h3>Acceso a datos en Python</h3>
            <p><strong><abbr title="ADOPython - ActiveX Data Objects for Python, tecnología de acceso a datos de Microsoft">ADOPython</abbr></strong> es un conjunto de clases que permite a las aplicaciones Python acceder a fuentes de datos como SQL Server, Oracle, MySQL, PostgreSQL, SQLite, archivos XML, entre otros.</p>

            <h4>Características principales:</h4>
            <div class="badge-list">
                <span class="badge badge-blue"><abbr title="DataReader - Lector de datos en modo conectado, solo lectura y solo avance">DataReader</abbr> (modo conectado)</span>
                <span class="badge badge-green"><abbr title="DataSet - Conjunto de datos en memoria que funciona en modo desconectado">DataSet</abbr> (modo desconectado)</span>
                <span class="badge badge-purple">Proveedores de datos</span>
                <span class="badge badge-red">Alto rendimiento</span>
            </div>

            <div class="warning-box">
                <strong>Modo Conectado vs Desconectado</strong>
                <ul>
                    <li><strong>Conectado (DataReader):</strong> La conexión permanece abierta mientras lees datos. Más rápido, pero bloquea la conexión.</li>
                    <li><strong>Desconectado (DataSet):</strong> Los datos se cargan en memoria y la conexión se cierra. Puedes modificar datos y sincronizar después.</li>
                </ul>
            </div>

            <h4>Proveedores de datos (Data Providers):</h4>
            <p><strong>Data Provider</strong> = Conjunto de clases específicas para un motor de base de datos (SqlConnection para SQL Server, OracleConnection para Oracle, etc.)</p>
            <ul>
                <li><strong>SqlClient:</strong> SQL Server</li>
                <li><strong>OracleClient:</strong> Oracle</li>
                <li><strong>MySql.Data:</strong> MySQL</li>
                <li><strong>Npgsql:</strong> PostgreSQL</li>
            </ul>

            <h3>ADOPython vs Entity Framework</h3>
            <table class="tag-table">
                <thead>
                    <tr>
                        <th>Característica</th>
                        <th>ADOPython</th>
                        <th>EF Core</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Nivel</td>
                        <td>Bajo nivel</td>
                        <td>Alto nivel</td>
                    </tr>
                    <tr>
                        <td>Cuando usar</td>
                        <td>Queries complejas, Stored procedures, Control total del SQL</td>
                        <td>CRUD estándar, Mapeo O/R simple, Productividad</td>
                    </tr>
                    <tr>
                        <td>Ventajas</td>
                        <td>Máximo control, Máximo rendimiento, Flexibilidad SQL</td>
                        <td>Menos código, Más mantenible, Strong typing</td>
                    </tr>
                    <tr>
                        <td>Desventajas</td>
                        <td>Más código, Más propenso a errores</td>
                        <td>Menos control, Overhead</td>
                    </tr>
                </tbody>
            </table>

            <p><em>En este curso: Ambos (ADOPython primero, luego EF)</em></p>
        </section>

        <!-- Arquitectura -->
        <section id="arquitectura" class="section">
            <h2>2. Arquitectura ADOPython</h2>

            <h3>Componentes principales</h3>
            <figure class="figure-container">
                <object data="../assets/infografias/clase-12-pyodbc-arquitectura.svg" type="image/svg+xml" style="max-width: 100%; height: auto; border-radius: 8px;">
                <img src="../assets/infografias/clase-12-pyodbc-arquitectura.svg" alt="Arquitectura pyodbc y SQL Server" />
        </object>
                <figcaption>Arquitectura pyodbc + SQL Server: pyodbc actúa como puente entre Python y SQL Server mediante ODBC. Modo conectado (cursor) para streaming eficiente de datos, modo desconectado (fetchall) para trabajar con datos en memoria. La connection string configura el driver, servidor y base de datos.</figcaption>
            </figure>

            <h4>Proveedor de datos (pyodbc)</h4>
            <ul>
                <li><strong>pyodbc.connect():</strong> Crea una conexión a SQL Server usando ODBC. Maneja apertura, cierre y la <strong>connection string</strong> (cadena con servidor, base de datos, credenciales).</li>
                <li><strong>cursor.execute():</strong> Ejecuta una query SQL o stored procedure usando un cursor. Maneja parámetros y devuelve resultados.</li>
            </ul>

            <h4>Objetos de datos</h4>
            <ul>
                <li><strong>Cursor pyodbc:</strong> Lee filas de una consulta una por una (forward-only) con <code>fetchone()</code> o todas con <code>fetchall()</code>. No permite modificar datos y requiere conexión abierta.</li>
                <li><strong>DataSet:</strong> Contiene una colección de DataTables en memoria. Funciona en modo desconectado (no necesita conexión abierta).</li>
            </ul>

            <div class="note-box">
                <strong>Mini-Chequeo: Arquitectura ADOPython</strong>
                <ul>
                    <li>¿Qué diferencia hay entre modo conectado y desconectado?</li>
                    <li>¿Cuándo usarías DataReader vs DataSet?</li>
                    <li>¿Qué es un Data Provider?</li>
                </ul>
            </div>

            <h3>Namespaces y Paquetes</h3>
            <p><strong>pip</strong> = Gestor de paquetes de Python. Permite agregar bibliotecas externas a tu proyecto.</p>
            <p><strong><abbr title="LocalDB - Versión ligera de SQL Server Express para desarrollo">LocalDB</abbr></strong> = Versión de SQL Server que se ejecuta bajo demanda, ideal para desarrollo.</p>
            <p><strong>Módulos</strong> = Forma de organizar código en Python mediante archivos <code>.py</code> y paquetes con <code>__init__.py</code>.</p>

            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">requirements.txt</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10</div>
                    <pre><code><span class="token-comment"># Instalación vía pip</span>
pip install pyodbc

<span class="token-comment"># O usando requirements.txt</span>
<span class="token-comment"># pyodbc>=4.0.39</span>

<span class="token-comment"># Importaciones en Python</span>
<span class="token-keyword">import</span> pyodbc                    <span class="token-comment"># Driver ODBC para SQL Server</span>
<span class="token-keyword">from</span> dataclasses <span class="token-keyword">import</span> dataclass  <span class="token-comment"># Para modelos de datos</span>
<span class="token-keyword">from</span> typing <span class="token-keyword">import</span> Optional, List  <span class="token-comment"># Type hints</span></code></pre>
                </div>
            </div>
        </section>

        <!-- Conexion -->
        <section id="conexion" class="section">
            <h2>3. Connection String</h2>

            <div class="note-box">
                <strong>¿Por qué Connection String en appsettings.json?</strong>
                <ul>
                    <li><strong>Separación de configuración:</strong> Cambia sin recompilar el código</li>
                    <li><strong>Seguridad:</strong> No guardas credenciales en el código fuente</li>
                    <li><strong>Ambientes:</strong> Distintos archivos para Development, Production, Testing</li>
                </ul>
            </div>

            <h3>Configuración de conexión</h3>
            <p><strong>Connection String</strong> = Cadena de texto con información para conectarse a una base de datos (servidor, nombre de BD, credenciales, opciones).</p>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">config.py</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26</div>
                    <pre><code><span class="token-comment"># Opción 1: Variables de entorno (RECOMENDADO)</span>
<span class="token-keyword">import</span> os

CONNECTION_STRING = os.getenv(
    <span class="token-string">"DATABASE_URL"</span>,
    <span class="token-string">"DRIVER={ODBC Driver 17 for SQL Server};"
    "SERVER=localhost;"
    "DATABASE=UniversidadDB;"
    "Trusted_Connection=yes;"</span>
)

<span class="token-comment"># ─────────────────────────────────────────────────────────────</span>

<span class="token-comment"># Opción 2: Configuración por ambiente (.env)</span>
<span class="token-keyword">from</span> dataclasses <span class="token-keyword">import</span> dataclass

<span class="token-keyword">@dataclass</span>
<span class="token-keyword">class</span> <span class="token-type">DatabaseConfig</span>:
    driver: <span class="token-type">str</span> = <span class="token-string">"ODBC Driver 17 for SQL Server"</span>
    server: <span class="token-type">str</span> = <span class="token-string">"localhost"</span>
    database: <span class="token-type">str</span> = <span class="token-string">"UniversidadDB"</span>
    timeout: <span class="token-type">int</span> = <span class="token-number">30</span>
    
    <span class="token-keyword">def</span> <span class="token-method">to_connection_string</span>(<span class="token-keyword">self</span>) <span class="token-operator">-></span> <span class="token-type">str</span>:
        <span class="token-keyword">return</span> (<span class="token-string">f"DRIVER={</span><span class="token-keyword">self</span>.driver<span class="token-string">};"</span>
                <span class="token-string">f"SERVER={</span><span class="token-keyword">self</span>.server<span class="token-string">};"</span>
                <span class="token-string">f"DATABASE={</span><span class="token-keyword">self</span>.database<span class="token-string">};"</span>
                <span class="token-string">f"Connect Timeout={</span><span class="token-keyword">self</span>.timeout<span class="token-string">}"</span>)</code></pre>
                </div>
            </div>

            <h3>Usando pyodbc</h3>
            <p><strong>with statement</strong> = Garantiza que los recursos (conexiones, cursores, etc.) se liberen correctamente, incluso si ocurre una excepción. Es equivalente a try-finally con close().</p>

            <div class="warning-box">
                <strong>Errores Comunes sin using</strong>
                <ul>
                    <li><strong>Connection leaks:</strong> Conexiones que nunca se cierran agotan el pool</li>
                    <li><strong>Rendimiento degradado:</strong> El servidor se sobrecarga con conexiones abandonadas</li>
                    <li><strong>Errores de timeout:</strong> "Connection pool exhausted" cuando se agotan las conexiones</li>
                </ul>
            </div>

            <p><strong><abbr title="Repository - Patrón de diseño que abstrae el acceso a datos (encapsula pyodbc)">Repository</abbr></strong> = Clase que encapsula toda la lógica de acceso a datos. Separa la lógica de negocio del código SQL.</p>

            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">estudiante_repository.py</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43</div>
                    <pre><code><span class="token-keyword">import</span> pyodbc
<span class="token-keyword">from</span> typing <span class="token-keyword">import</span> List, Optional

<span class="token-keyword">class</span> <span class="token-class">EstudianteRepository</span>:
    <span class="token-keyword">def</span> <span class="token-method">__init__</span>(<span class="token-keyword">self</span>, connection_string: <span class="token-type">str</span>):
        <span class="token-keyword">self</span>._connection_string = connection_string

    <span class="token-keyword">def</span> <span class="token-method">obtener_todos</span>(<span class="token-keyword">self</span>) <span class="token-operator">-></span> List[<span class="token-type">Estudiante</span>]:
        estudiantes: List[<span class="token-type">Estudiante</span>] = []

        <span class="token-comment"># SIEMPRE usar 'with' para garantizar cierre de conexión</span>
        <span class="token-keyword">with</span> pyodbc.<span class="token-method">connect</span>(<span class="token-keyword">self</span>._connection_string) <span class="token-keyword">as</span> connection:
            query = <span class="token-string">"SELECT Id, Codigo, Nombre, Email FROM Estudiantes"</span>

            <span class="token-keyword">with</span> connection.<span class="token-method">cursor</span>() <span class="token-keyword">as</span> cursor:
                cursor.<span class="token-method">execute</span>(query)

                <span class="token-comment"># Iterar sobre el cursor (forward-only)</span>
                <span class="token-keyword">for</span> row <span class="token-keyword">in</span> cursor:
                    estudiantes.<span class="token-method">append</span>(<span class="token-type">Estudiante</span>(
                        <span class="token-property">id</span>=row[<span class="token-number">0</span>],
                        <span class="token-property">codigo</span>=row[<span class="token-number">1</span>],
                        <span class="token-property">nombre</span>=row[<span class="token-number">2</span>],
                        <span class="token-property">email</span>=row[<span class="token-number">3</span>] <span class="token-keyword">if</span> row[<span class="token-number">3</span>] <span class="token-keyword">is not None</span> <span class="token-keyword">else</span> <span class="token-keyword">None</span>
                    ))

            <span class="token-comment"># La conexión se cierra automáticamente al salir del with</span>

        <span class="token-keyword">return</span> estudiantes</code></pre>
                </div>
            </div>

            <h3>Cursor de pyodbc - Lectura de datos</h3>
            <p><strong>None</strong> = En Python, el valor <code>None</code> se convierte automáticamente a NULL en la base de datos. Se verifica con <code>is None</code> o <code>is not None</code>.</p>

            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">cursor_methods.py</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22</div>
                    <pre><code><span class="token-comment"># Métodos del cursor de pyodbc</span>

<span class="token-comment"># Por índice (posición) - row es una tupla</span>
<span class="token-keyword">for</span> row <span class="token-keyword">in</span> cursor:
    id: <span class="token-type">int</span> = row[<span class="token-number">0</span>]
    nombre: <span class="token-type">str</span> = row[<span class="token-number">1</span>]

<span class="token-comment"># Usando fetchall() para obtener todas las filas</span>
rows = cursor.<span class="token-method">fetchall</span>()
<span class="token-keyword">for</span> row <span class="token-keyword">in</span> rows:
    email: <span class="token-type">str</span> = row[<span class="token-number">2</span>]

<span class="token-comment"># Verificar NULL (None en Python)</span>
<span class="token-keyword">for</span> row <span class="token-keyword">in</span> cursor:
    <span class="token-keyword">if</span> row[<span class="token-number">3</span>] <span class="token-keyword">is not None</span>:
        email = row[<span class="token-number">3</span>]

<span class="token-comment"># Acceso por nombre de columna (usando description)</span>
columns = [desc[<span class="token-number">0</span>] <span class="token-keyword">for</span> desc <span class="token-keyword">in</span> cursor.<span class="token-property">description</span>]
<span class="token-keyword">for</span> row <span class="token-keyword">in</span> cursor:
    row_dict = <span class="token-method">dict</span>(<span class="token-method">zip</span>(columns, row))
    id = row_dict[<span class="token-string">"Id"</span>]
    nombre = row_dict[<span class="token-string">"Nombre"</span>]

<span class="token-comment"># Tipos disponibles: se convierten automáticamente</span>
<span class="token-comment"># int, str, float, datetime, Decimal, bytes, bool</span></code></pre>
                </div>
            </div>
        </section>

        <!-- CRUD -->
        <section id="crud" class="section">
            <h2>4. Operaciones <abbr title="CRUD - Create, Read, Update, Delete (Crear, Leer, Actualizar, Eliminar)">CRUD</abbr></h2>

            <h3>Create (INSERT)</h3>
            <p><strong><abbr title="SCOPE_IDENTITY() - Función de SQL Server que retorna el último valor de identidad generado en la sesión actual">SCOPE_IDENTITY()</abbr></strong> = Función de SQL Server que retorna el último ID auto-generado en la sesión actual (evita conflictos con otras transacciones simultáneas).</p>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">create_operation.py</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24</div>
                    <pre><code><span class="token-keyword">import</span> pyodbc
<span class="token-keyword">from</span> datetime <span class="token-keyword">import</span> datetime
<span class="token-keyword">from</span> typing <span class="token-keyword">import</span> Optional

<span class="token-keyword">def</span> <span class="token-method">crear</span>(<span class="token-keyword">self</span>, estudiante: <span class="token-type">Estudiante</span>) <span class="token-operator">-></span> <span class="token-type">int</span>:
    <span class="token-keyword">with</span> pyodbc.<span class="token-method">connect</span>(<span class="token-keyword">self</span>._connection_string) <span class="token-keyword">as</span> connection:
        query = <span class="token-string">"""
            INSERT INTO Estudiantes (Codigo, Nombre, Email, FechaRegistro)
            VALUES (?, ?, ?, ?);
            SELECT SCOPE_IDENTITY();"""</span>  <span class="token-comment"># Retorna el ID generado</span>

        <span class="token-keyword">with</span> connection.<span class="token-method">cursor</span>() <span class="token-keyword">as</span> cursor:
            <span class="token-comment"># Agregar parámetros con ? (EVITA SQL INJECTION)</span>
            params = (
                estudiante.codigo,
                estudiante.nombre,
                estudiante.email,  <span class="token-comment"># None se convierte a NULL</span>
                datetime.<span class="token-method">now</span>()
            )

            cursor.<span class="token-method">execute</span>(query, params)

            <span class="token-comment"># fetchone para retornar un solo valor (el ID)</span>
            row = cursor.<span class="token-method">fetchone</span>()
            id_generado = <span class="token-method">int</span>(row[<span class="token-number">0</span>]) <span class="token-keyword">if</span> row <span class="token-keyword">else</span> <span class="token-number">0</span>

        connection.<span class="token-method">commit</span>()  <span class="token-comment"># Confirmar la transacción</span>
        <span class="token-keyword">return</span> id_generado</code></pre>
                </div>
            </div>

            <h3>Read (SELECT)</h3>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">read_operation.py</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38</div>
                    <pre><code><span class="token-keyword">import</span> pyodbc
<span class="token-keyword">from</span> typing <span class="token-keyword">import</span> Optional

<span class="token-keyword">def</span> <span class="token-method">obtener_por_id</span>(<span class="token-keyword">self</span>, id: <span class="token-type">int</span>) <span class="token-operator">-></span> Optional[<span class="token-type">Estudiante</span>]:
    <span class="token-keyword">with</span> pyodbc.<span class="token-method">connect</span>(<span class="token-keyword">self</span>._connection_string) <span class="token-keyword">as</span> connection:
        query = <span class="token-string">"SELECT Id, Codigo, Nombre, Email FROM Estudiantes WHERE Id = ?"</span>

        <span class="token-keyword">with</span> connection.<span class="token-method">cursor</span>() <span class="token-keyword">as</span> cursor:
            cursor.<span class="token-method">execute</span>(query, (id,))
            row = cursor.<span class="token-method">fetchone</span>()

            <span class="token-keyword">if</span> row:
                <span class="token-keyword">return</span> <span class="token-type">Estudiante</span>(
                    <span class="token-property">id</span>=row[<span class="token-number">0</span>],
                    <span class="token-property">codigo</span>=row[<span class="token-number">1</span>],
                    <span class="token-property">nombre</span>=row[<span class="token-number">2</span>],
                    <span class="token-property">email</span>=row[<span class="token-number">3</span>] <span class="token-keyword">if</span> row[<span class="token-number">3</span>] <span class="token-keyword">is not None</span> <span class="token-keyword">else</span> <span class="token-keyword">None</span>
                )

    <span class="token-keyword">return</span> <span class="token-keyword">None</span>  <span class="token-comment"># No encontrado</span>

<span class="token-keyword">def</span> <span class="token-method">_map_from_row</span>(<span class="token-keyword">self</span>, row) <span class="token-operator">-></span> <span class="token-type">Estudiante</span>:
    <span class="token-string">"""Mapea una fila del cursor a un objeto Estudiante"""</span>
    <span class="token-keyword">return</span> <span class="token-type">Estudiante</span>(
        <span class="token-property">id</span>=row[<span class="token-number">0</span>],
        <span class="token-property">codigo</span>=row[<span class="token-number">1</span>],
        <span class="token-property">nombre</span>=row[<span class="token-number">2</span>],
        <span class="token-property">email</span>=row[<span class="token-number">3</span>] <span class="token-keyword">if</span> row[<span class="token-number">3</span>] <span class="token-keyword">is not None</span> <span class="token-keyword">else</span> <span class="token-keyword">None</span>
    )</code></pre>
                </div>
            </div>

            <h3>Update (UPDATE)</h3>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">update_operation.py</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24</div>
                    <pre><code><span class="token-keyword">import</span> pyodbc

<span class="token-keyword">def</span> <span class="token-method">actualizar</span>(<span class="token-keyword">self</span>, estudiante: <span class="token-type">Estudiante</span>) <span class="token-operator">-></span> <span class="token-type">bool</span>:
    <span class="token-keyword">with</span> pyodbc.<span class="token-method">connect</span>(<span class="token-keyword">self</span>._connection_string) <span class="token-keyword">as</span> connection:
        query = <span class="token-string">"""
            UPDATE Estudiantes
            SET Codigo = ?,
                Nombre = ?,
                Email = ?
            WHERE Id = ?"""</span>

        <span class="token-keyword">with</span> connection.<span class="token-method">cursor</span>() <span class="token-keyword">as</span> cursor:
            params = (
                estudiante.codigo,
                estudiante.nombre,
                estudiante.email,  <span class="token-comment"># None se convierte a NULL</span>
                estudiante.id
            )
            cursor.<span class="token-method">execute</span>(query, params)

            <span class="token-comment"># rowcount retorna número de filas afectadas</span>
            filas_afectadas = cursor.<span class="token-property">rowcount</span>

        connection.<span class="token-method">commit</span>()  <span class="token-comment"># Confirmar cambios</span>
        <span class="token-keyword">return</span> filas_afectadas > <span class="token-number">0</span>  <span class="token-comment"># True si se actualizó</span></code></pre>
                </div>
            </div>

            <h3>Delete (DELETE)</h3>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">delete_operation.py</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32</div>
                    <pre><code><span class="token-keyword">import</span> pyodbc
<span class="token-keyword">from</span> datetime <span class="token-keyword">import</span> datetime

<span class="token-keyword">def</span> <span class="token-method">eliminar</span>(<span class="token-keyword">self</span>, id: <span class="token-type">int</span>) <span class="token-operator">-></span> <span class="token-type">bool</span>:
    <span class="token-keyword">with</span> pyodbc.<span class="token-method">connect</span>(<span class="token-keyword">self</span>._connection_string) <span class="token-keyword">as</span> connection:
        query = <span class="token-string">"DELETE FROM Estudiantes WHERE Id = ?"</span>

        <span class="token-keyword">with</span> connection.<span class="token-method">cursor</span>() <span class="token-keyword">as</span> cursor:
            cursor.<span class="token-method">execute</span>(query, (id,))
            filas_afectadas = cursor.<span class="token-property">rowcount</span>

        connection.<span class="token-method">commit</span>()
        <span class="token-keyword">return</span> filas_afectadas > <span class="token-number">0</span>

<span class="token-comment"># Alternativa: Eliminación lógica (más segura)</span>
<span class="token-keyword">def</span> <span class="token-method">desactivar</span>(<span class="token-keyword">self</span>, id: <span class="token-type">int</span>) <span class="token-operator">-></span> <span class="token-type">bool</span>:
    <span class="token-keyword">with</span> pyodbc.<span class="token-method">connect</span>(<span class="token-keyword">self</span>._connection_string) <span class="token-keyword">as</span> connection:
        query = <span class="token-string">"""
            UPDATE Estudiantes
            SET Activo = 0, FechaEliminacion = ?
            WHERE Id = ?"""</span>

        <span class="token-keyword">with</span> connection.<span class="token-method">cursor</span>() <span class="token-keyword">as</span> cursor:
            cursor.<span class="token-method">execute</span>(query, (datetime.<span class="token-method">now</span>(), id))
            resultado = cursor.<span class="token-property">rowcount</span> > <span class="token-number">0</span>

        connection.<span class="token-method">commit</span>()
        <span class="token-keyword">return</span> resultado</code></pre>
                </div>
            </div>

            <h3>Métodos de Ejecución</h3>
            <table class="tag-table">
                <thead>
                    <tr>
                        <th>Método</th>
                        <th>Retorna</th>
                        <th>Uso</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>cursor.fetchall()</strong></td>
                        <td>Lista de tuplas</td>
                        <td>SELECT (múltiples filas)</td>
                    </tr>
                    <tr>
                        <td><strong>cursor.fetchone()</strong></td>
                        <td>Tupla / None</td>
                        <td>SELECT COUNT(*), SUM(), MAX(), SCOPE_IDENTITY()</td>
                    </tr>
                    <tr>
                        <td><strong>cursor.rowcount</strong></td>
                        <td>int</td>
                        <td>INSERT, UPDATE, DELETE, CREATE TABLE</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Transacciones -->
        <section id="transacciones" class="section">
            <h2>5. Manejo de Transacciones</h2>

            <div class="note-box">
                <strong>¿Por qué Transacciones?</strong>
                <ul>
                    <li><strong>Atomicidad:</strong> O todas las operaciones se completan, o ninguna</li>
                    <li><strong>Consistencia:</strong> Los datos siempre remaincen en un estado válido</li>
                    <li><strong>Ejemplo:</strong> Transferencia bancaria: DEBITAR origen Y ACREDITAR destino, o ninguna de las dos</li>
                </ul>
            </div>

            <h3>Transacciones en ADOPython</h3>
            <p><strong><abbr title="Transaction - Unidad de trabajo compuesta por múltiples operaciones que deben ejecutarse todas o ninguna">Transaction</abbr></strong> = Unidad de trabajo compuesta por múltiples operaciones SQL que deben ejecutarse todas o ninguna (ACID).</p>
            <p><strong>Commit</strong> = Confirmar la transacción (aplicar todos los cambios permanentemente).</p>
            <p><strong>Rollback</strong> = Deshacer la transacción (revertir todos los cambios si algo falla).</p>
            <p><strong>async/await</strong> = Palabras clave de Python para programación asíncrona. async marca un método como asíncrono, await espera un resultado sin bloquear el hilo.</p>

            <div class="warning-box">
                <strong>Errores Comunes con Transacciones</strong>
                <ul>
                    <li><strong>Olvidar usar el mismo cursor/connection en la transacción:</strong> Los comandos deben ejecutarse dentro del contexto de la transacción</li>
                    <li><strong>No llamar Commit():</strong> La transacción se deshace automáticamente (rollback implícito)</li>
                    <li><strong>Excepciones no manejadas:</strong> Siempre envolver en try-catch para llamar Rollback()</li>
                </ul>
            </div>

            <h4>Consistencia de datos</h4>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">transaction_example.py</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49</div>
                    <pre><code><span class="token-keyword">import</span> pyodbc
<span class="token-keyword">from</span> datetime <span class="token-keyword">import</span> datetime
<span class="token-keyword">import</span> logging

logger = logging.<span class="token-method">getLogger</span>(<span class="token-string">"estudiante_repository"</span>)

<span class="token-keyword">def</span> <span class="token-method">transferir_estudiante</span>(<span class="token-keyword">self</span>, 
    estudiante_id: <span class="token-type">int</span>, carrera_origen_id: <span class="token-type">int</span>, carrera_destino_id: <span class="token-type">int</span>) <span class="token-operator">-></span> <span class="token-type">bool</span>:
    
    <span class="token-keyword">with</span> pyodbc.<span class="token-method">connect</span>(<span class="token-keyword">self</span>._connection_string) <span class="token-keyword">as</span> connection:
        <span class="token-comment"># Iniciar transacción</span>
        transaction = connection.<span class="token-method">cursor</span>()
        
        <span class="token-keyword">try</span>:
            <span class="token-comment"># 1. Registrar historial de transferencia</span>
            query1 = <span class="token-string">"""INSERT INTO HistorialTransferencias
                           (EstudianteId, CarreraOrigenId, CarreraDestinoId, Fecha)
                           VALUES (?, ?, ?, ?)"""</span>
            
            transaction.<span class="token-method">execute</span>(query1, 
                (estudiante_id, carrera_origen_id, carrera_destino_id, datetime.<span class="token-method">now</span>()))

            <span class="token-comment"># 2. Actualizar carrera del estudiante</span>
            query2 = <span class="token-string">"""UPDATE Estudiantes
                           SET CarreraId = ?
                           WHERE Id = ?"""</span>
            
            transaction.<span class="token-method">execute</span>(query2, (carrera_destino_id, estudiante_id))

            <span class="token-comment"># Si todo va bien, confirmar transacción</span>
            connection.<span class="token-method">commit</span>()
            <span class="token-keyword">return</span> <span class="token-keyword">True</span>
            
        <span class="token-keyword">except</span> <span class="token-type">Exception</span> <span class="token-keyword">as</span> ex:
            <span class="token-comment"># Si hay error, deshacer todo</span>
            connection.<span class="token-method">rollback</span>()
            logger.<span class="token-method">error</span>(<span class="token-string">f"Error en transferencia: {ex}"</span>)
            <span class="token-keyword">return</span> <span class="token-keyword">False</span>
        <span class="token-keyword">finally</span>:
            transaction.<span class="token-method">close</span>()</code></pre>
                </div>
            </div>
        </section>

        <!-- Buenas Practicas -->
        <section id="buenas-practicas" class="section">
            <h2>6. Buenas Prácticas</h2>

            <div class="checklist-box">
                <strong>✅ SIEMPRE USAR USING</strong>
                <ul>
                    <li>pyodbc.connect(), cursor.execute(), cursor.fetchall()</li>
                    <li>Garantiza liberación de recursos</li>
                </ul>
            </div>

            <div class="warning-box">
                <strong>❌ NUNCA concatenar strings para SQL</strong>
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-dots">
                            <span class="code-dot red"></span>
                            <span class="code-dot yellow"></span>
                            <span class="code-dot green"></span>
                        </div>
                        <span class="code-title">sql_injection_warning.py</span>
                    </div>
                    <div class="code-content">
                        <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6</div>
                        <pre><code><span class="token-comment"># VULNERABLE A SQL INJECTION</span>
sql = <span class="token-string">f"SELECT * FROM Users WHERE Id = {id}"</span>

<span class="token-comment"># SEGURO CON PARÁMETROS</span>
cursor.<span class="token-method">execute</span>(<span class="token-string">"SELECT * FROM Users WHERE Id = ?"</span>, (id,))</code></pre>
                    </div>
                </div>
            </div>

            <div class="checklist-box">
                <strong>✅ CERRAR CONEXIONES RÁPIDO</strong>
                <ul>
                    <li>Abrir justo antes de usar</li>
                    <li>Cerrar inmediatamente después</li>
                    <li>NO mantener conexiones abiertas</li>
                </ul>
            </div>

            <div class="checklist-box">
                <strong>✅ USAR ASYNC/AWAIT</strong>
                <ul>
                    <li>ExecuteReaderAsync(), ExecuteNonQueryAsync()</li>
                    <li>Mejor rendimiento en aplicaciones web</li>
                </ul>
            </div>

            <div class="checklist-box">
                <strong>✅ MANEJAR NULLS</strong>
                <ul>
                    <li>Usar DBNull.Value para valores nulos</li>
                    <li>Verificar IsDBNull() al leer</li>
                </ul>
            </div>

            <div class="checklist-box">
                <strong>✅ USAR TRANSACCIONES</strong>
                <ul>
                    <li>Para operaciones múltiples relacionadas</li>
                    <li>Mantiene consistencia de datos</li>
                </ul>
            </div>

            <h3>Connection Pooling</h3>
            <p><strong><abbr title="Connection Pooling - Mecanismo que reutiliza conexiones físicas existentes en lugar de crear nuevas">Connection Pooling</abbr></strong> = Reutilización automática de conexiones físicas para mejorar rendimiento. En lugar de abrir/cerrar conexiones reales, ADOPython mantiene un "pool" de conexiones disponibles.</p>
            <p><strong>¿Por qué Connection Pooling?</strong> Abrir una conexión física es costoso (miles de milisegundos). Reutilizar conexiones existentes toma microsegundos.</p>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">ConnectionPooling.config</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10</div>
                    <pre><code><span class="token-comment">// Connection Pool está activado por defecto</span>
<span class="token-comment">// Configuración en connection string:</span>

<span class="token-string">"Server=localhost;Database=UniversidadDB;Integrated Security=true;
Connection Lifetime=60;              // Tiempo vida conexión (seg)
Max Pool Size=100;                   // Máximo conexiones
Min Pool Size=5;                     // Mínimo conexiones
Pooling=true;                        // Activar (default)
Connection Reset=true;               // Reset al devolver al pool
Connection Timeout=15;"</span>              <span class="token-comment">// Timeout conexión (seg)</span></code></pre>
                </div>
            </div>
        </section>

        <!-- SQL Injection -->
        <section id="sql-injection" class="section">
            <h2>7. SQL Injection</h2>

            <div class="note-box">
                <strong>¿Por qué SQL Injection es peligroso?</strong>
                <ul>
                    <li><strong>Robo de datos:</strong> Atacante puede leer toda la base de datos</li>
                    <li><strong>Destrucción:</strong> DROP TABLE elimina datos permanentemente</li>
                    <li><strong>Bypass autenticación:</strong> Login sin contraseña válida</li>
                    <li><strong>OWASP #1:</strong> Consistentemente #1 vulnerabilidad web más crítica</li>
                </ul>
            </div>

            <h3>¿Qué es SQL Injection?</h3>
            <p><strong><abbr title="SQL Injection - Vulnerabilidad que permite inyectar código SQL malicioso manipulando la entrada del usuario">SQL Injection</abbr></strong> = Ataque donde un usuario malintencionado inyecta código SQL manipulando los inputs de la aplicación.</p>

            <h4>El peligro de concatenar strings</h4>
            <div class="warning-box">
                <strong>⚠️ VULNERABLE A SQL INJECTION</strong>
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-dots">
                            <span class="code-dot red"></span>
                            <span class="code-dot yellow"></span>
                            <span class="code-dot green"></span>
                        </div>
                        <span class="code-title">sql_injection_vulnerable.py</span>
                    </div>
                    <div class="code-content">
                        <div class="line-numbers">1<br>2<br>3<br>4<br>5</div>
                        <pre><code>query = <span class="token-string">f"SELECT * FROM Estudiantes WHERE Codigo = '{codigo}'"</span>
<span class="token-comment"># Si codigo = "'; DROP TABLE Estudiantes; --"</span>
<span class="token-comment"># Query resultante: SELECT * FROM Estudiantes WHERE Codigo = '';</span>
<span class="token-comment">#                    DROP TABLE Estudiantes; --'</span>
<span class="token-comment">#  DESASTRE!</span></code></pre>
                    </div>
                </div>
            </div>

            <div class="checklist-box">
                <strong>✅ SEGURO CON PARÁMETROS</strong>
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-dots">
                            <span class="code-dot red"></span>
                            <span class="code-dot yellow"></span>
                            <span class="code-dot green"></span>
                        </div>
                        <span class="code-title">sql_injection_safe.py</span>
                    </div>
                    <div class="code-content">
                        <div class="line-numbers">1<br>2<br>3</div>
                        <pre><code>query = <span class="token-string">"SELECT * FROM Estudiantes WHERE Codigo = ?"</span>
cursor.<span class="token-method">execute</span>(query, (codigo,))
<span class="token-comment"># El parámetro se escapa automáticamente</span></code></pre>
                    </div>
                </div>
            </div>

            <div class="note-box">
                <strong>Mini-Chequeo: SQL Injection</strong>
                <ul>
                    <li>¿Por qué concatenar strings es vulnerable?</li>
                    <li>¿Cómo los parámetros previenen SQL Injection?</li>
                    <li>¿Puedes explicar el ataque con "'; DROP TABLE Estudiantes; --"?</li>
                </ul>
            </div>
        </section>
        </section>

        <!-- Ejemplos -->
        <section id="ejemplos" class="section">
            <h2>Ejemplos</h2>
            <p>Los ejemplos de código están integrados en las secciones teóricas anteriores. Consulte cada sección para ver ejemplos prácticos de:</p>
            <ul>
                <li>Conexión a bases de datos con pyodbc</li>
                <li>Operaciones CRUD con cursor.execute()</li>
                <li>Uso de cursores y fetchall/fetchone</li>
                <li>Implementación de transacciones</li>
                <li>Buenas prácticas de seguridad</li>
            </ul>
        </section>

        <!-- Práctica / Laboratorio -->
        <section id="practica" class="section actividad">
            <h3>Actividad: Repositorio ADOPython CRUD</h3>
            <p><strong>Tipo:</strong> Opcional / práctica</p>
            <p><strong>Relacionado con:</strong> Ninguno</p>
            <p><strong>Entregable:</strong> Repositorio ADOPython con operaciones CRUD para Estudiantes</p>
            <p><strong>Tiempo estimado:</strong> 40 min</p>
            <p><strong>Criterios de éxito:</strong> Comprensión de pyodbc.connect(), cursor.execute(), cursor.fetchall()</p>
            <h2>Práctica / Laboratorio</h2>
            <p><strong>Duración estimada:</strong> 40 minutos</p>
            <p><strong>Objetivo:</strong> Implementar un repositorio pyodbc completo con operaciones CRUD para Estudiantes.</p>

            <h3>Pasos en VS Code / Visual Studio Code</h3>
            <ol>
                <li>Abre VS Code / Visual Studio Code y crea un nuevo proyecto <strong>Console App</strong> con Python 8</li>
                <li>Instala el paquete: <code>pip install pyodbc</code></li>
                <li>En <code>config.py</code> o variables de entorno, configura la connection string para LocalDB</li>
                <li>Crea la base de datos con el script SQL provisto por el docente</li>
                <li>Implementa la clase <code>EstudianteRepository</code> con todos los métodos CRUD</li>
                <li>Usa <code>with</code> statements para conexiones pyodbc y cursores</li>
                <li>Usa parámetros en todas las queries para evitar SQL Injection</li>
                <li>Prueba cada método con datos de prueba en el Main</li>
            </ol>

            <h3>Checklist de verificación</h3>
            <ul>
                <li>✅ El proyecto compila sin errores</li>
                <li>✅ La connection string está configurada correctamente en appsettings.json</li>
                <li>✅ Todos los métodos usan <code>with</code> para conexiones y cursores</li>
                <li>✅ Todas las queries usan parámetros (@Nombre, @Codigo, etc.)</li>
                <li>✅ El método crear retorna el ID generado con SCOPE_IDENTITY()</li>
                <li>✅ El método obtener_por_id retorna None cuando no encuentra registros</li>
                <li>✅ Los métodos UPDATE y DELETE verifican filas afectadas (> 0)</li>
            </ul>

            <h3>Ejemplo de implementación</h3>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">estudiante_repository_example.py</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29</div>
                    <pre><code><span class="token-keyword">import</span> pyodbc
<span class="token-keyword">from</span> typing <span class="token-keyword">import</span> Optional

<span class="token-keyword">class</span> <span class="token-class">EstudianteRepository</span>:
    <span class="token-keyword">def</span> <span class="token-method">__init__</span>(<span class="token-keyword">self</span>, connection_string: <span class="token-type">str</span>):
        <span class="token-keyword">self</span>._connection_string = connection_string

    <span class="token-keyword">def</span> <span class="token-method">crear</span>(<span class="token-keyword">self</span>, estudiante: <span class="token-type">Estudiante</span>) <span class="token-operator">-></span> <span class="token-type">int</span>:
        <span class="token-keyword">with</span> pyodbc.<span class="token-method">connect</span>(<span class="token-keyword">self</span>._connection_string) <span class="token-keyword">as</span> connection:
            query = <span class="token-string">"""
                INSERT INTO Estudiantes (Codigo, Nombre, Email)
                VALUES (?, ?, ?);
                SELECT SCOPE_IDENTITY();"""</span>

            <span class="token-keyword">with</span> connection.<span class="token-method">cursor</span>() <span class="token-keyword">as</span> cursor:
                cursor.<span class="token-method">execute</span>(query, (
                    estudiante.codigo,
                    estudiante.nombre,
                    estudiante.email  <span class="token-comment"># None se convierte a NULL</span>
                ))

                row = cursor.<span class="token-method">fetchone</span>()
                id_generado = <span class="token-method">int</span>(row[<span class="token-number">0</span>]) <span class="token-keyword">if</span> row <span class="token-keyword">else</span> <span class="token-number">0</span>

            connection.<span class="token-method">commit</span>()
            <span class="token-keyword">return</span> id_generado</code></pre>
                </div>
            </div>

            <h3>Errores comunes a evitar</h3>
            <ul>
                <li>❌ No usar <code>with</code> para conexiones pyodbc (connection leaks)</li>
                <li>❌ Concatenar strings para armar queries (SQL Injection)</li>
                <li>❌ Olvidar llamar a Open() antes de ejecutar comandos</li>
                <li>❌ No usar async/await en aplicaciones web/consola modernas</li>
                <li>❌ No verificar <code>None</code> cuando leemos valores NULL de la DB</li>
            </ul>
        </section>

        <!-- Ejercicios -->
        <section id="ejercicios" class="section">
            <h2>Ejercicios Prácticos</h2>

            <h3>Ejercicio 1: CRUD Completo</h3>
            <p><strong>Duración estimada:</strong> 30 minutos</p>
            <p>Implementar las 4 operaciones CRUD para la entidad Estudiante.</p>
            <h4>Checklist:</h4>
            <ul>
                <li>✅ Create con parámetros y SCOPE_IDENTITY()</li>
                <li>✅ Read con cursor y with statements</li>
                <li>✅ Update verificando filas afectadas</li>
                <li>✅ Delete con parámetro @Id</li>
            </ul>

            <h3>Ejercicio 2: Transacciones</h3>
            <p><strong>Duración estimada:</strong> 20 minutos</p>
            <p>Implementar una transacción para transferir estudiante entre carreras.</p>
            <h4>Checklist:</h4>
            <ul>
                <li>✅ Usar BeginTransaction() antes de las operaciones</li>
                <li>✅ Commit() si todas las operaciones tienen éxito</li>
                <li>✅ Rollback() en el bloque catch si hay error</li>
                <li>✅ Ejecutar operaciones dentro del contexto de la transacción</li>
            </ul>

            <h3>Ejercicio Integrador: Repository de Estudiantes</h3>
            <p><strong>Duración estimada:</strong> 45 minutos</p>
            <p>Crear clase EstudianteRepository con métodos:</p>
            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Método</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td><code>Crear(Estudiante estudiante) : Task&lt;int&gt;</code> - Insertar nuevo estudiante, retornar ID generado</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td><code>ObtenerPorId(int id) : Task&lt;Estudiante&gt;</code> - Buscar por ID, retornar null si no existe</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td><code>ObtenerTodos() : Task&lt;List&lt;Estudiante&gt;&gt;</code> - Lista completa ordenada por nombre</td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td><code>Actualizar(Estudiante estudiante) : Task&lt;bool&gt;;</code> - Actualizar datos, retornar true si se actualizó</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td><code>Eliminar(int id) : Task&lt;bool&gt;;</code> - Eliminar físicamente</td>
                    </tr>
                    <tr>
                        <td>6</td>
                        <td><code>BuscarPorNombre(string término) : Task&lt;List&lt;Estudiante&gt;&gt;;</code> - Búsqueda parcial con LIKE</td>
                    </tr>
                </tbody>
            </table>

            <h4>REQUISITOS:</h4>
            <h4>Checklist:</h4>
            <ul>
                <li>✅ Usar parámetros en todas las queries</li>
                <li>✅ Usar async/await</li>
                <li>✅ Usar transacción en método crear_con_materias_iniciales</li>
            </ul>
        </section>

        <!-- Referencias -->
        <section id="referencias" class="section">
            <h2>Referencias y Recursos</h2>

            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>Recurso</th>
                        <th>Enlace</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>ADOPython Docs</td>
                        <td><a href="https://learn.microsoft.com/en-us/dotnet/framework/data/adonet/index" target="_blank">docs.microsoft.com/dotnet/framework/data/adonet</a></td>
                    </tr>
                    <tr>
                        <td>pyodbc API</td>
                        <td><a href="https://github.com/mkleehammer/pyodbc/wiki" target="_blank">github.com/mkleehammer/pyodbc/wiki</a></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Resumen -->
        <section id="resumen" class="section">
            <h2>Resumen de la Clase</h2>
            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>Concepto</th>
                        <th>Descripción</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>pyodbc.connect()</strong></td>
                        <td>Conexión a base de datos</td>
                    </tr>
                    <tr>
                        <td><strong>cursor.execute()</strong></td>
                        <td>Ejecutar SQL</td>
                    </tr>
                    <tr>
                        <td><strong>cursor.fetchall() / fetchone()</strong></td>
                        <td>Leer resultados (forward-only)</td>
                    </tr>
                    <tr>
                        <td><strong>fetchall() + for</strong></td>
                        <td>Para SELECT (múltiples filas)</td>
                    </tr>
                    <tr>
                        <td><strong>fetchone()[0]</strong></td>
                        <td>Para valor único (COUNT, etc.)</td>
                    </tr>
                    <tr>
                        <td><strong>cursor.rowcount</strong></td>
                        <td>Para INSERT, UPDATE, DELETE</td>
                    </tr>
                    <tr>
                        <td><strong>Parámetros (?, %s)</strong></td>
                        <td>Protección contra SQL Injection</td>
                    </tr>
                    <tr>
                        <td><strong>connection.commit() / rollback()</strong></td>
                        <td>Consistencia en operaciones múltiples</td>
                    </tr>
                    <tr>
                        <td><strong>Connection Pooling (ODBC)</strong></td>
                        <td>Reutilización de conexiones</td>
                    </tr>
                    <tr>
                        <td><strong>fetchall() + lista</strong></td>
                        <td>Modo desconectado (lista de tuplas)</td>
                    </tr>
                    <tr>
                        <td><strong>CALL / EXEC</strong></td>
                        <td>Procedimientos almacenados</td>
                    </tr>
                    <tr>
                        <td><strong>try / except</strong></td>
                        <td>Manejo de errores SQL</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Proxima Clase -->
        <section class="section">
            <h2>Próxima Clase: SQLAlchemy / ORM (ejemplo en Python)</h2>
            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>Tema</th>
                        <th>Descripción</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>EF Core</strong></td>
                        <td>DbContext y DbSet</td>
                    </tr>
                    <tr>
                        <td><strong>Code First</strong></td>
                        <td>Migrations</td>
                    </tr>
                    <tr>
                        <td><strong>LINQ to Entities</strong></td>
                        <td>Consultas LINQ, Eager Loading (Include)</td>
                    </tr>
                    <tr>
                        <td><strong>Relaciones</strong></td>
                        <td>One-to-Many, Many-to-Many</td>
                    </tr>
                    <tr>
                        <td><strong>Comparación</strong></td>
                        <td>ADOPython vs EF Core</td>
                    </tr>
                </tbody>
            </table>
        </section>
    </main>

    <section id='equivalencia-ado-net'>
  <h3>Equivalencia ADO.NET / Datos desconectados</h3>
  <ul>
    <li>Repositorios/servicios que serializan DTOs a JSON.</li>
    <li>Estado local (cache) en frontend y sincronización (offline-first / sync) con el servidor.</li>
    <li>Ejemplo: Python repositorios con pyodbc/SQLAlchemy + Angular cache + endpoints REST.</li>
  </ul>
</section><section id='entrega-git'>
  <h3>Entrega con Git</h3>
  <p>Branch: <code>feature/tema-clase-12</code></p>
  <ul>
    <li>Commits: setup / implementación / pruebas-docs</li>
  </ul>
  <p>Tag: <code>clase-12-v1</code></p>
</section><footer class="footer">
        <p><strong>"ADOPython: Control total sobre tus datos"</strong></p>
        <p>UNAULA - Ingeniería Informática - 2026-I</p>
        <p>IF0100 - Lenguaje de Programación Orientada a Objetos II</p>
    </footer>
</body>
</html>
