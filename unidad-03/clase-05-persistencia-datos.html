<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clase 12: Persistencia con SQLAlchemy | IF0100</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <style>
        :root { --primary: #0d6efd; --success: #198754; --warning: #ffc107; --danger: #dc3545; --info: #0dcaf0; }
        header { background: linear-gradient(135deg, var(--primary) 0%, #0a58ca 100%); color: white; padding: 2rem 0; }
        .sidebar { background: #f8f9fa; border-radius: 8px; padding: 1.5rem; position: sticky; top: 2rem; }
        section { margin-bottom: 2rem; padding: 1.5rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        pre[class*="language-"] { border-radius: 6px; }
        .alert-tip { background: #d1e7dd; border-left: 4px solid var(--success); padding: 1rem; border-radius: 4px; }
        .alert-warning { background: #fff3cd; border-left: 4px solid var(--warning); padding: 1rem; border-radius: 4px; }
        .alert-note { background: #e7f3ff; border-left: 4px solid var(--info); padding: 1rem; border-radius: 4px; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>IF0100 - Programaci√≥n OO II</h1>
            <h2>Unidad 3: Desarrollo Web con FastAPI</h2>
            <h3>Clase 12: Persistencia con SQLAlchemy</h3>
            <p class="mt-2"><span class="badge bg-success">E3: Proyecto Web - Entrega esta semana</span></p>
        </div>
    </header>

    <div class="container mt-4">
        <div class="row">
            <aside class="col-lg-3">
                <nav class="sidebar">
                    <h5>Contenido</h5>
                    <ul class="list-unstyled">
                        <li><a href="#objetivos" class="text-decoration-none">Objetivos</a></li>
                        <li><a href="#sqlalchemy" class="text-decoration-none">SQLAlchemy</a></li>
                        <li><a href="#modelos" class="text-decoration-none">Modelos ORM</a></li>
                        <li><a href="#crud" class="text-decoration-none">CRUD</a></li>
                        <li><a href="#fastapi" class="text-decoration-none">FastAPI + BD</a></li>
                        <li><a href="#ejercicio" class="text-decoration-none">Ejercicio</a></li>
                    </ul>
                </nav>
            </aside>

            <main class="col-lg-9">
                <section id="objetivos">
                    <h2 class="text-primary border-bottom pb-2">Objetivos de Aprendizaje</h2>
                    <ul>
                        <li>Conectar FastAPI con base de datos SQLite</li>
                        <li>Crear modelos con SQLAlchemy ORM</li>
                        <li>Implementar operaciones CRUD</li>
                        <li>Usar dependencias para sesiones de BD</li>
                    </ul>
                </section>

                <section id="sqlalchemy">
                    <h2 class="text-primary border-bottom pb-2">SQLAlchemy (10 min)</h2>
                    
                    <p><strong>SQLAlchemy</strong> es un ORM (Object Relational Mapper) para Python.</p>

                    <h4>Instalaci√≥n</h4>
                    <pre><code class="language-bash">pip install sqlalchemy</code></pre>

                    <h4>Conexi√≥n a SQLite</h4>
                    <pre><code class="language-python">from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

# Crear motor de base de datos
SQLALCHEMY_DATABASE_URL = "sqlite:///./taskflow.db"
engine = create_engine(
    SQLALCHEMY_DATABASE_URL, 
    connect_args={"check_same_thread": False}
)

# Crear sesi√≥n
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# Base para modelos
Base = declarative_base()

# Funci√≥n para obtener sesi√≥n
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()</code></pre>
                </section>

                <section id="modelos">
                    <h2 class="text-primary border-bottom pb-2">Modelos ORM (20 min)</h2>
                    
                    <pre><code class="language-python">from sqlalchemy import Column, Integer, String, Boolean, DateTime
from sqlalchemy.sql import func
from database import Base

class TareaDB(Base):
    __tablename__ = "tareas"
    
    id = Column(Integer, primary_key=True, index=True)
    titulo = Column(String, nullable=False)
    descripcion = Column(String)
    completada = Column(Boolean, default=False)
    prioridad = Column(Integer, default=1)
    fecha_creacion = Column(DateTime, server_default=func.now())

class UsuarioDB(Base):
    __tablename__ = "usuarios"
    
    id = Column(Integer, primary_key=True, index=True)
    username = Column(String, unique=True, nullable=False)
    email = Column(String, unique=True, nullable=False)
    password_hash = Column(String, nullable=False)
    activo = Column(Boolean, default=True)

# Crear tablas
Base.metadata.create_all(bind=engine)</code></pre>

                    <h4>Pydantic Models para API</h4>
                    <pre><code class="language-python">from pydantic import BaseModel
from typing import Optional
from datetime import datetime

class TareaBase(BaseModel):
    titulo: str
    descripcion: Optional[str] = None
    prioridad: int = 1

class TareaCreate(TareaBase):
    pass

class Tarea(TareaBase):
    id: int
    completada: bool
    fecha_creacion: datetime
    
    class Config:
        from_attributes = True  # Permite convertir desde ORM</code></pre>
                </section>

                <section id="crud">
                    <h2 class="text-primary border-bottom pb-2">Operaciones CRUD (25 min)</h2>
                    
                    <pre><code class="language-python">from sqlalchemy.orm import Session
from models import TareaDB

# CREATE
def create_tarea(db: Session, tarea: TareaCreate):
    db_tarea = TareaDB(**tarea.model_dump())
    db.add(db_tarea)
    db.commit()
    db.refresh(db_tarea)
    return db_tarea

# READ
def get_tarea(db: Session, tarea_id: int):
    return db.query(TareaDB).filter(TareaDB.id == tarea_id).first()

def get_tareas(db: Session, skip: int = 0, limit: int = 100):
    return db.query(TareaDB).offset(skip).limit(limit).all()

# UPDATE
def update_tarea(db: Session, tarea_id: int, tarea_update: TareaCreate):
    db_tarea = db.query(TareaDB).filter(TareaDB.id == tarea_id).first()
    if db_tarea:
        for key, value in tarea_update.model_dump().items():
            setattr(db_tarea, key, value)
        db.commit()
        db.refresh(db_tarea)
    return db_tarea

# DELETE
def delete_tarea(db: Session, tarea_id: int):
    db_tarea = db.query(TareaDB).filter(TareaDB.id == tarea_id).first()
    if db_tarea:
        db.delete(db_tarea)
        db.commit()
        return True
    return False</code></pre>
                </section>

                <section id="fastapi">
                    <h2 class="text-primary border-bottom pb-2">FastAPI + Base de Datos (15 min)</h2>
                    
                    <pre><code class="language-python">from fastapi import FastAPI, Depends, HTTPException
from sqlalchemy.orm import Session
from database import get_db, engine
from models import Base, TareaDB
from schemas import Tarea, TareaCreate
from crud import create_tarea, get_tarea, get_tareas, update_tarea, delete_tarea

# Crear tablas
Base.metadata.create_all(bind=engine)

app = FastAPI(title="TaskFlow con BD")

@app.post("/tareas", response_model=Tarea)
def crear_tarea(tarea: TareaCreate, db: Session = Depends(get_db)):
    return create_tarea(db=db, tarea=tarea)

@app.get("/tareas", response_model=list[Tarea])
def listar_tareas(
    skip: int = 0, 
    limit: int = 100, 
    db: Session = Depends(get_db)
):
    return get_tareas(db, skip=skip, limit=limit)

@app.get("/tareas/{tarea_id}", response_model=Tarea)
def obtener_tarea(tarea_id: int, db: Session = Depends(get_db)):
    db_tarea = get_tarea(db, tarea_id=tarea_id)
    if db_tarea is None:
        raise HTTPException(status_code=404, detail="Tarea no encontrada")
    return db_tarea

@app.put("/tareas/{tarea_id}", response_model=Tarea)
def actualizar_tarea(
    tarea_id: int, 
    tarea: TareaCreate, 
    db: Session = Depends(get_db)
):
    db_tarea = update_tarea(db, tarea_id=tarea_id, tarea_update=tarea)
    if db_tarea is None:
        raise HTTPException(status_code=404, detail="Tarea no encontrada")
    return db_tarea

@app.delete("/tareas/{tarea_id}")
def eliminar_tarea(tarea_id: int, db: Session = Depends(get_db)):
    success = delete_tarea(db, tarea_id=tarea_id)
    if not success:
        raise HTTPException(status_code=404, detail="Tarea no encontrada")
    return {"message": "Tarea eliminada"}</code></pre>

                    <h4>Estructura de Archivos</h4>
                    <pre><code class="language-text">taskflow/
‚îú‚îÄ‚îÄ main.py           # FastAPI app
‚îú‚îÄ‚îÄ database.py       # Conexi√≥n SQLAlchemy
‚îú‚îÄ‚îÄ models.py         # Modelos ORM
‚îú‚îÄ‚îÄ schemas.py        # Pydantic models
‚îú‚îÄ‚îÄ crud.py          # Operaciones CRUD
‚îî‚îÄ‚îÄ taskflow.db      # Base de datos SQLite</code></pre>
                </section>

                <section id="ejercicio">
                    <h2 class="text-primary border-bottom pb-2">Ejercicio: Usuarios con BD (10 min)</h2>
                    
                    <p>Implementa CRUD completo para el modelo Usuario con base de datos.</p>

                    <h4>Requisitos</h4>
                    <ul>
                        <li>Tabla usuarios con: id, username, email, password_hash, activo</li>
                        <li>Validar username √∫nico antes de crear</li>
                        <li>Validar email √∫nico antes de crear</li>
                        <li>No retornar password_hash en las respuestas</li>
                    </ul>

                    <pre><code class="language-python"># schemas.py
class UsuarioBase(BaseModel):
    username: str
    email: str

class UsuarioCreate(UsuarioBase):
    password: str

class Usuario(UsuarioBase):
    id: int
    activo: bool
    
    class Config:
        from_attributes = True

# crud.py
def create_usuario(db: Session, usuario: UsuarioCreate):
    # Verificar si username existe
    if db.query(UsuarioDB).filter(UsuarioDB.username == usuario.username).first():
        raise HTTPException(400, "Username ya existe")
    
    # Crear usuario (hash password en producci√≥n)
    db_usuario = UsuarioDB(
        username=usuario.username,
        email=usuario.email,
        password_hash=f"hash_{usuario.password}"  # Simplificado
    )
    db.add(db_usuario)
    db.commit()
    db.refresh(db_usuario)
    return db_usuario</code></pre>

                    <div class="alert-note">
                        <strong>Evaluaci√≥n 3:</strong> Entregar API completa con base de datos SQLite + tests + cobertura 80%.
                    </div>
                </section>

                <section>
                    <h2 class="text-primary border-bottom pb-2">Resumen Unidad 3</h2>
                    
                    <h4>FastAPI + Pydantic + SQLAlchemy</h4>
                    
                    <ul>
                        <li><strong>FastAPI:</strong> Framework para APIs r√°pidas</li>
                        <li><strong>Pydantic:</strong> Validaci√≥n de datos</li>
                        <li><strong>Depends:</strong> Inyecci√≥n de dependencias</li>
                        <li><strong>TestClient:</strong> Testing de APIs</li>
                        <li><strong>SQLAlchemy:</strong> ORM para base de datos</li>
                    </ul>
                    
                    <div class="alert-success text-white p-3 rounded">
                        <strong>üéâ Felicitaciones!</strong> Has completado la Unidad 3. Ahora puedes construir APIs completas con Python.
                    </div>
                </section>
            </main>
        </div>
    </div>

    <footer class="bg-light text-center py-3 mt-5">
        <div class="container">
            <p class="mb-0">&copy; 2026 IF0100 - UNAULA | <a href="clase-04-testing-fastapi.html">‚Üê Anterior</a> | <a href="../index.html#proyecto-final">Siguiente: Proyecto Final ‚Üí</a></p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
</body>
</html>