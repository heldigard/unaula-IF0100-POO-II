<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clase 10: Dependencias en FastAPI | IF0100</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        :root { --primary: #0d6efd; --success: #198754; --warning: #ffc107; --danger: #dc3545; --info: #0dcaf0; }
        header { background: linear-gradient(135deg, var(--primary) 0%, #0a58ca 100%); color: white; padding: 2rem 0; }
        .sidebar { background: #f8f9fa; border-radius: 8px; padding: 1.5rem; position: sticky; top: 2rem; }
        section { margin-bottom: 2rem; padding: 1.5rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        pre[class*="language-"] { border-radius: 6px; }
        .alert-tip { background: #d1e7dd; border-left: 4px solid var(--success); padding: 1rem; border-radius: 4px; }
        .alert-warning { background: #fff3cd; border-left: 4px solid var(--warning); padding: 1rem; border-radius: 4px; }
        .alert-note { background: #e7f3ff; border-left: 4px solid var(--info); padding: 1rem; border-radius: 4px; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>IF0100 - Programación OO II</h1>
            <h2>Unidad 3: Desarrollo Web con FastAPI</h2>
            <h3>Clase 3: Inyección de Dependencias</h3>
            <p class="mt-2">
                <span class="badge bg-light text-dark"><i class="bi bi-calendar3"></i> Martes, 14 de abril de 2026</span>
                <span class="badge bg-info text-dark">Semana 11 - Martes (120 minutos)</span>
                <span class="badge bg-primary">60 min Teoría</span>
                <span class="badge bg-success text-white">60 min Práctica</span>
            </p>
            <p class="mt-2"><span class="badge bg-danger">E4: Lab Persistencia - Jueves 23/04/2026 (9 días)</span></p>
        </div>
    </header>

    <div class="container mt-4">
        <div class="row">
            <aside class="col-lg-3">
                <nav class="sidebar">
                    <h5>Contenido</h5>
                    <ul class="list-unstyled">
                        <li><a href="#objetivos" class="text-decoration-none">Objetivos</a></li>
                        <li><a href="#depends" class="text-decoration-none">Depends()</a></li>
                        <li><a href="#db" class="text-decoration-none">Conexión a BD</a></li>
                        <li><a href="#auth" class="text-decoration-none">Autenticación</a></li>
                        <li><a href="#ejercicio" class="text-decoration-none">Ejercicio</a></li>
                    </ul>
                </nav>
            </aside>

            <main class="col-lg-9">
                <section id="objetivos">
                    <h2 class="text-primary border-bottom pb-2">Objetivos de Aprendizaje</h2>
                    <ul>
                        <li>Entender la inyección de dependencias</li>
                        <li>Usar Depends() para compartir código</li>
                        <li>Crear dependencias de base de datos</li>
                        <li>Implementar autenticación con Depends</li>
                    </ul>
                </section>

                <section id="depends">
                    <h2 class="text-primary border-bottom pb-2">Depends() (20 min)</h2>
                    
                    <p>La <strong>inyección de dependencias</strong> permite compartir código entre rutas.</p>

                    <h4>Ejemplo Básico</h4>
                    <pre><code class="language-python">from fastapi import Depends, FastAPI

app = FastAPI()

# Función de dependencia
def parametros_comunes(skip: int = 0, limit: int = 10):
    return {"skip": skip, "limit": limit}

# Usar Depends en una ruta
@app.get("/items/")
async def read_items(params: dict = Depends(parametros_comunes)):
    return params

# Múltiples rutas usan la misma dependencia
@app.get("/users/")
async def read_users(params: dict = Depends(parametros_comunes)):
    return params

# curl http://localhost:8000/items/?skip=20&limit=5
# {"skip": 20, "limit": 5}</code></pre>

                    <h4>Dependencias Anidadas</h4>
                    <pre><code class="language-python">from fastapi import Depends, FastAPI

app = FastAPI()

def obtener_query(q: str | None = None):
    return q

def obtener_skip(skip: int = 0):
    return skip

# Depende de dos dependencias
def parametros_completos(
    q: str | None = Depends(obtener_query),
    skip: int = Depends(obtener_skip)
):
    return {"q": q, "skip": skip}

@app.get("/items/")
async def read_items(params: dict = Depends(parametros_completos)):
    return params</code></pre>
                </section>

                <section id="db">
                    <h2 class="text-primary border-bottom pb-2">Conexión a Base de Datos (20 min)</h2>
                    
                    <h4>Simular Conexión a BD</h4>
                    <pre><code class="language-python">from fastapi import Depends, FastAPI
from typing import Generator

app = FastAPI()

# Simular conexión a base de datos
class Database:
    def __init__(self):
        self.connected = False
    
    def connect(self):
        self.connected = True
        print("Conectando a BD...")
        return self
    
    def disconnect(self):
        self.connected = False
        print("Desconectando de BD...")
    
    def query(self, sql: str):
        return [{"id": 1, "name": "Item 1"}]

# Dependencia que maneja la conexión
def get_db() -> Generator:
    db = Database()
    try:
        yield db.connect()
    finally:
        db.disconnect()

@app.get("/items/")
async def get_items(db: Database = Depends(get_db)):
    # db ya está conectado
    items = db.query("SELECT * FROM items")
    return items

# Al finalizar la petición, se desconecta automáticamente</code></pre>

                    <div class="alert-note">
                        <strong>Patrón yield:</strong> El código antes del yield se ejecuta antes, el código después (finally) se ejecuta al terminar.
                    </div>
                </section>

                <section id="auth">
                    <h2 class="text-primary border-bottom pb-2">Autenticación (20 min)</h2>
                    
                    <p>En APIs modernas, se suele usar <strong>JWT (JSON Web Token)</strong> para manejar la autenticación de forma segura y escalable.</p>
                    
                    <h4>Verificar Token</h4>
                    <pre><code class="language-python">from fastapi import Depends, FastAPI, HTTPException, Header
from typing import Optional

app = FastAPI()

# Base de datos simulada de usuarios
usuarios_db = {
    "token-juan": {"username": "juan", "rol": "admin"},
    "token-ana": {"username": "ana", "rol": "user"}
}

def verificar_token(x_token: str = Header(...)):
    """Extrae y verifica el token del header."""
    if x_token not in usuarios_db:
        raise HTTPException(status_code=401, detail="Token inválido")
    return usuarios_db[x_token]

def requerir_admin(usuario: dict = Depends(verificar_token)):
    """Verifica que el usuario sea admin."""
    if usuario["rol"] != "admin":
        raise HTTPException(status_code=403, detail="Requiere rol de admin")
    return usuario

# Ruta protegida con autenticación
@app.get("/perfil")
async def obtener_perfil(usuario: dict = Depends(verificar_token)):
    return {"usuario": usuario}

# Ruta protegida solo para admins
@app.delete("/usuarios/{user_id}")
async def eliminar_usuario(
    user_id: int,
    admin: dict = Depends(requerir_admin)
):
    return {"message": f"Usuario {user_id} eliminado", "por": admin["username"]}

# Probar:
# curl -H "X-Token: token-juan" http://localhost:8000/perfil
# curl -H "X-Token: token-invalido" http://localhost:8000/perfil  # 401</code></pre>

                    <h4>Esquema de Dependencias</h4>
                    <pre><code class="language-python"># Obtener usuario actual (requiere token)
async def get_current_user(token: str = Header(...)):
    # Verificar token...
    return {"id": 1, "username": "juan"}

# Verificar permisos (requiere usuario)
async def check_permissions(
    user: dict = Depends(get_current_user),
    required_role: str = "admin"
):
    if user.get("role") != required_role:
        raise HTTPException(403, "Sin permisos")
    return user

# Ruta con múltiples dependencias
@app.post("/proyectos")
async def crear_proyecto(
    proyecto: ProyectoCreate,
    user: dict = Depends(check_permissions)  # Token + Permisos
):
    # Crear proyecto...
    return proyecto</code></pre>
                </section>

                <section id="ejercicio">
                    <h2 class="text-primary border-bottom pb-2">Ejercicio: API Protegida (10 min)</h2>
                    
                    <p>Crea una API de tareas con autenticación.</p>

                    <pre><code class="language-python">from fastapi import FastAPI, Depends, HTTPException, Header
from pydantic import BaseModel
from typing import Optional, List

app = FastAPI()

# Modelos
class TareaCreate(BaseModel):
    titulo: str
    descripcion: Optional[str] = None

class Tarea(TareaCreate):
    id: int
    usuario_id: int

# Usuarios simulados
USUARIOS = {
    "token123": {"id": 1, "username": "juan"},
    "token456": {"id": 2, "username": "ana"}
}

# Base de datos simulada
tareas_db = []
contador_tarea = 1

# Dependencias
def get_current_user(x_token: str = Header(...)):
    if x_token not in USUARIOS:
        raise HTTPException(401, "Token inválido")
    return USUARIOS[x_token]

# Rutas protegidas
@app.post("/tareas", response_model=Tarea)
async def crear_tarea(
    tarea: TareaCreate,
    usuario: dict = Depends(get_current_user)
):
    global contador_tarea
    nueva = Tarea(
        id=contador_tarea,
        usuario_id=usuario["id"],
        **tarea.model_dump()
    )
    tareas_db.append(nueva)
    contador_tarea += 1
    return nueva

@app.get("/tareas/mis-tareas", response_model=List[Tarea])
async def listar_mis_tareas(
    usuario: dict = Depends(get_current_user)
):
    # Filtrar solo tareas del usuario autenticado
    return [t for t in tareas_db if t.usuario_id == usuario["id"]]

@app.delete("/tareas/{tarea_id}")
async def eliminar_tarea(
    tarea_id: int,
    usuario: dict = Depends(get_current_user)
):
    for i, tarea in enumerate(tareas_db):
        if tarea.id == tarea_id and tarea.usuario_id == usuario["id"]:
            del tareas_db[i]
            return {"message": "Tarea eliminada"}
    raise HTTPException(404, "Tarea no encontrada o no es tuya")</code></pre>

                    <div class="alert-note">
                        <strong>Beneficio:</strong> Las dependencias evitan repetir código de autenticación/BD en cada ruta.
                    </div>
                </section>

                <section>
                    <h2 class="text-primary border-bottom pb-2">Resumen</h2>
                    
                    <ul>
                        <li><strong>Depends():</strong> Inyecta dependencias en rutas</li>
                        <li><strong>yield:</strong> Gestiona recursos (conectar/desconectar BD)</li>
                        <li><strong>Reutilización:</strong> Múltiples rutas usan la misma dependencia</li>
                        <li><strong>Autenticación:</strong> Verificar token en dependencia</li>
                        <li><strong>Jerarquía:</strong> Dependencias pueden depender de otras</li>
                    </ul>
                    
                    <div class="alert-tip">
                        <strong>Práctica:</strong> Agrega una dependencia que verifique que el usuario esté activo antes de permitir crear tareas.
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Navegación entre clases -->
    <div class="container mt-4 mb-4">
        <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded">
            <div>
                <a href="clase-02-pydantic-validacion.html" class="btn btn-outline-secondary btn-sm">
                    ← Anterior: Pydantic
                </a>
            </div>
            <div>
                <span class="text-muted small">Clase 13 de 25</span>
            </div>
            <div>
                <a href="clase-04-testing-fastapi.html" class="btn btn-primary btn-sm">
                    Siguiente: Testing FastAPI →
                </a>
            </div>
        </div>
    </div>

    <footer class="bg-light text-center py-3 mt-5">
        <div class="container">
            <p class="mb-0">&copy; 2026 IF0100 - UNAULA | <a href="../index.html">Inicio</a></p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
</body>
</html>