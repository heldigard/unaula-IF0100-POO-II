<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clase 11: Testing FastAPI | IF0100</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        :root { --primary: #0d6efd; --success: #198754; --warning: #ffc107; --danger: #dc3545; --info: #0dcaf0; }
        header { background: linear-gradient(135deg, var(--primary) 0%, #0a58ca 100%); color: white; padding: 2rem 0; }
        .sidebar { background: #f8f9fa; border-radius: 8px; padding: 1.5rem; position: sticky; top: 2rem; }
        section { margin-bottom: 2rem; padding: 1.5rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        pre[class*="language-"] { border-radius: 6px; }
        .alert-tip { background: #d1e7dd; border-left: 4px solid var(--success); padding: 1rem; border-radius: 4px; }
        .alert-warning { background: #fff3cd; border-left: 4px solid var(--warning); padding: 1rem; border-radius: 4px; }
        .alert-note { background: #e7f3ff; border-left: 4px solid var(--info); padding: 1rem; border-radius: 4px; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>IF0100 - Programación OO II</h1>
            <h2>Unidad 3: Desarrollo Web con FastAPI</h2>
            <h3>Clase 11: Testing de APIs</h3>
            <p class="mt-2">
                <span class="badge bg-light text-dark"><i class="bi bi-calendar3"></i> Martes, 21 de abril de 2026</span>
                <span class="badge bg-info text-dark">Semana 12 - Martes (120 minutos)</span>
                <span class="badge bg-primary">60 min Teoría</span>
                <span class="badge bg-success text-white">60 min Práctica</span>
            </p>
            <p class="mt-2">
                <a href="../evaluaciones/evaluacion-04-persistencia-sqlalchemy.html" class="badge bg-danger text-decoration-none">
                    <i class="bi bi-clipboard-check"></i> E4: Lab Persistencia - Jueves 23/04/2026 (2 días)
                </a>
            </p>
        </div>
    </header>

    <div class="container mt-4">
        <div class="row">
            <aside class="col-lg-3">
                <nav class="sidebar">
                    <h5>Contenido</h5>
                    <ul class="list-unstyled">
                        <li><a href="#objetivos" class="text-decoration-none">Objetivos</a></li>
                        <li><a href="#testclient" class="text-decoration-none">TestClient</a></li>
                        <li><a href="#tests" class="text-decoration-none">Escribir Tests</a></li>
                        <li><a href="#fixtures" class="text-decoration-none">Fixtures</a></li>
                        <li><a href="#coverage" class="text-decoration-none">Cobertura</a></li>
                        <li><a href="#ejercicio" class="text-decoration-none">Ejercicio</a></li>
                    </ul>
                </nav>
            </aside>

            <main class="col-lg-9">
                <section id="objetivos">
                    <h2 class="text-primary border-bottom pb-2">Objetivos de Aprendizaje</h2>
                    <ul>
                        <li>Testear APIs FastAPI con TestClient</li>
                        <li>Escribir tests para rutas CRUD</li>
                        <li>Usar fixtures de pytest</li>
                        <li>Medir cobertura de código</li>
                        <li>Testear autenticación</li>
                    </ul>
                </section>

                <section id="testclient">
                    <h2 class="text-primary border-bottom pb-2">TestClient (15 min)</h2>
                    
                    <p>FastAPI incluye <code>TestClient</code> para testear sin levantar el servidor.</p>

                    <h4>Instalación</h4>
                    <pre><code class="language-bash">pip install httpx pytest</code></pre>

                    <h4>Estructura de Tests</h4>
                    <pre><code class="language-python"># main.py (tu aplicación)
from fastapi import FastAPI

app = FastAPI()

@app.get("/")
def read_root():
    return {"message": "Hello World"}

@app.get("/items/{item_id}")
def read_item(item_id: int):
    return {"item_id": item_id}

# test_main.py (tests)
from fastapi.testclient import TestClient
from main import app

client = TestClient(app)

def test_read_root():
    response = client.get("/")
    assert response.status_code == 200
    assert response.json() == {"message": "Hello World"}

def test_read_item():
    response = client.get("/items/42")
    assert response.status_code == 200
    assert response.json() == {"item_id": 42}</code></pre>

                    <h4>Ejecutar Tests</h4>
                    <pre><code class="language-bash">pytest test_main.py -v

# Salida:
# test_main.py::test_read_root PASSED
# test_main.py::test_read_item PASSED</code></pre>
                </section>

                <section id="tests">
                    <h2 class="text-primary border-bottom pb-2">Tests CRUD Completo (25 min)</h2>
                    
                    <pre><code class="language-python"># test_tareas.py
import pytest
from fastapi.testclient import TestClient
from main import app

client = TestClient(app)

class TestTareas:
    """Tests para la API de Tareas."""
    
    def test_crear_tarea(self):
        """POST /tareas - Crear nueva tarea."""
        response = client.post(
            "/tareas",
            json={"titulo": "Nueva tarea", "descripcion": "Descripción"}
        )
        assert response.status_code == 201
        data = response.json()
        assert data["titulo"] == "Nueva tarea"
        assert "id" in data
    
    def test_listar_tareas(self):
        """GET /tareas - Listar todas las tareas."""
        # Primero crear una tarea
        client.post("/tareas", json={"titulo": "Tarea 1"})
        
        response = client.get("/tareas")
        assert response.status_code == 200
        data = response.json()
        assert isinstance(data, list)
        assert len(data) >= 1
    
    def test_obtener_tarea(self):
        """GET /tareas/{id} - Obtener tarea específica."""
        # Crear tarea
        create_response = client.post("/tareas", json={"titulo": "Específica"})
        tarea_id = create_response.json()["id"]
        
        # Obtenerla
        response = client.get(f"/tareas/{tarea_id}")
        assert response.status_code == 200
        assert response.json()["titulo"] == "Específica"
    
    def test_obtener_tarea_no_existe(self):
        """GET /tareas/{id} - Tarea no encontrada."""
        response = client.get("/tareas/99999")
        assert response.status_code == 404
        assert response.json()["detail"] == "Tarea no encontrada"
    
    def test_actualizar_tarea(self):
        """PUT /tareas/{id} - Actualizar tarea."""
        # Crear
        create_response = client.post("/tareas", json={"titulo": "Original"})
        tarea_id = create_response.json()["id"]
        
        # Actualizar
        response = client.put(
            f"/tareas/{tarea_id}",
            json={"titulo": "Actualizada", "descripcion": "Nueva desc", "completada": True}
        )
        assert response.status_code == 200
        assert response.json()["titulo"] == "Actualizada"
    
    def test_eliminar_tarea(self):
        """DELETE /tareas/{id} - Eliminar tarea."""
        # Crear
        create_response = client.post("/tareas", json={"titulo": "A eliminar"})
        tarea_id = create_response.json()["id"]
        
        # Eliminar
        response = client.delete(f"/tareas/{tarea_id}")
        assert response.status_code == 200
        
        # Verificar que ya no existe
        get_response = client.get(f"/tareas/{tarea_id}")
        assert get_response.status_code == 404</code></pre>
                </section>

                <section id="fixtures">
                    <h2 class="text-primary border-bottom pb-2">Fixtures (15 min)</h2>
                    
                    <p>Las fixtures preparan datos para los tests.</p>

                    <pre><code class="language-python">import pytest
from fastapi.testclient import TestClient
from main import app

@pytest.fixture
def client():
    """Proporciona un TestClient."""
    return TestClient(app)

@pytest.fixture
def tarea_existente(client):
    """Crea una tarea y retorna su ID."""
    response = client.post("/tareas", json={"titulo": "Tarea fixture"})
    return response.json()

class TestConFixtures:
    def test_usar_tarea_existente(self, client, tarea_existente):
        """Usa la fixture de tarea."""
        tarea_id = tarea_existente["id"]
        
        response = client.get(f"/tareas/{tarea_id}")
        assert response.status_code == 200
        assert response.json()["titulo"] == "Tarea fixture"
    
    def test_eliminar_tarea_existente(self, client, tarea_existente):
        """Elimina la tarea creada por la fixture."""
        tarea_id = tarea_existente["id"]
        
        response = client.delete(f"/tareas/{tarea_id}")
        assert response.status_code == 200</code></pre>
                </section>

                <section id="coverage">
                    <h2 class="text-primary border-bottom pb-2">Cobertura (10 min)</h2>
                    
                    <h4>Instalar pytest-cov</h4>
                    <pre><code class="language-bash">pip install pytest-cov</code></pre>

                    <h4>Medir Cobertura</h4>
                    <pre><code class="language-bash"># Ver cobertura en terminal
pytest --cov=main --cov-report=term-missing

# Generar reporte HTML
pytest --cov=main --cov-report=html

# Abrir htmlcov/index.html en navegador</code></pre>

                    <div class="alert-tip">
                        <strong>Meta:</strong> Para la Evaluación 3, se requiere cobertura mínima del 80%.
                    </div>
                </section>

                <section id="ejercicio">
                    <h2 class="text-primary border-bottom pb-2">Ejercicio: Tests Completos (5 min)</h2>
                    
                    <p>Escribe tests para:</p>
                    
                    <ol>
                        <li>Validación de datos (título vacío debe retornar 422)</li>
                        <li>Autenticación (sin token debe retornar 401)</li>
                        <li>Permisos (usuario normal no puede eliminar de otro)</li>
                    </ol>

                    <pre><code class="language-python">def test_crear_tarea_sin_titulo(client):
    """Título vacío debe fallar."""
    response = client.post("/tareas", json={"titulo": ""})
    assert response.status_code == 422

def test_acceso_sin_token(client):
    """Sin token debe retornar 401."""
    response = client.get("/tareas/protegidas")
    assert response.status_code == 401

def test_eliminar_tarea_de_otro_usuario(client):
    """No se puede eliminar tarea de otro usuario."""
    # Crear tarea con usuario 1
    client.headers["X-Token"] = "token1"
    tarea = client.post("/tareas", json={"titulo": "Mia"}).json()
    
    # Intentar eliminar con usuario 2
    client.headers["X-Token"] = "token2"
    response = client.delete(f"/tareas/{tarea['id']}")
    assert response.status_code == 403</code></pre>
                </section>

                <section>
                    <h2 class="text-primary border-bottom pb-2">Resumen</h2>
                    
                    <ul>
                        <li><strong>TestClient:</strong> Simula peticiones HTTP</li>
                        <li><strong>status_code:</strong> Verifica código de respuesta</li>
                        <li><strong>.json():</strong> Obtiene datos de respuesta</li>
                        <li><strong>Fixtures:</strong> Preparan datos reutilizables</li>
                        <li><strong>Cobertura:</strong> Mide % de código testeado</li>
                    </ul>
                    
                    <div class="alert-tip">
                        <strong>Evaluación 3:</strong> API funcional + tests con 80% cobertura.
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Navegación entre clases -->
    <div class="container mt-4 mb-4">
        <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded">
            <div>
                <a href="clase-03-dependencias.html" class="btn btn-outline-secondary btn-sm">
                    ← Anterior: Dependencias
                </a>
            </div>
            <div>
                <span class="text-muted small">Clase 14 de 25</span>
            </div>
            <div>
                <a href="clase-05-persistencia-datos.html" class="btn btn-primary btn-sm">
                    Siguiente: Persistencia →
                </a>
            </div>
        </div>
    </div>

    <footer class="bg-light text-center py-3 mt-5">
        <div class="container">
            <p class="mb-0">&copy; 2026 IF0100 - UNAULA | <a href="../index.html">Inicio</a></p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
</body>
</html>