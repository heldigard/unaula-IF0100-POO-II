<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clase 12 - Introducción a ADO.NET | IF0100 POO II</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .meta-bar {
            background: #1e3a8a;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .meta-bar span { font-size: 0.9rem; }
        .nav {
            background: #1e3a8a;
            padding: 0.5rem 2rem;
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: background 0.3s;
        }
        .nav a:hover { background: rgba(255,255,255,0.2); }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #1e40af;
            border-bottom: 3px solid #3b82f6;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .section h3 {
            color: #3b82f6;
            margin: 1.5rem 0 1rem;
        }
        .section h4 {
            color: #1e3a8a;
            margin: 1rem 0 0.5rem;
        }
        .objectives-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        .objectives-table th, .objectives-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .objectives-table th { background: #f3f4f6; }
        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        code {
            background: #e5e7eb;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: "Fira Code", "Consolas", monospace;
            font-size: 0.9em;
        }
        pre code { background: none; padding: 0; }
        .example-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        .figure-container {
            text-align: center;
            margin: 2rem 0;
        }
        .figure-container img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .figure-container figcaption {
            margin-top: 0.5rem;
            font-style: italic;
            color: #6b7280;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }
        .comparison .bad {
            background: #fef2f2;
            border: 1px solid #fca5a5;
            padding: 1rem;
            border-radius: 4px;
        }
        .comparison .good {
            background: #f0fdf4;
            border: 1px solid #86efac;
            padding: 1rem;
            border-radius: 4px;
        }
        .comparison-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .badge-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-purple { background: #f3e8ff; color: #7c3aed; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .tag-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        .tag-table th {
            background: #1e40af;
            color: white;
            padding: 0.75rem;
            text-align: left;
        }
        .tag-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        ul, ol { margin-left: 1.5rem; }
        li { margin: 0.5rem 0; }
        .footer {
            background: #1e3a8a;
            color: white;
            text-align: center;
            padding: 2rem;
            margin-top: 2rem;
        }
        .note-box {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .note-box strong { color: #92400e; }
        .warning-box {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .warning-box strong { color: #991b1b; }
        .checklist-box {
            background: #f0fdf4;
            border: 1px solid #86efac;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        .checklist-box strong { color: #166534; }
        .note {
            background: #f0f4ff;
            border-left: 4px solid #3b82f6;
            padding: 10px 12px;
            border-radius: 8px;
            color: #52606d;
        }
        /* Syntax highlighting para C# */
        .token-keyword { color: #c792ea; font-weight: 600; }
        .token-type { color: #ffcb6b; }
        .token-string { color: #c3e88d; }
        .token-comment { color: #546e7a; font-style: italic; }
        .token-number { color: #f78c6c; }
        .token-operator { color: #89ddff; }

        /* BLOQUES DE CÓDIGO MEJORADOS */
        .code-block {
            background: #1e1e2e;
            border-radius: 12px;
            margin: 16px 0;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 1px solid #313244;
        }

        .code-header {
            background: linear-gradient(90deg, #313244 0%, #45475a 100%);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #45475a;
        }

        .code-dots {
            display: flex;
            gap: 6px;
        }

        .code-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .code-dot.red { background: #f38ba8; }
        .code-dot.yellow { background: #f9e2af; }
        .code-dot.green { background: #a6e3a1; }

        .code-title {
            color: #cdd6f4;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: auto;
            font-family: 'Cascadia Code', Consolas, monospace;
        }

        .code-content {
            display: flex;
            background: #1e1e2e;
        }

        .line-numbers {
            background: #181825;
            color: #6c7086;
            padding: 12px 10px;
            text-align: right;
            font-family: 'Cascadia Code', Consolas, monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            user-select: none;
            border-right: 1px solid #313244;
        }

        .code-block pre {
            background: transparent;
            margin: 0;
            padding: 12px 16px;
            flex: 1;
            overflow-x: auto;
        }

        .code-block pre code {
            color: #cdd6f4;
            font-size: 0.95rem;
            line-height: 1.5;
            display: block;
        }

        /* Syntax highlighting mejorado */
        .code-block .token-keyword { color: #cba6f7; font-weight: 600; }
        .code-block .token-type { color: #f9e2af; }
        .code-block .token-string { color: #a6e3a1; }
        .code-block .token-comment { color: #6c7086; font-style: italic; }
        .code-block .token-number { color: #fab387; }
        .code-block .token-operator { color: #89dceb; }
        .code-block .token-method { color: #89b4fa; }
        .code-block .token-class { color: #f9e2af; font-weight: 600; }
        .code-block .token-property { color: #b4befe; }
        .code-block .token-namespace { color: #f38ba8; }

        p code, li code {
            background: #313244;
            color: #cdd6f4;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.9em;
            border: 1px solid #45475a;
        }

        /* Accessibility */
        abbr[title] { text-decoration: underline dotted; cursor: help; }
        /* Print styles */
        @media print {
            header, nav, footer { background: white !important; color: black !important; }
            a[href]:after { content: " (" attr(href) ")"; font-size: 0.8em; }
            pre, code { white-space: pre-wrap; }
        }
        @media (max-width: 768px) {
            .comparison { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.8rem; }
            .meta-bar { flex-direction: column; text-align: center; }
        }

        /* BLOQUES DE CÓDIGO MEJORADOS */
        .code-block {
            background: #1e1e2e;
            border-radius: 12px;
            margin: 16px 0;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 1px solid #313244;
        }

        .code-header {
            background: linear-gradient(90deg, #313244 0%, #45475a 100%);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #45475a;
        }

        .code-dots {
            display: flex;
            gap: 6px;
        }

        .code-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .code-dot.red { background: #f38ba8; }
        .code-dot.yellow { background: #f9e2af; }
        .code-dot.green { background: #a6e3a1; }

        .code-title {
            color: #cdd6f4;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: auto;
            font-family: 'Cascadia Code', Consolas, monospace;
        }

        .code-content {
            display: flex;
            background: #1e1e2e;
        }

        .line-numbers {
            background: #181825;
            color: #6c7086;
            padding: 12px 10px;
            text-align: right;
            font-family: 'Cascadia Code', Consolas, monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            user-select: none;
            border-right: 1px solid #313244;
        }

        .code-block pre {
            background: transparent;
            margin: 0;
            padding: 12px 16px;
            flex: 1;
            overflow-x: auto;
        }

        .code-block pre code {
            color: #cdd6f4;
            font-size: 0.95rem;
            line-height: 1.5;
            display: block;
        }

        /* Syntax highlighting mejorado - Catppuccin Mocha theme */
        .code-block .token-keyword { color: #cba6f7; font-weight: 600; } /* purple */
        .code-block .token-type { color: #f9e2af; } /* yellow */
        .code-block .token-string { color: #a6e3a1; } /* green */
        .code-block .token-comment { color: #6c7086; font-style: italic; } /* gray */
        .code-block .token-number { color: #fab387; } /* peach */
        .code-block .token-operator { color: #89dceb; } /* cyan */
        .code-block .token-method { color: #89b4fa; } /* blue */
        .code-block .token-class { color: #f9e2af; font-weight: 600; }
        .code-block .token-property { color: #b4befe; } /* lavender */
        .code-block .token-namespace { color: #f38ba8; } /* pink */

        /* Código inline */
        p code, li code {
            background: #313244;
            color: #cdd6f4;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.9em;
            border: 1px solid #45475a;
        }

        /* Tablas de código */
        .code-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin: 16px 0;
        }

        .code-comparison .code-block {
            margin: 0;
        }

        .code-label {
            font-size: 0.8rem;
            color: #6c7086;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #1e3a8a;
            color: #fff;
            padding: 8px 16px;
            text-decoration: none;
            z-index: 100;
            transition: top 0.3s;
        }
        .skip-link:focus {
            top: 0;
        }
    </style>
</head>
<body>
    <a href="#main" class="skip-link">Saltar al contenido</a>
    <header class="header">
        <h1>Clase 12 - Introducción a ADO.NET</h1>
        <p>IF0100 - Lenguaje de Programación Orientada a Objetos II | Unidad 4 - Persistencia de Datos</p>
    </header>

    <div class="meta-bar">
        <span> Duración: 90 minutos</span>
        <span> Unidad 4 - Persistencia de Datos</span>
        <span> 4 Semestre - Ingeniería Informática</span>
    </div>

    <nav class="nav">
        <a href="#teoria">Teoría</a>
        <a href="#ejemplos">Ejemplos</a>
        <a href="#practica">Práctica / Laboratorio</a>
        <a href="#ejercicios">Ejercicios</a>
        <a href="#referencias">Referencias</a>
    </nav>

    <main class="container" id="main">
        <!-- Teoría -->
        <section id="teoria">
        <!-- Objetivos -->
        <section id="objetivos" class="section">
            <h2>Objetivos de la Clase</h2>
            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Objetivo</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td><strong>Comprender</strong> la arquitectura de ADO.NET</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td><strong>Configurar</strong> la cadena de conexión a SQL Server</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td><strong>Implementar</strong> operaciones CRUD con ADO.NET</td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td><strong>Utilizar</strong> SqlConnection, SqlCommand y SqlDataReader</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td><strong>Aplicar</strong> buenas prácticas de manejo de conexiones</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Agenda -->
        <section id="agenda" class="section">
            <h2>Agenda (90 min)</h2>
            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>Tiempo</th>
                        <th>Tema</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>10'</td>
                        <td> Qué es ADO.NET?</td>
                    </tr>
                    <tr>
                        <td>15'</td>
                        <td>Arquitectura y componentes</td>
                    </tr>
                    <tr>
                        <td>15'</td>
                        <td>Conexión a SQL Server</td>
                    </tr>
                    <tr>
                        <td>25'</td>
                        <td>Operaciones CRUD</td>
                    </tr>
                    <tr>
                        <td>15'</td>
                        <td>Manejo de transacciones</td>
                    </tr>
                    <tr>
                        <td>10'</td>
                        <td>Buenas prácticas</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Que es ADO.NET -->
        <section id="que-es" class="section">
            <h2>1. Qué es ADO.NET?</h2>

            <div class="note-box">
                <strong>¿Por qué aprender ADO.NET?</strong>
                <ul>
                    <li><strong>Control total:</strong> Escribe SQL exacto para máximo rendimiento en queries complejas</li>
                    <li><strong>Comprensión profunda:</strong> Entender cómo funciona el acceso a datos bajo el capó</li>
                    <li><strong>Stored Procedures:</strong> ADO.NET es ideal para trabajar con procedimientos almacenados</li>
                    <li><strong>Fundamento:</strong> Entity Framework y otros ORMs se construyen sobre ADO.NET</li>
                </ul>
            </div>

            <h3>Acceso a datos en .NET</h3>
            <p><strong><abbr title="ADO.NET - ActiveX Data Objects for .NET, tecnología de acceso a datos de Microsoft">ADO.NET</abbr></strong> es un conjunto de clases que permite a las aplicaciones .NET acceder a fuentes de datos como SQL Server, Oracle, MySQL, PostgreSQL, SQLite, archivos XML, entre otros.</p>

            <h4>Características principales:</h4>
            <div class="badge-list">
                <span class="badge badge-blue"><abbr title="DataReader - Lector de datos en modo conectado, solo lectura y solo avance">DataReader</abbr> (modo conectado)</span>
                <span class="badge badge-green"><abbr title="DataSet - Conjunto de datos en memoria que funciona en modo desconectado">DataSet</abbr> (modo desconectado)</span>
                <span class="badge badge-purple">Proveedores de datos</span>
                <span class="badge badge-red">Alto rendimiento</span>
            </div>

            <div class="warning-box">
                <strong>Modo Conectado vs Desconectado</strong>
                <ul>
                    <li><strong>Conectado (DataReader):</strong> La conexión permanece abierta mientras lees datos. Más rápido, pero bloquea la conexión.</li>
                    <li><strong>Desconectado (DataSet):</strong> Los datos se cargan en memoria y la conexión se cierra. Puedes modificar datos y sincronizar después.</li>
                </ul>
            </div>

            <h4>Proveedores de datos (Data Providers):</h4>
            <p><strong>Data Provider</strong> = Conjunto de clases específicas para un motor de base de datos (SqlConnection para SQL Server, OracleConnection para Oracle, etc.)</p>
            <ul>
                <li><strong>SqlClient:</strong> SQL Server</li>
                <li><strong>OracleClient:</strong> Oracle</li>
                <li><strong>MySql.Data:</strong> MySQL</li>
                <li><strong>Npgsql:</strong> PostgreSQL</li>
            </ul>

            <h3>ADO.NET vs Entity Framework</h3>
            <table class="tag-table">
                <thead>
                    <tr>
                        <th>Característica</th>
                        <th>ADO.NET</th>
                        <th>EF Core</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Nivel</td>
                        <td>Bajo nivel</td>
                        <td>Alto nivel</td>
                    </tr>
                    <tr>
                        <td>Cuando usar</td>
                        <td>Queries complejas, Stored procedures, Control total del SQL</td>
                        <td>CRUD estándar, Mapeo O/R simple, Productividad</td>
                    </tr>
                    <tr>
                        <td>Ventajas</td>
                        <td>Máximo control, Máximo rendimiento, Flexibilidad SQL</td>
                        <td>Menos código, Más mantenible, Strong typing</td>
                    </tr>
                    <tr>
                        <td>Desventajas</td>
                        <td>Más código, Más propenso a errores</td>
                        <td>Menos control, Overhead</td>
                    </tr>
                </tbody>
            </table>

            <p><em>En este curso: Ambos (ADO.NET primero, luego EF)</em></p>
        </section>

        <!-- Arquitectura -->
        <section id="arquitectura" class="section">
            <h2>2. Arquitectura ADO.NET</h2>

            <h3>Componentes principales</h3>
            <figure class="figure-container">
                <img src="../assets/infografias/clase-12-ado-net.png" alt="Arquitectura ADO.NET" onerror="this.onerror=null;this.src='/assets/infografias/clase-12-ado-net.png'">
                <figcaption>Arquitectura ADO.NET: El Data Provider (System.Data.SqlClient) contiene SqlConnection para gestionar conexiones, SqlCommand para ejecutar queries con parámetros seguros, y SqlDataReader para lectura eficiente forward-only; el DataSet ofrece modo desconectado con DataTables para escenarios donde se requiere desconexión de la base de datos; las flechas muestran el flujo de datos desde la aplicación a través del proveedor hasta la fuente de datos SQL Server.</figcaption>
            </figure>

            <h4>Proveedor de datos (System.Data.SqlClient)</h4>
            <ul>
                <li><strong><abbr title="SqlConnection - Clase que gestiona la conexión a SQL Server">SqlConnection</abbr>:</strong> Representa una conexión abierta a SQL Server. Maneja apertura, cierre y la <strong>connection string</strong> (cadena con servidor, base de datos, credenciales).</li>
                <li><strong><abbr title="SqlCommand - Clase que ejecuta comandos SQL contra una conexión">SqlCommand</abbr>:</strong> Ejecuta una query SQL o stored procedure. Maneja parámetros y devuelve resultados.</li>
            </ul>

            <h4>Objetos de datos</h4>
            <ul>
                <li><strong><abbr title="SqlDataReader - Lector de resultados en modo conectado, solo avance, solo lectura">SqlDataReader</abbr>:</strong> Lee filas de una consulta una por una (forward-only). No permite modificar datos y requiere conexión abierta.</li>
                <li><strong>DataSet:</strong> Contiene una colección de DataTables en memoria. Funciona en modo desconectado (no necesita conexión abierta).</li>
            </ul>

            <div class="note-box">
                <strong>Mini-Chequeo: Arquitectura ADO.NET</strong>
                <ul>
                    <li>¿Qué diferencia hay entre modo conectado y desconectado?</li>
                    <li>¿Cuándo usarías DataReader vs DataSet?</li>
                    <li>¿Qué es un Data Provider?</li>
                </ul>
            </div>

            <h3>Namespaces y Paquetes</h3>
            <p><strong><abbr title="NuGet - Gestor de paquetes para .NET (similar a npm para Node.js)">NuGet</abbr></strong> = Gestor de paquetes de .NET. Permite agregar bibliotecas externas a tu proyecto.</p>
            <p><strong><abbr title="LocalDB - Versión ligera de SQL Server Express para desarrollo">LocalDB</abbr></strong> = Versión de SQL Server que se ejecuta bajo demanda, ideal para desarrollo.</p>
            <p><strong>Namespace</strong> = Forma de organizar clases en C# (como "paquetes" en Java o "módulos" en Python).</p>

            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">NuGetPackages.cs</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10</div>
                    <pre><code><span class="token-comment">// Instalación vía NuGet</span>
<span class="token-method">dotnet</span> add package <span class="token-type">System.Data.SqlClient</span>
<span class="token-comment">// O para SQL Server (recomendado)</span>
<span class="token-method">dotnet</span> add package <span class="token-type">Microsoft.Data.SqlClient</span>

<span class="token-comment">// Namespaces necesarios</span>
<span class="token-keyword">using</span> <span class="token-namespace">System.Data</span>;           <span class="token-comment">// Tipos genéricos: DataTable, DataSet</span>
<span class="token-keyword">using</span> <span class="token-namespace">System.Data.SqlClient</span>; <span class="token-comment">// Proveedor SQL Server específico</span>
<span class="token-keyword">using</span> <span class="token-namespace">Microsoft.Data.SqlClient</span>; <span class="token-comment">// Nuevo paquete (más actualizado)</span></code></pre>
                </div>
            </div>
        </section>

        <!-- Conexion -->
        <section id="conexion" class="section">
            <h2>3. Connection String</h2>

            <div class="note-box">
                <strong>¿Por qué Connection String en appsettings.json?</strong>
                <ul>
                    <li><strong>Separación de configuración:</strong> Cambia sin recompilar el código</li>
                    <li><strong>Seguridad:</strong> No guardas credenciales en el código fuente</li>
                    <li><strong>Ambientes:</strong> Distintos archivos para Development, Production, Testing</li>
                </ul>
            </div>

            <h3>Configuración de conexión</h3>
            <p><strong>Connection String</strong> = Cadena de texto con información para conectarse a una base de datos (servidor, nombre de BD, credenciales, opciones).</p>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">ConnectionConfig.cs</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26</div>
                    <pre><code><span class="token-comment">// Opción 1: En appsettings.json (RECOMENDADO)</span>
{
  <span class="token-string">"ConnectionStrings"</span>: {
    <span class="token-string">"DefaultConnection"</span>: <span class="token-string">"Server=(localdb)\mssqllocaldb;Database=UniversidadDB;Trusted_Connection=True;MultipleActiveResultSets=true"</span>,
    <span class="token-string">"Produccion"</span>: <span class="token-string">"Server=mi-servidor.database.windows.net;Database=UniversidadDB;User Id=usuario;Password=password;"</span>
  }
}

<span class="token-comment">// Leer en Program.cs</span>
<span class="token-keyword">var</span> connectionString = builder.Configuration
    .<span class="token-method">GetConnectionString</span>(<span class="token-string">"DefaultConnection"</span>);

builder.Services.<span class="token-method">AddSingleton</span>(connectionString);

<span class="token-comment">// ─────────────────────────────────────────────────────────────</span>

<span class="token-comment">// Opción 2: Connection String Builder (más seguro)</span>
<span class="token-keyword">var</span> builder = <span class="token-keyword">new</span> <span class="token-type">SqlConnectionStringBuilder</span>
{
    DataSource = <span class="token-string">@"(localdb)\mssqllocaldb"</span>,
    InitialCatalog = <span class="token-string">"UniversidadDB"</span>,
    IntegratedSecurity = <span class="token-keyword">true</span>,
    MultipleActiveResultSets = <span class="token-keyword">true</span>,
    ConnectTimeout = <span class="token-number">30</span>
};

<span class="token-keyword">string</span> connectionString = builder.ConnectionString;</code></pre>
                </div>
            </div>

            <h3>Usando SqlConnection</h3>
            <p><strong>using statement</strong> = Garantiza que los recursos (conexiones, archivos, etc.) se liberen correctamente, incluso si ocurre una excepción. Es equivalente a try-finally con Dispose().</p>

            <div class="warning-box">
                <strong>Errores Comunes sin using</strong>
                <ul>
                    <li><strong>Connection leaks:</strong> Conexiones que nunca se cierran agotan el pool</li>
                    <li><strong>Rendimiento degradado:</strong> El servidor se sobrecarga con conexiones abandonadas</li>
                    <li><strong>Errores de timeout:</strong> "Connection pool exhausted" cuando se agotan las conexiones</li>
                </ul>
            </div>

            <p><strong><abbr title="Repository - Patrón de diseño que abstrae el acceso a datos (encapsula ADO.NET)">Repository</abbr></strong> = Clase que encapsula toda la lógica de acceso a datos. Separa la lógica de negocio del código SQL.</p>

            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">EstudianteRepository.cs</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43</div>
                    <pre><code><span class="token-keyword">public class</span> <span class="token-class">EstudianteRepository</span>
{
    <span class="token-keyword">private readonly string</span> _connectionString;

    <span class="token-keyword">public</span> <span class="token-method">EstudianteRepository</span>(<span class="token-keyword">string</span> connectionString)
    {
        _connectionString = connectionString;
    }

    <span class="token-keyword">public</span> <span class="token-type">List&lt;Estudiante&gt;</span> <span class="token-method">ObtenerTodos</span>()
    {
        <span class="token-keyword">var</span> estudiantes = <span class="token-keyword">new</span> <span class="token-type">List&lt;Estudiante&gt;</span>();

        <span class="token-comment">// SIEMPRE usar 'using' para garantizar cierre de conexión</span>
        <span class="token-keyword">using</span> (<span class="token-keyword">var</span> connection = <span class="token-keyword">new</span> <span class="token-type">SqlConnection</span>(_connectionString))
        {
            connection.<span class="token-method">Open</span>();

            <span class="token-keyword">var</span> query = <span class="token-string">"SELECT Id, Codigo, Nombre, Email FROM Estudiantes"</span>;

            <span class="token-keyword">using</span> (<span class="token-keyword">var</span> command = <span class="token-keyword">new</span> <span class="token-type">SqlCommand</span>(query, connection))
            {
                <span class="token-keyword">using</span> (<span class="token-keyword">var</span> reader = command.<span class="token-method">ExecuteReader</span>())
                {
                    <span class="token-keyword">while</span> (reader.<span class="token-method">Read</span>())
                    {
                        estudiantes.<span class="token-method">Add</span>(<span class="token-keyword">new</span> <span class="token-type">Estudiante</span>
                        {
                            Id = reader.<span class="token-method">GetInt32</span>(<span class="token-number">0</span>),
                            Codigo = reader.<span class="token-method">GetString</span>(<span class="token-number">1</span>),
                            Nombre = reader.<span class="token-method">GetString</span>(<span class="token-number">2</span>),
                            Email = reader.<span class="token-method">IsDBNull</span>(<span class="token-number">3</span>) ? <span class="token-keyword">null</span> : reader.<span class="token-method">GetString</span>(<span class="token-number">3</span>)
                        });
                    }
                }
            }

            <span class="token-comment">// La conexión se cierra automáticamente al salir del using</span>
        }

        <span class="token-keyword">return</span> estudiantes;
    }
}</code></pre>
                </div>
            </div>

            <h3>SqlDataReader - Lectura de datos</h3>
            <p><strong><abbr title="DBNull - Valor especial que representa NULL en una base de datos">DBNull</abbr></strong> = Objeto especial que representa un valor NULL de base de datos. Es diferente de null de C#.</p>

            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">DataReaderMethods.cs</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22</div>
                    <pre><code><span class="token-comment">// Métodos del SqlDataReader</span>

<span class="token-comment">// Por índice (posición)</span>
<span class="token-keyword">int</span> id = reader.<span class="token-method">GetInt32</span>(<span class="token-number">0</span>);
<span class="token-keyword">string</span> nombre = reader.<span class="token-method">GetString</span>(<span class="token-number">1</span>);

<span class="token-comment">// Por nombre de columna</span>
<span class="token-keyword">string</span> email = reader.<span class="token-method">GetString</span>(reader.<span class="token-method">GetOrdinal</span>(<span class="token-string">"Email"</span>));

<span class="token-comment">// Verificar NULL</span>
<span class="token-keyword">if</span> (!reader.<span class="token-method">IsDBNull</span>(<span class="token-number">3</span>))
{
    email = reader.<span class="token-method">GetString</span>(<span class="token-number">3</span>);
}

<span class="token-comment">// Cast genérico (más lento pero flexible)</span>
<span class="token-keyword">int</span> id = (<span class="token-keyword">int</span>)reader[<span class="token-string">"Id"</span>];
<span class="token-keyword">string</span> nombre = reader[<span class="token-string">"Nombre"</span>].<span class="token-method">ToString</span>();

<span class="token-comment">// Tipos disponibles:</span>
<span class="token-comment">// GetInt32(), GetInt64(), GetString(), GetDateTime()</span>
<span class="token-comment">// GetDecimal(), GetDouble(), GetBoolean(), GetByte()</span></code></pre>
                </div>
            </div>
        </section>

        <!-- CRUD -->
        <section id="crud" class="section">
            <h2>4. Operaciones <abbr title="CRUD - Create, Read, Update, Delete (Crear, Leer, Actualizar, Eliminar)">CRUD</abbr></h2>

            <h3>Create (INSERT)</h3>
            <p><strong><abbr title="SCOPE_IDENTITY() - Función de SQL Server que retorna el último valor de identidad generado en la sesión actual">SCOPE_IDENTITY()</abbr></strong> = Función de SQL Server que retorna el último ID auto-generado en la sesión actual (evita conflictos con otras transacciones simultáneas).</p>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">CreateOperation.cs</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24</div>
                    <pre><code><span class="token-keyword">public async</span> <span class="token-type">Task&lt;int&gt;</span> <span class="token-method">CrearAsync</span>(<span class="token-type">Estudiante</span> estudiante)
{
    <span class="token-keyword">using var</span> connection = <span class="token-keyword">new</span> <span class="token-type">SqlConnection</span>(_connectionString);
    <span class="token-keyword">await</span> connection.<span class="token-method">OpenAsync</span>();

    <span class="token-keyword">var</span> query = <span class="token-string">@"
        INSERT INTO Estudiantes (Codigo, Nombre, Email, FechaRegistro)
        VALUES (@Codigo, @Nombre, @Email, @FechaRegistro);
        SELECT SCOPE_IDENTITY();"</span>;  <span class="token-comment">// Retorna el ID generado</span>

    <span class="token-keyword">using var</span> command = <span class="token-keyword">new</span> <span class="token-type">SqlCommand</span>(query, connection);

    <span class="token-comment">// Agregar parámetros (EVITA SQL INJECTION)</span>
    command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Codigo"</span>, estudiante.Codigo);
    command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Nombre"</span>, estudiante.Nombre);
    command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Email"</span>,
        (<span class="token-keyword">object</span>)estudiante.Email ?? <span class="token-type">DBNull</span>.Value);
    command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@FechaRegistro"</span>, <span class="token-type">DateTime</span>.Now);

    <span class="token-comment">// ExecuteScalar para retornar un solo valor (el ID)</span>
    <span class="token-keyword">var</span> id = <span class="token-type">Convert</span>.<span class="token-method">ToInt32</span>(<span class="token-keyword">await</span> command.<span class="token-method">ExecuteScalarAsync</span>());

    <span class="token-keyword">return</span> id;
}</code></pre>
                </div>
            </div>

            <h3>Read (SELECT)</h3>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">ReadOperation.cs</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38</div>
                    <pre><code><span class="token-keyword">public async</span> <span class="token-type">Task&lt;Estudiante&gt;</span> <span class="token-method">ObtenerPorIdAsync</span>(<span class="token-keyword">int</span> id)
{
    <span class="token-keyword">using var</span> connection = <span class="token-keyword">new</span> <span class="token-type">SqlConnection</span>(_connectionString);
    <span class="token-keyword">await</span> connection.<span class="token-method">OpenAsync</span>();

    <span class="token-keyword">var</span> query = <span class="token-string">"SELECT Id, Codigo, Nombre, Email FROM Estudiantes WHERE Id = @Id"</span>;

    <span class="token-keyword">using var</span> command = <span class="token-keyword">new</span> <span class="token-type">SqlCommand</span>(query, connection);
    command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Id"</span>, id);

    <span class="token-keyword">using var</span> reader = <span class="token-keyword">await</span> command.<span class="token-method">ExecuteReaderAsync</span>();

    <span class="token-keyword">if</span> (<span class="token-keyword">await</span> reader.<span class="token-method">ReadAsync</span>())
    {
        <span class="token-keyword">return new</span> <span class="token-type">Estudiante</span>
        {
            Id = reader.<span class="token-method">GetInt32</span>(<span class="token-number">0</span>),
            Codigo = reader.<span class="token-method">GetString</span>(<span class="token-number">1</span>),
            Nombre = reader.<span class="token-method">GetString</span>(<span class="token-number">2</span>),
            Email = reader.<span class="token-method">IsDBNull</span>(<span class="token-number">3</span>) ? <span class="token-keyword">null</span> : reader.<span class="token-method">GetString</span>(<span class="token-number">3</span>)
        };
    }

    <span class="token-keyword">return null</span>;  <span class="token-comment">// No encontrado</span>
}

<span class="token-keyword">private</span> <span class="token-type">Estudiante</span> <span class="token-method">MapFromReader</span>(<span class="token-type">SqlDataReader</span> reader)
{
    <span class="token-keyword">return new</span> <span class="token-type">Estudiante</span>
    {
        Id = reader.<span class="token-method">GetInt32</span>(reader.<span class="token-method">GetOrdinal</span>(<span class="token-string">"Id"</span>)),
        Codigo = reader.<span class="token-method">GetString</span>(reader.<span class="token-method">GetOrdinal</span>(<span class="token-string">"Codigo"</span>)),
        Nombre = reader.<span class="token-method">GetString</span>(reader.<span class="token-method">GetOrdinal</span>(<span class="token-string">"Nombre"</span>)),
        Email = reader.<span class="token-method">IsDBNull</span>(reader.<span class="token-method">GetOrdinal</span>(<span class="token-string">"Email"</span>))
            ? <span class="token-keyword">null</span>
            : reader.<span class="token-method">GetString</span>(reader.<span class="token-method">GetOrdinal</span>(<span class="token-string">"Email"</span>))
    };
}</code></pre>
                </div>
            </div>

            <h3>Update (UPDATE)</h3>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">UpdateOperation.cs</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24</div>
                    <pre><code><span class="token-keyword">public async</span> <span class="token-type">Task&lt;bool&gt;</span> <span class="token-method">ActualizarAsync</span>(<span class="token-type">Estudiante</span> estudiante)
{
    <span class="token-keyword">using var</span> connection = <span class="token-keyword">new</span> <span class="token-type">SqlConnection</span>(_connectionString);
    <span class="token-keyword">await</span> connection.<span class="token-method">OpenAsync</span>();

    <span class="token-keyword">var</span> query = <span class="token-string">@"
        UPDATE Estudiantes
        SET Codigo = @Codigo,
            Nombre = @Nombre,
            Email = @Email
        WHERE Id = @Id"</span>;

    <span class="token-keyword">using var</span> command = <span class="token-keyword">new</span> <span class="token-type">SqlCommand</span>(query, connection);
    command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Id"</span>, estudiante.Id);
    command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Codigo"</span>, estudiante.Codigo);
    command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Nombre"</span>, estudiante.Nombre);
    command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Email"</span>,
        (<span class="token-keyword">object</span>)estudiante.Email ?? <span class="token-type">DBNull</span>.Value);

    <span class="token-comment">// ExecuteNonQuery retorna número de filas afectadas</span>
    <span class="token-keyword">int</span> filasAfectadas = <span class="token-keyword">await</span> command.<span class="token-method">ExecuteNonQueryAsync</span>();

    <span class="token-keyword">return</span> filasAfectadas &gt; <span class="token-number">0</span>;  <span class="token-comment">// True si se actualizó</span>
}</code></pre>
                </div>
            </div>

            <h3>Delete (DELETE)</h3>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">DeleteOperation.cs</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32</div>
                    <pre><code><span class="token-keyword">public async</span> <span class="token-type">Task&lt;bool&gt;</span> <span class="token-method">EliminarAsync</span>(<span class="token-keyword">int</span> id)
{
    <span class="token-keyword">using var</span> connection = <span class="token-keyword">new</span> <span class="token-type">SqlConnection</span>(_connectionString);
    <span class="token-keyword">await</span> connection.<span class="token-method">OpenAsync</span>();

    <span class="token-keyword">var</span> query = <span class="token-string">"DELETE FROM Estudiantes WHERE Id = @Id"</span>;

    <span class="token-keyword">using var</span> command = <span class="token-keyword">new</span> <span class="token-type">SqlCommand</span>(query, connection);
    command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Id"</span>, id);

    <span class="token-keyword">int</span> filasAfectadas = <span class="token-keyword">await</span> command.<span class="token-method">ExecuteNonQueryAsync</span>();

    <span class="token-keyword">return</span> filasAfectadas &gt; <span class="token-number">0</span>;
}

<span class="token-comment">// Alternativa: Eliminación lógica (más segura)</span>
<span class="token-keyword">public async</span> <span class="token-type">Task&lt;bool&gt;</span> <span class="token-method">DesactivarAsync</span>(<span class="token-keyword">int</span> id)
{
    <span class="token-keyword">using var</span> connection = <span class="token-keyword">new</span> <span class="token-type">SqlConnection</span>(_connectionString);
    <span class="token-keyword">await</span> connection.<span class="token-method">OpenAsync</span>();

    <span class="token-keyword">var</span> query = <span class="token-string">@"
        UPDATE Estudiantes
        SET Activo = 0, FechaEliminacion = @Fecha
        WHERE Id = @Id"</span>;

    <span class="token-keyword">using var</span> command = <span class="token-keyword">new</span> <span class="token-type">SqlCommand</span>(query, connection);
    command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Id"</span>, id);
    command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Fecha"</span>, <span class="token-type">DateTime</span>.Now);

    <span class="token-keyword">return await</span> command.<span class="token-method">ExecuteNonQueryAsync</span>() &gt; <span class="token-number">0</span>;
}</code></pre>
                </div>
            </div>

            <h3>Métodos de Ejecución</h3>
            <table class="tag-table">
                <thead>
                    <tr>
                        <th>Método</th>
                        <th>Retorna</th>
                        <th>Uso</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>ExecuteReader()</strong></td>
                        <td>SqlDataReader</td>
                        <td>SELECT (múltiples filas)</td>
                    </tr>
                    <tr>
                        <td><strong>ExecuteScalar()</strong></td>
                        <td>object</td>
                        <td>SELECT COUNT(*), SUM(), MAX(), SCOPE_IDENTITY()</td>
                    </tr>
                    <tr>
                        <td><strong>ExecuteNonQuery()</strong></td>
                        <td>int</td>
                        <td>INSERT, UPDATE, DELETE, CREATE TABLE</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Transacciones -->
        <section id="transacciones" class="section">
            <h2>5. Manejo de Transacciones</h2>

            <div class="note-box">
                <strong>¿Por qué Transacciones?</strong>
                <ul>
                    <li><strong>Atomicidad:</strong> O todas las operaciones se completan, o ninguna</li>
                    <li><strong>Consistencia:</strong> Los datos siempre remaincen en un estado válido</li>
                    <li><strong>Ejemplo:</strong> Transferencia bancaria: DEBITAR origen Y ACREDITAR destino, o ninguna de las dos</li>
                </ul>
            </div>

            <h3>Transacciones en ADO.NET</h3>
            <p><strong><abbr title="Transaction - Unidad de trabajo compuesta por múltiples operaciones que deben ejecutarse todas o ninguna">Transaction</abbr></strong> = Unidad de trabajo compuesta por múltiples operaciones SQL que deben ejecutarse todas o ninguna (ACID).</p>
            <p><strong>Commit</strong> = Confirmar la transacción (aplicar todos los cambios permanentemente).</p>
            <p><strong>Rollback</strong> = Deshacer la transacción (revertir todos los cambios si algo falla).</p>
            <p><strong>async/await</strong> = Palabras clave de C# para programación asíncrona. async marca un método como asíncrono, await espera un resultado sin bloquear el hilo.</p>

            <div class="warning-box">
                <strong>Errores Comunes con Transacciones</strong>
                <ul>
                    <li><strong>Olvidar pasar el objeto transaction a SqlCommand:</strong> Los comandos se ejecutan FUERA de la transacción</li>
                    <li><strong>No llamar Commit():</strong> La transacción se deshace automáticamente (rollback implícito)</li>
                    <li><strong>Excepciones no manejadas:</strong> Siempre envolver en try-catch para llamar Rollback()</li>
                </ul>
            </div>

            <h4>Consistencia de datos</h4>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">TransactionExample.cs</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49</div>
                    <pre><code><span class="token-keyword">public async</span> <span class="token-type">Task&lt;bool&gt;</span> <span class="token-method">TransferirEstudianteAsync</span>(
    <span class="token-keyword">int</span> estudianteId, <span class="token-keyword">int</span> carreraOrigenId, <span class="token-keyword">int</span> carreraDestinoId)
{
    <span class="token-keyword">using var</span> connection = <span class="token-keyword">new</span> <span class="token-type">SqlConnection</span>(_connectionString);
    <span class="token-keyword">await</span> connection.<span class="token-method">OpenAsync</span>();

    <span class="token-comment">// Iniciar transacción</span>
    <span class="token-keyword">using var</span> transaction = connection.<span class="token-method">BeginTransaction</span>();

    <span class="token-keyword">try</span>
    {
        <span class="token-comment">// 1. Registrar historial de transferencia</span>
        <span class="token-keyword">var</span> query1 = <span class="token-string">@"INSERT INTO HistorialTransferencias
                       (EstudianteId, CarreraOrigenId, CarreraDestinoId, Fecha)
                       VALUES (@EstId, @OrigId, @DestId, @Fecha)"</span>;

        <span class="token-keyword">using</span> (<span class="token-keyword">var</span> cmd1 = <span class="token-keyword">new</span> <span class="token-type">SqlCommand</span>(query1, connection, transaction))
        {
            cmd1.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@EstId"</span>, estudianteId);
            cmd1.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@OrigId"</span>, carreraOrigenId);
            cmd1.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@DestId"</span>, carreraDestinoId);
            cmd1.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Fecha"</span>, <span class="token-type">DateTime</span>.Now);
            <span class="token-keyword">await</span> cmd1.<span class="token-method">ExecuteNonQueryAsync</span>();
        }

        <span class="token-comment">// 2. Actualizar carrera del estudiante</span>
        <span class="token-keyword">var</span> query2 = <span class="token-string">@"UPDATE Estudiantes
                       SET CarreraId = @CarreraId
                       WHERE Id = @Id"</span>;

        <span class="token-keyword">using</span> (<span class="token-keyword">var</span> cmd2 = <span class="token-keyword">new</span> <span class="token-type">SqlCommand</span>(query2, connection, transaction))
        {
            cmd2.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@CarreraId"</span>, carreraDestinoId);
            cmd2.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Id"</span>, estudianteId);
            <span class="token-keyword">await</span> cmd2.<span class="token-method">ExecuteNonQueryAsync</span>();
        }

        <span class="token-comment">// Si todo va bien, confirmar transacción</span>
        transaction.<span class="token-method">Commit</span>();
        <span class="token-keyword">return true</span>;
    }
    <span class="token-keyword">catch</span> (<span class="token-type">Exception</span> ex)
    {
        <span class="token-comment">// Si hay error, deshacer todo</span>
        transaction.<span class="token-method">Rollback</span>();
        _logger.<span class="token-method">LogError</span>(ex, <span class="token-string">"Error en transferencia"</span>);
        <span class="token-keyword">return false</span>;
    }
}</code></pre>
                </div>
            </div>
        </section>

        <!-- Buenas Practicas -->
        <section id="buenas-practicas" class="section">
            <h2>6. Buenas Prácticas</h2>

            <div class="checklist-box">
                <strong>✅ SIEMPRE USAR USING</strong>
                <ul>
                    <li>SqlConnection, SqlCommand, SqlDataReader</li>
                    <li>Garantiza liberación de recursos</li>
                </ul>
            </div>

            <div class="warning-box">
                <strong>❌ NUNCA concatenar strings para SQL</strong>
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-dots">
                            <span class="code-dot red"></span>
                            <span class="code-dot yellow"></span>
                            <span class="code-dot green"></span>
                        </div>
                        <span class="code-title">SQLInjectionWarning.cs</span>
                    </div>
                    <div class="code-content">
                        <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6</div>
                        <pre><code><span class="token-comment">// VULNERABLE A SQL INJECTION</span>
<span class="token-keyword">var</span> sql = <span class="token-string">$"SELECT * FROM Users WHERE Id = {id}"</span>;

<span class="token-comment">// SEGURO CON PARÁMETROS</span>
command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Id"</span>, id);</code></pre>
                    </div>
                </div>
            </div>

            <div class="checklist-box">
                <strong>✅ CERRAR CONEXIONES RÁPIDO</strong>
                <ul>
                    <li>Abrir justo antes de usar</li>
                    <li>Cerrar inmediatamente después</li>
                    <li>NO mantener conexiones abiertas</li>
                </ul>
            </div>

            <div class="checklist-box">
                <strong>✅ USAR ASYNC/AWAIT</strong>
                <ul>
                    <li>ExecuteReaderAsync(), ExecuteNonQueryAsync()</li>
                    <li>Mejor rendimiento en aplicaciones web</li>
                </ul>
            </div>

            <div class="checklist-box">
                <strong>✅ MANEJAR NULLS</strong>
                <ul>
                    <li>Usar DBNull.Value para valores nulos</li>
                    <li>Verificar IsDBNull() al leer</li>
                </ul>
            </div>

            <div class="checklist-box">
                <strong>✅ USAR TRANSACCIONES</strong>
                <ul>
                    <li>Para operaciones múltiples relacionadas</li>
                    <li>Mantiene consistencia de datos</li>
                </ul>
            </div>

            <h3>Connection Pooling</h3>
            <p><strong><abbr title="Connection Pooling - Mecanismo que reutiliza conexiones físicas existentes en lugar de crear nuevas">Connection Pooling</abbr></strong> = Reutilización automática de conexiones físicas para mejorar rendimiento. En lugar de abrir/cerrar conexiones reales, ADO.NET mantiene un "pool" de conexiones disponibles.</p>
            <p><strong>¿Por qué Connection Pooling?</strong> Abrir una conexión física es costoso (miles de milisegundos). Reutilizar conexiones existentes toma microsegundos.</p>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">ConnectionPooling.config</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10</div>
                    <pre><code><span class="token-comment">// Connection Pool está activado por defecto</span>
<span class="token-comment">// Configuración en connection string:</span>

<span class="token-string">"Server=localhost;Database=UniversidadDB;Integrated Security=true;
Connection Lifetime=60;              // Tiempo vida conexión (seg)
Max Pool Size=100;                   // Máximo conexiones
Min Pool Size=5;                     // Mínimo conexiones
Pooling=true;                        // Activar (default)
Connection Reset=true;               // Reset al devolver al pool
Connection Timeout=15;"</span>              <span class="token-comment">// Timeout conexión (seg)</span></code></pre>
                </div>
            </div>
        </section>

        <!-- SQL Injection -->
        <section id="sql-injection" class="section">
            <h2>7. SQL Injection</h2>

            <div class="note-box">
                <strong>¿Por qué SQL Injection es peligroso?</strong>
                <ul>
                    <li><strong>Robo de datos:</strong> Atacante puede leer toda la base de datos</li>
                    <li><strong>Destrucción:</strong> DROP TABLE elimina datos permanentemente</li>
                    <li><strong>Bypass autenticación:</strong> Login sin contraseña válida</li>
                    <li><strong>OWASP #1:</strong> Consistentemente #1 vulnerabilidad web más crítica</li>
                </ul>
            </div>

            <h3>¿Qué es SQL Injection?</h3>
            <p><strong><abbr title="SQL Injection - Vulnerabilidad que permite inyectar código SQL malicioso manipulando la entrada del usuario">SQL Injection</abbr></strong> = Ataque donde un usuario malintencionado inyecta código SQL manipulando los inputs de la aplicación.</p>

            <h4>El peligro de concatenar strings</h4>
            <div class="warning-box">
                <strong>⚠️ VULNERABLE A SQL INJECTION</strong>
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-dots">
                            <span class="code-dot red"></span>
                            <span class="code-dot yellow"></span>
                            <span class="code-dot green"></span>
                        </div>
                        <span class="code-title">SQLInjectionVulnerable.cs</span>
                    </div>
                    <div class="code-content">
                        <div class="line-numbers">1<br>2<br>3<br>4<br>5</div>
                        <pre><code><span class="token-keyword">var</span> query = <span class="token-string">$"SELECT * FROM Estudiantes WHERE Codigo = '{codigo}'"</span>;
<span class="token-comment">// Si codigo = "'; DROP TABLE Estudiantes; --"</span>
<span class="token-comment">// Query resultante: SELECT * FROM Estudiantes WHERE Codigo = '';</span>
<span class="token-comment">//                    DROP TABLE Estudiantes; --'</span>
<span class="token-comment">//  DESASTRE!</span></code></pre>
                    </div>
                </div>
            </div>

            <div class="checklist-box">
                <strong>✅ SEGURO CON PARÁMETROS</strong>
                <div class="code-block">
                    <div class="code-header">
                        <div class="code-dots">
                            <span class="code-dot red"></span>
                            <span class="code-dot yellow"></span>
                            <span class="code-dot green"></span>
                        </div>
                        <span class="code-title">SQLInjectionSafe.cs</span>
                    </div>
                    <div class="code-content">
                        <div class="line-numbers">1<br>2<br>3</div>
                        <pre><code><span class="token-keyword">var</span> query = <span class="token-string">"SELECT * FROM Estudiantes WHERE Codigo = @Codigo"</span>;
command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Codigo"</span>, codigo);
<span class="token-comment">// El parámetro se escapa automáticamente</span></code></pre>
                    </div>
                </div>
            </div>

            <div class="note-box">
                <strong>Mini-Chequeo: SQL Injection</strong>
                <ul>
                    <li>¿Por qué concatenar strings es vulnerable?</li>
                    <li>¿Cómo los parámetros previenen SQL Injection?</li>
                    <li>¿Puedes explicar el ataque con "'; DROP TABLE Estudiantes; --"?</li>
                </ul>
            </div>
        </section>
        </section>

        <!-- Ejemplos -->
        <section id="ejemplos" class="section">
            <h2>Ejemplos</h2>
            <p>Los ejemplos de código están integrados en las secciones teóricas anteriores. Consulte cada sección para ver ejemplos prácticos de:</p>
            <ul>
                <li>Conexión a bases de datos con SqlConnection</li>
                <li>Operaciones CRUD con SqlCommand</li>
                <li>Uso de SqlDataReaders y DataSets</li>
                <li>Implementación de transacciones</li>
                <li>Buenas prácticas de seguridad</li>
            </ul>
        </section>

        <!-- Práctica / Laboratorio -->
        <section id="practica" class="section actividad">
            <h3>Actividad: Repositorio ADO.NET CRUD</h3>
            <p><strong>Tipo:</strong> Opcional / práctica</p>
            <p><strong>Relacionado con:</strong> Ninguno</p>
            <p><strong>Entregable:</strong> Repositorio ADO.NET con operaciones CRUD para Estudiantes</p>
            <p><strong>Tiempo estimado:</strong> 40 min</p>
            <p><strong>Criterios de éxito:</strong> Comprensión de SqlConnection, SqlCommand, SqlDataReader</p>
            <h2>Práctica / Laboratorio</h2>
            <p><strong>Duración estimada:</strong> 40 minutos</p>
            <p><strong>Objetivo:</strong> Implementar un repositorio ADO.NET completo con operaciones CRUD para Estudiantes.</p>

            <h3>Pasos en Visual Studio 2022</h3>
            <ol>
                <li>Abre Visual Studio 2022 y crea un nuevo proyecto <strong>Console App</strong> con .NET 8</li>
                <li>Instala el paquete NuGet: <code>Microsoft.Data.SqlClient</code></li>
                <li>En <code>appsettings.json</code>, configura la connection string para LocalDB</li>
                <li>Crea la base de datos con el script SQL provisto por el docente</li>
                <li>Implementa la clase <code>EstudianteRepository</code> con todos los métodos CRUD</li>
                <li>Usa <code>using</code> statements para SqlConnection, SqlCommand y SqlDataReader</li>
                <li>Usa parámetros en todas las queries para evitar SQL Injection</li>
                <li>Prueba cada método con datos de prueba en el Main</li>
            </ol>

            <h3>Checklist de verificación</h3>
            <ul>
                <li>✅ El proyecto compila sin errores</li>
                <li>✅ La connection string está configurada correctamente en appsettings.json</li>
                <li>✅ Todos los métodos usan <code>using</code> para SqlConnection y SqlCommand</li>
                <li>✅ Todas las queries usan parámetros (@Nombre, @Codigo, etc.)</li>
                <li>✅ El método Crear retorna el ID generado con SCOPE_IDENTITY()</li>
                <li>✅ El método ObtenerPorId retorna null cuando no encuentra registros</li>
                <li>✅ Los métodos UPDATE y DELETE verifican filas afectadas (> 0)</li>
            </ul>

            <h3>Ejemplo de implementación</h3>
            <div class="code-block">
                <div class="code-header">
                    <div class="code-dots">
                        <span class="code-dot red"></span>
                        <span class="code-dot yellow"></span>
                        <span class="code-dot green"></span>
                    </div>
                    <span class="code-title">EstudianteRepositoryExample.cs</span>
                </div>
                <div class="code-content">
                    <div class="line-numbers">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29</div>
                    <pre><code><span class="token-keyword">public class</span> <span class="token-class">EstudianteRepository</span>
{
    <span class="token-keyword">private readonly string</span> _connectionString;

    <span class="token-keyword">public</span> <span class="token-method">EstudianteRepository</span>(<span class="token-keyword">string</span> connectionString)
    {
        _connectionString = connectionString;
    }

    <span class="token-keyword">public async</span> <span class="token-type">Task&lt;int&gt;</span> <span class="token-method">CrearAsync</span>(<span class="token-type">Estudiante</span> estudiante)
    {
        <span class="token-keyword">using var</span> connection = <span class="token-keyword">new</span> <span class="token-type">SqlConnection</span>(_connectionString);
        <span class="token-keyword">await</span> connection.<span class="token-method">OpenAsync</span>();

        <span class="token-keyword">var</span> query = <span class="token-string">@"
            INSERT INTO Estudiantes (Codigo, Nombre, Email)
            VALUES (@Codigo, @Nombre, @Email);
            SELECT SCOPE_IDENTITY();"</span>;

        <span class="token-keyword">using var</span> command = <span class="token-keyword">new</span> <span class="token-type">SqlCommand</span>(query, connection);
        command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Codigo"</span>, estudiante.Codigo);
        command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Nombre"</span>, estudiante.Nombre);
        command.Parameters.<span class="token-method">AddWithValue</span>(<span class="token-string">"@Email"</span>,
            (<span class="token-keyword">object</span>)estudiante.Email ?? <span class="token-type">DBNull</span>.Value);

        <span class="token-keyword">var</span> id = <span class="token-type">Convert</span>.<span class="token-method">ToInt32</span>(<span class="token-keyword">await</span> command.<span class="token-method">ExecuteScalarAsync</span>());
        <span class="token-keyword">return</span> id;
    }
}</code></pre>
                </div>
            </div>

            <h3>Errores comunes a evitar</h3>
            <ul>
                <li>❌ No usar <code>using</code> para SqlConnection (connection leaks)</li>
                <li>❌ Concatenar strings para armar queries (SQL Injection)</li>
                <li>❌ Olvidar llamar a Open() antes de ejecutar comandos</li>
                <li>❌ No usar async/await en aplicaciones web/consola modernas</li>
                <li>❌ No verificar DBNull cuando leemos valores NULL de la DB</li>
            </ul>
        </section>

        <!-- Ejercicios -->
        <section id="ejercicios" class="section">
            <h2>Ejercicios Prácticos</h2>

            <h3>Ejercicio 1: CRUD Completo</h3>
            <p><strong>Duración estimada:</strong> 30 minutos</p>
            <p>Implementar las 4 operaciones CRUD para la entidad Estudiante.</p>
            <h4>Checklist:</h4>
            <ul>
                <li>✅ Create con parámetros y SCOPE_IDENTITY()</li>
                <li>✅ Read con SqlDataReader y using statements</li>
                <li>✅ Update verificando filas afectadas</li>
                <li>✅ Delete con parámetro @Id</li>
            </ul>

            <h3>Ejercicio 2: Transacciones</h3>
            <p><strong>Duración estimada:</strong> 20 minutos</p>
            <p>Implementar una transacción para transferir estudiante entre carreras.</p>
            <h4>Checklist:</h4>
            <ul>
                <li>✅ Usar BeginTransaction() antes de las operaciones</li>
                <li>✅ Commit() si todas las operaciones tienen éxito</li>
                <li>✅ Rollback() en el bloque catch si hay error</li>
                <li>✅ Pasar el objeto transaction a cada SqlCommand</li>
            </ul>

            <h3>Ejercicio Integrador: Repository de Estudiantes</h3>
            <p><strong>Duración estimada:</strong> 45 minutos</p>
            <p>Crear clase EstudianteRepository con métodos:</p>
            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Método</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td><code>Crear(Estudiante estudiante) : Task&lt;int&gt;</code> - Insertar nuevo estudiante, retornar ID generado</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td><code>ObtenerPorId(int id) : Task&lt;Estudiante&gt;</code> - Buscar por ID, retornar null si no existe</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td><code>ObtenerTodos() : Task&lt;List&lt;Estudiante&gt;&gt;</code> - Lista completa ordenada por nombre</td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td><code>Actualizar(Estudiante estudiante) : Task&lt;bool&gt;;</code> - Actualizar datos, retornar true si se actualizó</td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td><code>Eliminar(int id) : Task&lt;bool&gt;;</code> - Eliminar físicamente</td>
                    </tr>
                    <tr>
                        <td>6</td>
                        <td><code>BuscarPorNombre(string término) : Task&lt;List&lt;Estudiante&gt;&gt;;</code> - Búsqueda parcial con LIKE</td>
                    </tr>
                </tbody>
            </table>

            <h4>REQUISITOS:</h4>
            <h4>Checklist:</h4>
            <ul>
                <li>✅ Usar parámetros en todas las queries</li>
                <li>✅ Usar async/await</li>
                <li>✅ Usar transacción en método CrearConMateriasIniciales</li>
            </ul>
        </section>

        <!-- Referencias -->
        <section id="referencias" class="section">
            <h2>Referencias y Recursos</h2>

            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>Recurso</th>
                        <th>Enlace</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>ADO.NET Docs</td>
                        <td><a href="https://learn.microsoft.com/en-us/dotnet/framework/data/adonet/index" target="_blank">docs.microsoft.com/dotnet/framework/data/adonet</a></td>
                    </tr>
                    <tr>
                        <td>SqlConnection API</td>
                        <td><a href="https://learn.microsoft.com/en-us/dotnet/api/system.data.sqlclient" target="_blank">docs.microsoft.com/dotnet/api/system.data.sqlclient</a></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Resumen -->
        <section id="resumen" class="section">
            <h2>Resumen de la Clase</h2>
            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>Concepto</th>
                        <th>Descripción</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>SqlConnection</strong></td>
                        <td>Conexión a base de datos</td>
                    </tr>
                    <tr>
                        <td><strong>SqlCommand</strong></td>
                        <td>Ejecutar SQL</td>
                    </tr>
                    <tr>
                        <td><strong>SqlDataReader</strong></td>
                        <td>Leer resultados (forward-only)</td>
                    </tr>
                    <tr>
                        <td><strong>ExecuteReader</strong></td>
                        <td>Para SELECT</td>
                    </tr>
                    <tr>
                        <td><strong>ExecuteScalar</strong></td>
                        <td>Para valor único (COUNT, etc.)</td>
                    </tr>
                    <tr>
                        <td><strong>ExecuteNonQuery</strong></td>
                        <td>Para INSERT, UPDATE, DELETE</td>
                    </tr>
                    <tr>
                        <td><strong>Parameters</strong></td>
                        <td>Protección contra SQL Injection</td>
                    </tr>
                    <tr>
                        <td><strong>Transaction</strong></td>
                        <td>Consistencia en operaciones múltiples</td>
                    </tr>
                    <tr>
                        <td><strong>Connection Pooling</strong></td>
                        <td>Reutilización de conexiones</td>
                    </tr>
                    <tr>
                        <td><strong>SqlDataAdapter</strong></td>
                        <td>Modo desconectado (DataTable)</td>
                    </tr>
                    <tr>
                        <td><strong>Stored Procedures</strong></td>
                        <td>Procedimientos en SQL</td>
                    </tr>
                    <tr>
                        <td><strong>Exception Handling</strong></td>
                        <td>Manejo de errores SQL</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Proxima Clase -->
        <section class="section">
            <h2>Próxima Clase: Entity Framework Core</h2>
            <table class="objectives-table">
                <thead>
                    <tr>
                        <th>Tema</th>
                        <th>Descripción</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>EF Core</strong></td>
                        <td>DbContext y DbSet</td>
                    </tr>
                    <tr>
                        <td><strong>Code First</strong></td>
                        <td>Migrations</td>
                    </tr>
                    <tr>
                        <td><strong>LINQ to Entities</strong></td>
                        <td>Consultas LINQ, Eager Loading (Include)</td>
                    </tr>
                    <tr>
                        <td><strong>Relaciones</strong></td>
                        <td>One-to-Many, Many-to-Many</td>
                    </tr>
                    <tr>
                        <td><strong>Comparación</strong></td>
                        <td>ADO.NET vs EF Core</td>
                    </tr>
                </tbody>
            </table>
        </section>
    </main>

    <footer class="footer">
        <p><strong>"ADO.NET: Control total sobre tus datos"</strong></p>
        <p>UNAULA - Ingeniería Informática - 2026-I</p>
        <p>IF0100 - Lenguaje de Programación Orientada a Objetos II</p>
    </footer>
</body>
</html>