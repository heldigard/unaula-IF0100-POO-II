<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clase 13 - CRUD con ADO.NET y SQL Server | IF0100 - POO II</title>
  <style>
    :root {
      --bg: #f7f7f4;
      --ink: #1f2933;
      --muted: #52606d;
      --brand: #1e3a8a;
      --accent: #3b82f6;
      --card: #ffffff;
      --line: #d9e2ec;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "IBM Plex Sans", "Segoe UI", Tahoma, sans-serif;
      color: var(--ink);
      background: var(--bg);
      line-height: 1.65;
    }
    header {
      background: linear-gradient(135deg, #0b2d6b, #1e40af);
      color: #fff;
      padding: 36px 20px 28px;
    }
    header .wrap { max-width: 1100px; margin: 0 auto; }
    header h1 {
      font-family: "Merriweather", Georgia, serif;
      margin: 8px 0 10px;
      font-size: 2.2rem;
    }
    header .meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-top: 18px;
      background: rgba(255, 255, 255, 0.12);
      padding: 16px;
      border-radius: 12px;
    }
    header ul { margin: 8px 0 0 18px; }
    nav {
      max-width: 1100px;
      margin: 18px auto 0;
      padding: 14px 18px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
    }
    nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px 14px;
    }
    nav a {
      color: var(--brand);
      text-decoration: none;
      padding: 8px 10px;
      border-radius: 8px;
      background: #eef2ff;
      display: block;
    }
    nav a:hover { background: #dbeafe; }
    main { max-width: 1100px; margin: 18px auto 60px; padding: 0 20px; }
    section {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 22px;
      margin: 18px 0;
    }
    h2 { margin-top: 0; color: var(--brand); font-size: 1.6rem; border-bottom: 3px solid var(--accent); padding-bottom: 6px; }
    h3 { color: #0b2d6b; margin-top: 20px; }
    h4 { color: #2f4b7c; margin-top: 16px; }
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      align-items: start;
    }
    .note {
      background: #f0f4ff;
      border-left: 4px solid var(--accent);
      padding: 10px 12px;
      border-radius: 8px;
      color: var(--muted);
    }
    pre {
      background: #0b1020;
      color: #e2e8f0;
      padding: 14px;
      border-radius: 10px;
      overflow-x: auto;
    }
    code { font-family: "Cascadia Code", Consolas, monospace; font-size: 0.95rem; }
    table { width: 100%; border-collapse: collapse; margin: 10px 0; }
    th, td { border: 1px solid var(--line); padding: 8px 10px; text-align: left; }
    th { background: #f1f5f9; }
    /* Syntax highlighting para C# */
    .token-keyword { color: #c792ea; font-weight: 600; }
    .token-type { color: #ffcb6b; }
    .token-string { color: #c3e88d; }
    .token-comment { color: #546e7a; font-style: italic; }
    .token-number { color: #f78c6c; }
    .token-operator { color: #89ddff; }
    /* Accessibility */
    abbr[title] { text-decoration: underline dotted; cursor: help; }
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--brand);
      color: #fff;
      padding: 8px 16px;
      text-decoration: none;
      z-index: 100;
      transition: top 0.3s;
    }
    .skip-link:focus {
      top: 0;
    }
    /* Print styles */
    @media print {
      header, nav, footer { background: white !important; color: black !important; }
      a[href]:after { content: " (" attr(href) ")"; font-size: 0.8em; }
      pre, code { white-space: pre-wrap; }
    }

    /* BLOQUES DE C√ìDIGO MEJORADOS */
    .code-block {
      background: #1e1e2e;
      border-radius: 12px;
      margin: 16px 0;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      border: 1px solid #313244;
    }

    .code-header {
      background: linear-gradient(90deg, #313244 0%, #45475a 100%);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #45475a;
    }

    .code-dots {
      display: flex;
      gap: 6px;
    }

    .code-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .code-dot.red { background: #f38ba8; }
    .code-dot.yellow { background: #f9e2af; }
    .code-dot.green { background: #a6e3a1; }

    .code-title {
      color: #cdd6f4;
      font-size: 0.85rem;
      font-weight: 600;
      margin-left: auto;
      font-family: 'Cascadia Code', Consolas, monospace;
    }

    .code-content {
      display: flex;
      background: #1e1e2e;
    }

    .line-numbers {
      background: #181825;
      color: #6c7086;
      padding: 12px 10px;
      text-align: right;
      font-family: 'Cascadia Code', Consolas, monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      user-select: none;
      border-right: 1px solid #313244;
    }

    .code-block pre {
      background: transparent;
      margin: 0;
      padding: 12px 16px;
      flex: 1;
      overflow-x: auto;
    }

    .code-block pre code {
      color: #cdd6f4;
      font-size: 0.95rem;
      line-height: 1.5;
      display: block;
    }

    /* Syntax highlighting mejorado - Catppuccin Mocha theme */
    .code-block .token-keyword { color: #cba6f7; font-weight: 600; } /* purple */
    .code-block .token-type { color: #f9e2af; } /* yellow */
    .code-block .token-string { color: #a6e3a1; } /* green */
    .code-block .token-comment { color: #6c7086; font-style: italic; } /* gray */
    .code-block .token-number { color: #fab387; } /* peach */
    .code-block .token-operator { color: #89dceb; } /* cyan */
    .code-block .token-method { color: #89b4fa; } /* blue */
    .code-block .token-class { color: #f9e2af; font-weight: 600; }
    .code-block .token-property { color: #b4befe; } /* lavender */
    .code-block .token-namespace { color: #f38ba8; } /* pink */

    /* C√≥digo inline */
    p code, li code {
      background: #313244;
      color: #cdd6f4;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 0.9em;
      border: 1px solid #45475a;
    }

    /* Tablas de c√≥digo */
    .code-comparison {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      margin: 16px 0;
    }

    .code-comparison .code-block {
      margin: 0;
    }

    .code-label {
      font-size: 0.8rem;
      color: #6c7086;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    </style>
</head>
<body>
  <a href="#main" class="skip-link">Saltar al contenido</a>
  <header>
    <div class="wrap">
      <div>IF0100 - Lenguaje de Programaci√≥n OO II | Unidad 4</div>
      <h1>Clase 13: CRUD con ADO.NET y SQL Server</h1>
      <div>Duraci√≥n: 90 minutos</div>
      <div class="meta">
        <div>
          <strong>Objetivos</strong>
          <ul>
            <li>Implementar CRUD completo con ADO.NET.</li>
            <li>Modelar base de datos y entidad C#.</li>
            <li>Aplicar validaciones y par√°metros seguros.</li>
            <li>Implementar paginaci√≥n y operaciones masivas.</li>
            <li>Escribir consultas avanzadas con SQL.</li>
          </ul>
        </div>
        <div>
          <strong>Prerrequisitos</strong>
          <ul>
            <li>Conocer SqlConnection, SqlCommand, SqlDataReader.</li>
            <li>SQL Server instalado o acceso a instancia.</li>
            <li>Conceptos b√°sicos de POO y capas.</li>
          </ul>
        </div>
      </div>
    </div>
  </header>

  <nav>
    <ul>
      <li><a href="#teor√≠a">Teor√≠a</a></li>
      <li><a href="#ejemplos">Ejemplos</a></li>
      <li><a href="#practica">Pr√°ctica / Laboratorio</a></li>
      <li><a href="#ejercicios">Ejercicios</a></li>
      <li><a href="#referencias">Referencias</a></li>
    </ul>
  </nav>

  <main id="main">
    <section id="teor√≠a">
      <h2>Teor√≠a</h2>

      <h3>Arquitectura por capas</h3>
      <p><strong>Arquitectura por capas</strong> = Separar el c√≥digo en niveles con responsabilidades distintas. Cada capa solo interact√∫a con la capa inmediatamente inferior/superior.</p>
      <div class="note">
        <strong>¬øPor qu√© arquitectura por capas?</strong>
        <ul>
          <li><strong>Mantenibilidad:</strong> Cambios en UI no afectan l√≥gica de datos</li>
          <li><strong>Reutilizaci√≥n:</strong> La l√≥gica de negocio puede usarse desde Console, Web o API</li>
          <li><strong>Testing:</strong> Cada capa se puede probar independientemente</li>
        </ul>
      </div>
      <pre><code>Presentaci√≥n (Console/WinForms)
   ‚Üì
L√≥gica de negocio (validaciones)
   ‚Üì
Acceso a datos (ADO.NET)
   ‚Üì
SQL Server (tabla Estudiantes)</code></pre>

      <h3>Modelo de base de datos</h3>
      <p><strong><abbr title="IDENTITY(1,1) - Columna auto-incremental que empieza en 1 y aumenta de 1 en 1">IDENTITY(1,1)</abbr></strong> = Configuraci√≥n para que SQL Server genere autom√°ticamente valores √∫nicos consecutivos.</p>
      <p><strong><abbr title="NVARCHAR - Tipo de dato SQL para texto Unicode (admite caracteres especiales)">NVARCHAR</abbr></strong> = Tipo de dato para texto en SQL Server que soporta caracteres Unicode (emojis, acentos, caracteres internacionales).</p>
      <p><strong><abbr title="UNIQUE - Restricci√≥n que impide valores duplicados en una columna">UNIQUE</abbr></strong> = Restricci√≥n que garantiza que no haya valores duplicados en una columna (ej: dos estudiantes con mismo c√≥digo).</p>
      <p><strong><abbr title="CHECK - Restricci√≥n que valida que un valor cumpla una condici√≥n">CHECK constraint</abbr></strong> = Regla de validaci√≥n a nivel base de datos (ej: promedio debe estar entre 0 y 5).</p>
      <p><strong><abbr title="BIT - Tipo de dato SQL para valores booleanos (0 o 1)">BIT</abbr></strong> = Tipo de dato booleano en SQL Server (0 = false, 1 = true).</p>
      <p><strong><abbr title="GETDATE() - Funci√≥n de SQL Server que retorna la fecha y hora actual">GETDATE()</abbr></strong> = Funci√≥n que retorna la fecha y hora actual del servidor.</p>
      <pre><code class="language-sql">CREATE TABLE Estudiantes (
  Id INT PRIMARY KEY IDENTITY(1,1),
  Codigo NVARCHAR(20) NOT NULL UNIQUE,
  Nombre NVARCHAR(100) NOT NULL,
  Apellido NVARCHAR(100) NOT NULL,
  Email NVARCHAR(100) NOT NULL,
  FechaNacimiento DATE,
  Promedio DECIMAL(3,2) CHECK (Promedio BETWEEN 0 AND 5),
  Activo BIT DEFAULT 1,
  FechaCreaci√≥n DATETIME DEFAULT GETDATE()
);</code></pre>

      <h3>Entidad C#</h3>
      <p><strong>Property expression (=>)</strong> = Sintaxis de C# para definir propiedades calculadas (read-only) que derivan su valor de otras propiedades.</p>
      <pre><code class="language-csharp">public class Estudiante
{
    public int Id { get; set; }
    public string Codigo { get; set; }
    public string Nombre { get; set; }
    public string Apellido { get; set; }
    public string Email { get; set; }
    public DateTime FechaNacimiento { get; set; }
    public decimal Promedio { get; set; }
    public bool Activo { get; set; }
    public DateTime FechaCreaci√≥n { get; set; }

    public string NombreCompleto => $"{Nombre} {Apellido}";
    public int Edad => DateTime.Now.Year - FechaNacimiento.Year;
}</code></pre>

      <h3>Seguridad b√°sica</h3>
      <ul>
        <li>Usar par√°metros SQL para evitar inyecci√≥n.</li>
        <li>Manejar excepciones de clave unica (codigo duplicado).</li>
        <li>Validar datos antes de persistir.</li>
      </ul>
    </section>

    <section id="ejemplos">
      <h2>Ejemplos</h2>

      <h3>CREATE con ADO.NET</h3>
      <pre><code class="language-csharp">public int Crear(Estudiante estudiante)
{
    const string query = @"
        INSERT INTO Estudiantes (Codigo, Nombre, Apellido, Email,
                               FechaNacimiento, Promedio, Activo)
        VALUES (@Codigo, @Nombre, @Apellido, @Email,
               @FechaNacimiento, @Promedio, @Activo);
        SELECT CAST(SCOPE_IDENTITY() AS INT);";

    using var conexi√≥n = new SqlConnection(_connectionString);
    using var comando = new SqlCommand(query, conexi√≥n);
    comando.Parameters.AddWithValue("@Codigo", estudiante.Codigo);
    comando.Parameters.AddWithValue("@Nombre", estudiante.Nombre);
    comando.Parameters.AddWithValue("@Apellido", estudiante.Apellido);
    comando.Parameters.AddWithValue("@Email", estudiante.Email);
    comando.Parameters.AddWithValue("@FechaNacimiento", estudiante.FechaNacimiento);
    comando.Parameters.AddWithValue("@Promedio", estudiante.Promedio);
    comando.Parameters.AddWithValue("@Activo", estudiante.Activo);

    conexi√≥n.Open();
    return (int)comando.ExecuteScalar();
}</code></pre>

      <h3>READ (lista)</h3>
      <pre><code class="language-csharp">public List&lt;Estudiante&gt; ObtenerTodos()
{
    const string query = @"
        SELECT Id, Codigo, Nombre, Apellido, Email,
               FechaNacimiento, Promedio, Activo, FechaCreaci√≥n
        FROM Estudiantes
        WHERE Activo = 1
        ORDER BY Apellido, Nombre";

    var estudiantes = new List&lt;Estudiante&gt;();
    using var conexi√≥n = new SqlConnection(_connectionString);
    using var comando = new SqlCommand(query, conexi√≥n);
    conexi√≥n.Open();
    using var reader = comando.ExecuteReader();
    while (reader.Read()) estudiantes.Add(MapearEstudiante(reader));
    return estudiantes;
}</code></pre>

      <h3>UPDATE y DELETE logico</h3>
      <p><strong>DELETE l√≥gico</strong> = Marcar un registro como inactivo (Activo = 0) en lugar de eliminarlo f√≠sicamente. Permite recuperar datos y mantiene auditor√≠a.</p>
      <div class="note">
        <strong>¬øPor qu√© DELETE l√≥gico?</strong>
        <ul>
          <li><strong>Auditor√≠a:</strong> Mantener historial de todos los registros</li>
          <li><strong>Recuperaci√≥n:</strong> Pod√©s "reactivar" un registro eliminado por error</li>
          <li><strong>Integridad:</strong> No rompe relaciones con otras tablas ( FOREIGN KEY )</li>
        </ul>
      </div>
      <pre><code class="language-csharp">public bool Actualizar(Estudiante estudiante)
{
    const string query = @"
        UPDATE Estudiantes
        SET Nombre = @Nombre, Apellido = @Apellido, Email = @Email,
            FechaNacimiento = @FechaNacimiento, Promedio = @Promedio, Activo = @Activo
        WHERE Id = @Id";

    using var conexi√≥n = new SqlConnection(_connectionString);
    using var comando = new SqlCommand(query, conexi√≥n);
    comando.Parameters.AddWithValue("@Id", estudiante.Id);
    comando.Parameters.AddWithValue("@Nombre", estudiante.Nombre);
    comando.Parameters.AddWithValue("@Apellido", estudiante.Apellido);
    comando.Parameters.AddWithValue("@Email", estudiante.Email);
    comando.Parameters.AddWithValue("@FechaNacimiento", estudiante.FechaNacimiento);
    comando.Parameters.AddWithValue("@Promedio", estudiante.Promedio);
    comando.Parameters.AddWithValue("@Activo", estudiante.Activo);

    conexi√≥n.Open();
    return comando.ExecuteNonQuery() > 0;
}

public bool EliminarLogico(int id)
{
    const string query = "UPDATE Estudiantes SET Activo = 0 WHERE Id = @Id";
    using var conexi√≥n = new SqlConnection(_connectionString);
    using var comando = new SqlCommand(query, conexi√≥n);
    comando.Parameters.AddWithValue("@Id", id);
    conexi√≥n.Open();
    return comando.ExecuteNonQuery() > 0;
}</code></pre>
    </section>

    <section class="evaluacion-calificable">
      <h3>üìã Evaluaci√≥n programada</h3>
      <p><strong>Detalle:</strong> Consultar plataforma del curso para informaci√≥n completa sobre evaluaci√≥n calificable.</p>
    </section>

    <section id="practica">
      <h2>Pr√°ctica / Laboratorio</h2>

      <h3>Menu en consola</h3>
      <pre><code class="language-csharp">while (true)
{
    Console.WriteLine("1. Crear");
    Console.WriteLine("2. Listar");
    Console.WriteLine("3. Buscar por ID");
    Console.WriteLine("4. Actualizar");
    Console.WriteLine("5. Eliminar");
    Console.WriteLine("6. Salir");
    var opcion = Console.ReadLine();
    // switch con llamadas a m√©todos CRUD
}</code></pre>

      <h3>Paginaci√≥n OFFSET/FETCH</h3>
      <p><strong>Paginaci√≥n</strong> = Dividir un conjunto de resultados grandes en p√°ginas m√°s peque√±as (ej: 20 registros por p√°gina) para mejorar rendimiento y UX.</p>
      <p><strong><abbr title="OFFSET/FETCH - Cl√°usulas de SQL Server para saltar registros y tomar un n√∫mero limitado de filas (paginaci√≥n)">OFFSET/FETCH</abbr></strong> = OFFSET salta N registros, FETCH NEXT toma M registros a partir de ah√≠.</p>
      <pre><code class="language-sql">SELECT Id, Codigo, Nombre, Apellido, Promedio
FROM Estudiantes
WHERE Activo = 1
ORDER BY Apellido, Nombre
OFFSET @Offset ROWS
FETCH NEXT @PageSize ROWS ONLY;</code></pre>

      <h3>Bulk insert (SqlBulkCopy)</h3>
      <p><strong><abbr title="SqlBulkCopy - Clase de ADO.NET para inserci√≥n masiva de datos (miles de filas en segundos)">SqlBulkCopy</abbr></strong> = Clase especializada para insertar grandes cantidades de datos muy r√°pido. Es mucho m√°s eficiente que INSERT individual.</p>
      <div class="note">
        <strong>¬øPor qu√© SqlBulkCopy?</strong>
        <ul>
          <li><strong>Rendimiento:</strong> Puede insertar 100,000 filas en segundos</li>
          <li><strong>Importaci√≥n:</strong> Ideal para importar datos de Excel, CSV, etc.</li>
          <li><strong>M√≠nimo overhead:</strong> No crea logs detallados como INSERT normal</li>
        </ul>
      </div>
      <pre><code class="language-csharp">using var bulkCopy = new SqlBulkCopy(connection);
bulkCopy.DestinationTableName = "Estudiantes";
bulkCopy.ColumnMappings.Add("Codigo", "Codigo");
// ...
await bulkCopy.WriteToServerAsync(dataTable);</code></pre>

      <h3>Validaci√≥n previa</h3>
      <ul>
        <li>Codigo obligatorio y con prefijo.</li>
        <li>Nombre y apellido con longitud v√°lida.</li>
        <li>Email en formato correcto.</li>
        <li>Promedio entre 0 y 5.</li>
      </ul>
    </section>

    <section id="ejercicios">
      <h2>Ejercicios</h2>

      <h3>B√∫squeda por nombre</h3>
      <p><strong><abbr title="LIKE - Operador de SQL para b√∫squeda de patrones en texto (con comodines %)">LIKE</abbr></strong> = Operador de SQL para b√∫squeda parcial. % representa cualquier secuencia de caracteres (comod√≠n).</p>
      <p>Ejemplo: <code>WHERE Nombre LIKE '%Mar%'</code> encuentra "Mar√≠a", "Mar", "Amargo", etc.</p>
      <p>Implementar <code>BuscarPorNombre(string t√©rmino)</code> con LIKE en nombre y apellido.</p>

      <div class="note">
        <strong>Mini-Chequeo: CRUD Completo</strong>
        <ul>
          <li>¬øPor qu√© usar DELETE l√≥gico en lugar de DELETE f√≠sico?</li>
          <li>¬øCu√°ndo usar√≠as SqlBulkCopy vs INSERT normal?</li>
          <li>¬øC√≥mo funciona la paginaci√≥n con OFFSET/FETCH?</li>
        </ul>
      </div>

      <h3>Paginaci√≥n</h3>
      <p>Modificar <code>ObtenerTodos</code> para aceptar pagina y tama√±o y retornar resultado paginado.</p>

      <h3>Transacciones</h3>
      <p>Crear un m√©todo que actualice m√∫ltiples promedios en una sola transacci√≥n.</p>

      <h3>Checklist de errores comunes</h3>
      <ul>
        <li>Concatenar strings en SQL (inyecci√≥n).</li>
        <li>No cerrar conexi√≥nes o readers.</li>
        <li>No manejar claves duplicadas.</li>
        <li>Usar tipos incorrectos en par√°metros.</li>
      </ul>
    </section>

    <section id="referencias">
      <h2>Referencias</h2>
      <ul>
        <li>ADO.NET SqlConnection / SqlCommand.</li>
        <li>SQL Server OFFSET/FETCH y transacci√≥nes.</li>
        <li>SqlBulkCopy y operaciones masivas.</li>
      </ul>
    </section>
  </main>

  <footer style="background:#1e293b;color:#fff;text-align:center;padding:24px;margin-top:40px;">
    <p><strong>IF0100 - Lenguaje de Programaci√≥n OO II</strong></p>
    <p>UNAULA - Ingenier√≠a Inform√°tica - 2026-I</p>
  </footer>
</body>
</html>
